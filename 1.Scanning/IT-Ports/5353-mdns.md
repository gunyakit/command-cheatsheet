# Port 5353 - mDNS (Multicast DNS) / DNS-SD

## Table of Contents

- [Enumeration](#enumeration)
- [Exploitation](#exploitation)
- [Spoofing Attacks](#spoofing-attacks)

---

## Enumeration

### Quick Check (One-liner)

```shell
avahi-browse -a -r 2>/dev/null || dns-sd -B _services._dns-sd._udp
```

### Nmap Scripts

```shell
nmap -sU -sV -p5353 $rhost
nmap -sU -p5353 --script "dns-service-discovery" $rhost
```

### avahi-browse (Linux)

```shell
# Install
apt install avahi-utils

# Browse all services
avahi-browse -a

# Browse all services with details
avahi-browse -a -r

# Browse specific service type
avahi-browse _http._tcp
avahi-browse _ssh._tcp
avahi-browse _smb._tcp
avahi-browse _printer._tcp
```

### dns-sd (macOS)

```shell
# Browse all services
dns-sd -B _services._dns-sd._udp

# Browse specific service
dns-sd -B _http._tcp
dns-sd -B _ssh._tcp

# Lookup service details
dns-sd -L "ServiceName" _http._tcp

# Query hostname
dns-sd -G v4 hostname.local
```

### Using dig

```shell
# Query mDNS
dig @224.0.0.251 -p 5353 hostname.local

# PTR record for services
dig @224.0.0.251 -p 5353 _http._tcp.local PTR
```

---

## Exploitation

### Service Discovery

```shell
# Common service types
_http._tcp      # Web servers
_https._tcp     # HTTPS servers
_ssh._tcp       # SSH servers
_smb._tcp       # SMB/CIFS shares
_afpovertcp._tcp # AFP (Apple Filing Protocol)
_printer._tcp   # Printers
_ipp._tcp       # Internet Printing Protocol
_airplay._tcp   # AirPlay
_raop._tcp      # Remote Audio Output Protocol
_workstation._tcp # Workstations
_homekit._tcp   # HomeKit devices
_googlecast._tcp # Chromecast
_spotify-connect._tcp # Spotify
```

### Network Reconnaissance

```shell
# Find all devices
avahi-browse -a -t -r 2>/dev/null | grep "=" | cut -d' ' -f4-

# Find SSH servers
avahi-browse _ssh._tcp -r -t

# Find HTTP servers
avahi-browse _http._tcp -r -t

# Find printers
avahi-browse _printer._tcp -r -t
avahi-browse _ipp._tcp -r -t
```

### Resolve .local Hostnames

```shell
# Using avahi-resolve
avahi-resolve -n hostname.local

# Using getent
getent hosts hostname.local

# Using ping
ping hostname.local
```

---

## Spoofing Attacks

### mDNS Poisoning

> Respond to mDNS queries with malicious records

```shell
# Using Responder
responder -I eth0 -wrf

# Using pholern's mdns-exploit
# https://github.com/pholern/mdns-exploit
```

### avahi-publish (Announce Fake Services)

```shell
# Publish fake HTTP service
avahi-publish-service "Evil HTTP Server" _http._tcp 80 "path=/"

# Publish fake SSH
avahi-publish-service "Fake SSH" _ssh._tcp 22

# Publish fake printer
avahi-publish-service "Fake Printer" _ipp._tcp 631 "txtvers=1" "pdl=application/pdf"

# Publish with IP address
avahi-publish-address evilhost.local $lhost
```

### Wide Area mDNS

```shell
# If Wide Area mDNS is enabled
# Can potentially poison records across networks
```

---

## Information Gathering

### Extract Device Information

```shell
# mDNS TXT records often contain device info
avahi-browse -a -r -t | grep -A5 "txt ="

# Common info in TXT records:
# - Model names
# - Firmware versions
# - Serial numbers
# - MAC addresses
```

### Find IoT Devices

```shell
# Smart home devices
avahi-browse _hap._tcp -r  # HomeKit
avahi-browse _matter._tcp -r  # Matter protocol
avahi-browse _googlecast._tcp -r  # Google Cast

# Media devices
avahi-browse _airplay._tcp -r
avahi-browse _raop._tcp -r
```

---

## Tools

- avahi-utils: `apt install avahi-utils`
- Responder: https://github.com/lgandx/Responder
- Bonjour Browser (Windows): https://hobbyistsoftware.com/bonjourbrowser
- Discovery (macOS): App Store

---

## References

- [HackTricks - mDNS](https://book.hacktricks.wiki/network-services-pentesting/5353-udp-multicast-dns-mdns.html)
- [RFC 6762 - Multicast DNS](https://tools.ietf.org/html/rfc6762)
