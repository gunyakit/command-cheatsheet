# Port 143, 993 - IMAP

## Table of Contents

- [Enumeration](#enumeration)
- [Authentication](#authentication)
- [Mail Enumeration](#mail-enumeration)
- [Exploitation](#exploitation)

---

## Enumeration

### Nmap

```shell
nmap -sV -sC -p 143,993 $rhost
nmap -p 143 --script imap-capabilities $rhost
nmap -p 143 --script imap-ntlm-info $rhost
```

### Banner Grabbing

```shell
# Netcat
nc -nv $rhost 143

# OpenSSL (IMAPS)
openssl s_client -connect $rhost:993

# STARTTLS
openssl s_client -connect $rhost:143 -starttls imap
```

---

## Authentication

### Manual Login

```shell
# Connect
nc -nv $rhost 143

# Login
A1 LOGIN username password
A2 LIST "" "*"
A3 SELECT INBOX
A4 LOGOUT
```

### IMAPS (SSL)

```shell
openssl s_client -connect $rhost:993
A1 LOGIN username password
A2 LIST "" "*"
```

### Brute Force

```shell
# Hydra
hydra -l user -P /usr/share/wordlists/rockyou.txt imap://$rhost
hydra -l user -P /usr/share/wordlists/rockyou.txt imaps://$rhost

# Nmap
nmap -p 143 --script imap-brute $rhost
```

---

## Mail Enumeration

### List Mailboxes

```text
A1 LOGIN user password
A2 LIST "" "*"
A3 LIST "" "%"
```

### Select and Read Mails

```text
# Select mailbox
A1 SELECT INBOX
A2 SELECT "Sent Items"

# Get mail count
A3 STATUS INBOX (MESSAGES)

# Fetch mail headers
A4 FETCH 1:* (FLAGS BODY[HEADER])

# Fetch full mail
A5 FETCH 1 BODY[]
A6 FETCH 1 RFC822
```

### Search Mails

```text
# Search all
A1 SEARCH ALL

# Search by subject
A2 SEARCH SUBJECT "password"

# Search by sender
A3 SEARCH FROM "admin"

# Search by date
A4 SEARCH SINCE "01-Jan-2024"
```

---

## Exploitation

### Curl Commands

```shell
# List mailboxes
curl -k "imaps://$rhost" --user "user:password"

# List inbox
curl -k "imaps://$rhost/INBOX" --user "user:password"

# Fetch email
curl -k "imaps://$rhost/INBOX;UID=1" --user "user:password"
```

### Extract Sensitive Information

```shell
# Connect and search for passwords
A1 LOGIN user password
A2 SELECT INBOX
A3 SEARCH BODY "password"
A4 FETCH 5 BODY[]
```

### NTLM Information Leak

```shell
nmap -p 143 --script imap-ntlm-info $rhost
```

---

## Quick Reference

| Command | Description |
| :--- | :--- |
| `A1 LOGIN user pass` | Authenticate |
| `A2 LIST "" "*"` | List all mailboxes |
| `A3 SELECT INBOX` | Select mailbox |
| `A4 FETCH 1 BODY[]` | Fetch email content |
| `A5 SEARCH SUBJECT "pass"` | Search emails |
| `A6 LOGOUT` | Disconnect |

| Port | Service | Description |
| :--- | :--- | :--- |
| 143 | IMAP | Unencrypted |
| 993 | IMAPS | SSL/TLS |
